# Собеседование по брокерам сообщений: Apache Kafka и RabbitMQ

## Базовые вопросы

### 1. Объясните основные отличия между Apache Kafka и RabbitMQ

**Подсказка 1:** Подумайте об архитектурных паттернах (pull vs push)

**Подсказка 2:** Рассмотрите модель хранения сообщений

**Подсказка 3:** Сравните производительность и масштабируемость

**Углубление:**
- Как различия в архитектуре влияют на выбор между Kafka и RabbitMQ для конкретного проекта?
  - *Подсказка:* Рассмотрите случаи real-time обработки vs task queue
- Почему Kafka хранит сообщения после потребления, а RabbitMQ удаляет?
  - *Подсказка:* Event sourcing и replay возможности

### 2. Что такое топик в Kafka и очередь в RabbitMQ?

**Подсказка 1:** Kafka топик - это категория для группировки сообщений

**Подсказка 2:** RabbitMQ очередь - это буфер FIFO для сообщений

**Подсказка 3:** Рассмотрите multi-subscriber модель

**Углубление:**
- Как партиции в Kafka топиках обеспечивают параллелизм?
  - *Подсказка:* Каждая партиция может обрабатываться отдельным consumer
- Что такое durable queue в RabbitMQ и зачем она нужна?
  - *Подсказка:* Сохранение сообщений при перезапуске брокера

### 3. Объясните модель Producer-Consumer в обоих брокерах

**Подсказка 1:** В Kafka consumer сам забирает сообщения (pull)

**Подсказка 2:** В RabbitMQ брокер отправляет сообщения consumer (push)

**Подсказка 3:** Рассмотрите consumer groups в Kafka

**Углубление:**
- Как работает prefetch в RabbitMQ и зачем он нужен?
  - *Подсказка:* Контроль нагрузки на consumer
- Что такое consumer lag в Kafka и как его мониторить?
  - *Подсказка:* Разница между последним offset и consumer offset

## Архитектура и внутреннее устройство

### 4. Опишите архитектуру кластера Kafka

**Подсказка 1:** Brokers, ZooKeeper/KRaft, Topics, Partitions

**Подсказка 2:** Leader-Follower репликация для партиций

**Подсказка 3:** Controller broker и его роль

**Углубление:**
- Как работает выбор лидера партиции при падении брокера?
  - *Подсказка:* In-Sync Replicas (ISR) и min.insync.replicas
- Что такое KRaft и почему Kafka отказывается от ZooKeeper?
  - *Подсказка:* Упрощение архитектуры и метаданные в самой Kafka

### 5. Как устроен кластер RabbitMQ?

**Подсказка 1:** Erlang distribution для коммуникации между нодами

**Подсказка 2:** Mnesia для синхронизации метаданных

**Подсказка 3:** Classic mirrored queues vs Quorum queues

**Углубление:**
- Чем Quorum Queues лучше Classic Mirrored Queues?
  - *Подсказка:* Raft консенсус, предсказуемость, производительность
- Как работает federation в RabbitMQ?
  - *Подсказка:* Связь между географически распределенными кластерами

### 6. Как Kafka хранит данные на диске?

**Подсказка 1:** Сегменты логов (.log файлы)

**Подсказка 2:** Индексные файлы для быстрого поиска по offset

**Подсказка 3:** Log compaction для key-based retention

**Углубление:**
- Что такое log rolling и какие параметры его контролируют?
  - *Подсказка:* log.segment.bytes и log.roll.ms
- Как работает Tiered Storage в современных версиях Kafka?
  - *Подсказка:* Холодные данные в объектном хранилище

## Производительность и оптимизация

### 7. Какие факторы влияют на производительность Kafka?

**Подсказка 1:** Batch size и linger.ms на producer

**Подсказка 2:** Количество партиций и репликация

**Подсказка 3:** Page cache и sequential I/O

**Углубление:**
- Как настроить producer для максимальной пропускной способности?
  - *Подсказка:* batch.size, linger.ms, compression.type
- Что такое zero-copy и как Kafka его использует?
  - *Подсказка:* sendfile() системный вызов

### 8. Как оптимизировать производительность RabbitMQ?

**Подсказка 1:** Короткие очереди и lazy queues

**Подсказка 2:** Правильный prefetch count

**Подсказка 3:** HiPE компиляция (deprecated в 3.9+)

**Углубление:**
- Когда использовать lazy queues и какие у них недостатки?
  - *Подсказка:* Стабильность vs latency
- Как connection pooling влияет на производительность?
  - *Подсказка:* Каждое соединение ~100KB RAM

## Гарантии доставки и надежность

### 9. Какие гарантии доставки предоставляет Kafka?

**Подсказка 1:** At-most-once, at-least-once, exactly-once

**Подсказка 2:** Параметр acks на producer

**Подсказка 3:** Idempotent producer и транзакции

**Углубление:**
- Как работает exactly-once семантика в Kafka?
  - *Подсказка:* Транзакции, idempotent producer, transactional.id
- Что такое ISR и как он влияет на durability?
  - *Подсказка:* min.insync.replicas и acks=all

### 10. Какие механизмы надежности есть в RabbitMQ?

**Подсказка 1:** Publisher confirms

**Подсказка 2:** Message acknowledgments

**Подсказка 3:** Persistent messages и durable queues

**Углубление:**
- Как работают transactions в RabbitMQ и почему их редко используют?
  - *Подсказка:* Производительность vs publisher confirms
- Что такое Dead Letter Exchange и когда его использовать?
  - *Подсказка:* Обработка недоставленных сообщений

## Масштабирование и высокая доступность

### 11. Как масштабировать Kafka горизонтально?

**Подсказка 1:** Добавление брокеров в кластер

**Подсказка 2:** Увеличение количества партиций

**Подсказка 3:** Partition reassignment

**Углубление:**
- Как работает partition rebalancing при добавлении consumer?
  - *Подсказка:* Consumer group coordinator и rebalance protocol
- Какие ограничения у Kafka по количеству партиций?
  - *Подсказка:* Metadata overhead, file descriptors

### 12. Как обеспечить HA в RabbitMQ?

**Подсказка 1:** Clustering и queue mirroring

**Подсказка 2:** Quorum queues с Raft консенсусом

**Подсказка 3:** Load balancer перед кластером

**Углубление:**
- Почему не рекомендуется clustering через WAN?
  - *Подсказка:* Latency и network partitions
- Как работает automatic failover в RabbitMQ?
  - *Подсказка:* Monitoring health checks и переключение

## Паттерны использования

### 13. Когда выбрать Kafka вместо RabbitMQ?

**Подсказка 1:** Event streaming и log aggregation

**Подсказка 2:** Высокая пропускная способность

**Подсказка 3:** Event sourcing и replay

**Углубление:**
- Как реализовать CQRS паттерн с Kafka?
  - *Подсказка:* Event store и проекции
- Почему Kafka популярна для real-time analytics?
  - *Подсказка:* Kafka Streams и ksqlDB

### 14. Когда RabbitMQ предпочтительнее Kafka?

**Подсказка 1:** Complex routing с exchanges

**Подсказка 2:** Request-reply паттерн

**Подсказка 3:** Приоритетные очереди

**Углубление:**
- Как реализовать RPC через RabbitMQ?
  - *Подсказка:* Reply-to queue и correlation id
- Какие routing паттерны поддерживает RabbitMQ?
  - *Подсказка:* Direct, topic, fanout, headers exchanges

## Мониторинг и операции

### 15. Какие метрики важны для мониторинга Kafka?

**Подсказка 1:** Consumer lag и throughput

**Подсказка 2:** Under-replicated partitions

**Подсказка 3:** JVM метрики (heap, GC)

**Углубление:**
- Как использовать JMX для мониторинга Kafka?
  - *Подсказка:* MBeans и метрики брокера
- Что такое burrow и как он помогает в мониторинге?
  - *Подсказка:* Consumer lag evaluation

### 16. Как мониторить здоровье RabbitMQ кластера?

**Подсказка 1:** Management API и плагин

**Подсказка 2:** Queue depth и message rates

**Подсказка 3:** Memory и disk alarms

**Углубление:**
- Как работают memory и disk alarms в RabbitMQ?
  - *Подсказка:* vm_memory_high_watermark и disk_free_limit
- Какие Prometheus метрики экспортирует RabbitMQ?
  - *Подсказка:* rabbitmq_prometheus плагин

## Безопасность

### 17. Какие механизмы безопасности есть в Kafka?

**Подсказка 1:** SSL/TLS для шифрования

**Подсказка 2:** SASL для аутентификации

**Подсказка 3:** ACLs для авторизации

**Углубление:**
- Как настроить Kerberos аутентификацию в Kafka?
  - *Подсказка:* SASL/GSSAPI механизм
- Что такое Kafka quotas и зачем они нужны?
  - *Подсказка:* Rate limiting для producer/consumer

### 18. Как обеспечить безопасность в RabbitMQ?

**Подсказка 1:** Virtual hosts для изоляции

**Подсказка 2:** User permissions модель

**Подсказка 3:** TLS для транспорта

**Углубление:**
- Как работает RBAC в RabbitMQ?
  - *Подсказка:* Configure, write, read permissions
- Что такое shovel plugin и его security implications?
  - *Подсказка:* Перемещение данных между брокерами

## Продвинутые темы

### 19. Что такое Kafka Streams и как он работает?

**Подсказка 1:** Stream processing библиотека

**Подсказка 2:** State stores и windowing

**Подсказка 3:** Exactly-once processing

**Углубление:**
- Как Kafka Streams обеспечивает fault tolerance?
  - *Подсказка:* Changelog topics для state stores
- Чем Kafka Streams отличается от Spark Streaming?
  - *Подсказка:* Library vs framework, микро-батчи

### 20. Как работает Kafka Connect?

**Подсказка 1:** Source и Sink connectors

**Подсказка 2:** Distributed и standalone режимы

**Подсказка 3:** Schema Registry интеграция

**Углубление:**
- Как написать custom connector для Kafka Connect?
  - *Подсказка:* SourceConnector/SinkConnector API
- Что такое Single Message Transforms (SMT)?
  - *Подсказка:* Трансформация на лету

### 21. Что такое RabbitMQ Streams (3.9+)?

**Подсказка 1:** Append-only log как в Kafka

**Подсказка 2:** Высокая производительность для replay

**Подсказка 3:** Offset-based consumption

**Углубление:**
- Чем RabbitMQ Streams отличается от обычных queues?
  - *Подсказка:* Non-destructive consumer, replay
- Какие use cases покрывает RabbitMQ Streams?
  - *Подсказка:* Fan-out с большим количеством consumers

### 22. Как обрабатывать большие сообщения?

**Подсказка 1:** Kafka: max.message.bytes и компрессия

**Подсказка 2:** RabbitMQ: внешнее хранилище + ссылки

**Подсказка 3:** Chunk и reassemble паттерн

**Углубление:**
- Какие проблемы создают большие сообщения в Kafka?
  - *Подсказка:* Memory pressure, rebalancing time
- Как использовать claim check pattern с брокерами?
  - *Подсказка:* S3/blob storage для payload

## Операционные вопросы

### 23. Как выполнить rolling upgrade Kafka кластера?

**Подсказка 1:** Обновление по одному брокеру

**Подсказка 2:** Проверка ISR перед рестартом

**Подсказка 3:** Controlled shutdown

**Углубление:**
- Что такое inter.broker.protocol.version?
  - *Подсказка:* Совместимость между версиями
- Как откатить неудачное обновление?
  - *Подсказка:* Downgrade процедура

### 24. Как решать проблему "split brain" в RabbitMQ?

**Подсказка 1:** Network partitions и их обнаружение

**Подсказка 2:** Partition handling strategies

**Подсказка 3:** pause_minority режим

**Углубление:**
- Какие есть стратегии обработки network partitions?
  - *Подсказка:* ignore, pause_minority, pause_if_all_down
- Как восстановить кластер после split brain?
  - *Подсказка:* Force boot и data loss

### 25. Как диагностировать проблемы производительности?

**Подсказка 1:** Метрики и логи анализ

**Подсказка 2:** Thread dumps и heap dumps

**Подсказка 3:** Network и disk I/O проверка

**Углубление:**
- Какие JVM флаги помогают в отладке Kafka?
  - *Подсказка:* GC логи, heap dumps on OOM
- Как использовать rabbitmq-diagnostics?
  - *Подсказка:* observer, runtime_thread_stats

## Интеграция и экосистема

### 26. Как интегрировать Kafka с микросервисами?

**Подсказка 1:** Event-driven architecture

**Подсказка 2:** Saga pattern implementation

**Подсказка 3:** CDC (Change Data Capture)

**Углубление:**
- Как использовать Debezium с Kafka?
  - *Подсказка:* CDC из баз данных
- Что такое Outbox pattern и зачем он нужен?
  - *Подсказка:* Транзакционная гарантия

### 27. Какие протоколы поддерживает RabbitMQ?

**Подсказка 1:** AMQP 0-9-1 основной

**Подсказка 2:** STOMP, MQTT плагины

**Подсказка 3:** HTTP API для management

**Углубление:**
- Как использовать RabbitMQ с IoT устройствами?
  - *Подсказка:* MQTT plugin и QoS levels
- Что такое AMQP 1.0 и поддерживает ли его RabbitMQ?
  - *Подсказка:* Экспериментальный плагин

### 28. Как работать со Schema Registry в Kafka?

**Подсказка 1:** Версионирование схем

**Подсказка 2:** Avro, Protobuf, JSON Schema

**Подсказка 3:** Compatibility modes

**Углубление:**
- Какие режимы совместимости поддерживает Schema Registry?
  - *Подсказка:* BACKWARD, FORWARD, FULL, NONE
- Как обрабатывать schema evolution?
  - *Подсказка:* Default values, optional fields

## Сравнение с другими системами

### 29. Чем Kafka отличается от Pulsar?

**Подсказка 1:** Сегментное хранение в Pulsar

**Подсказка 2:** BookKeeper для storage layer

**Подсказка 3:** Multi-tenancy из коробки

**Углубление:**
- Какие преимущества дает разделение compute и storage?
  - *Подсказка:* Независимое масштабирование
- Что такое geo-replication в Pulsar?
  - *Подсказка:* Active-active репликация

### 30. Когда использовать Redis Streams вместо Kafka/RabbitMQ?

**Подсказка 1:** In-memory производительность

**Подсказка 2:** Простота для небольших объемов

**Подсказка 3:** Consumer groups поддержка

**Углубление:**
- Какие ограничения у Redis Streams?
  - *Подсказка:* Память, persistence, масштабирование
- Как Redis Streams обеспечивает durability?
  - *Подсказка:* AOF и RDB snapshots

## Практические сценарии

### 31. Как реализовать retry механизм?

**Подсказка 1:** Kafka: отдельные retry topics

**Подсказка 2:** RabbitMQ: TTL и DLX

**Подсказка 3:** Exponential backoff

**Углубление:**
- Как избежать poison messages?
  - *Подсказка:* Max retry count, dead letter
- Как реализовать delayed retry в Kafka?
  - *Подсказка:* Pause consumer или scheduled executor

### 32. Как обеспечить ordering гарантии?

**Подсказка 1:** Kafka: один partition для ordered messages

**Подсказка 2:** RabbitMQ: один consumer и prefetch=1

**Подсказка 3:** Message keys и routing

**Углубление:**
- Как сохранить ordering при масштабировании?
  - *Подсказка:* Consistent hashing, sticky partitions
- Что такое out-of-order delivery и как его обнаружить?
  - *Подсказка:* Sequence numbers, timestamps

### 33. Как мигрировать между брокерами?

**Подсказка 1:** Dual writes период

**Подсказка 2:** Consumer lag мониторинг

**Подсказка 3:** Постепенное переключение

**Углубление:**
- Как мигрировать с RabbitMQ на Kafka?
  - *Подсказка:* Shovel plugin, custom bridge
- Какие инструменты помогают в миграции?
  - *Подсказка:* MirrorMaker, custom connectors

## Troubleshooting

### 34. Что делать при высоком consumer lag в Kafka?

**Подсказка 1:** Проверить производительность consumer

**Подсказка 2:** Увеличить параллелизм

**Подсказка 3:** Оптимизировать batch processing

**Углубление:**
- Как auto-scaling consumers решает проблему?
  - *Подсказка:* HPA в Kubernetes, метрики lag
- Что такое back pressure и как его реализовать?
  - *Подсказка:* Pause/resume API

### 35. Как решить проблему memory alarm в RabbitMQ?

**Подсказка 1:** Проверить queue lengths

**Подсказка 2:** Enable lazy queues

**Подсказка 3:** Увеличить memory limit

**Углубление:**
- Как работает flow control в RabbitMQ?
  - *Подсказка:* Credit-based flow control
- Что такое paging и его влияние?
  - *Подсказка:* Disk I/O при нехватке памяти

## Современные тренды (2025)

### 36. Что такое KRaft mode в Kafka?

**Подсказка 1:** Удаление зависимости от ZooKeeper

**Подсказка 2:** Встроенный Raft консенсус

**Подсказка 3:** Упрощение операций

**Углубление:**
- Какие преимущества дает KRaft?
  - *Подсказка:* Быстрый старт, меньше компонентов
- Как мигрировать с ZooKeeper на KRaft?
  - *Подсказка:* Migration tool в Kafka 3.x

### 37. Какие новые фичи в RabbitMQ 3.13+?

**Подсказка 1:** Улучшенные Quorum Queues

**Подсказка 2:** Native MQTT 5.0

**Подсказка 3:** Khepri как замена Mnesia

**Углубление:**
- Что такое Khepri и зачем менять Mnesia?
  - *Подсказка:* Raft-based metadata store
- Какие улучшения в производительности?
  - *Подсказка:* Меньше latency, больше throughput

### 38. Как брокеры работают в облаке?

**Подсказка 1:** Managed services (MSK, Amazon MQ)

**Подсказка 2:** Kubernetes operators

**Подсказка 3:** Serverless варианты

**Углубление:**
- Какие особенности Kafka в Kubernetes?
  - *Подсказка:* StatefulSets, persistent volumes
- Что такое Confluent Cloud и его преимущества?
  - *Подсказка:* Полностью управляемая Kafka

## Архитектурные решения

### 39. Как построить Event Sourcing систему?

**Подсказка 1:** Kafka как event store

**Подсказка 2:** Compacted topics для snapshots

**Подсказка 3:** CQRS для read models

**Углубление:**
- Как обрабатывать event versioning?
  - *Подсказка:* Schema evolution strategies
- Как строить projections эффективно?
  - *Подсказка:* Kafka Streams, state stores

### 40. Как реализовать distributed transactions?

**Подсказка 1:** Saga pattern с компенсацией

**Подсказка 2:** Two-phase commit anti-pattern

**Подсказка 3:** Eventual consistency

**Углубление:**
- Как использовать Kafka transactions для саги?
  - *Подсказка:* Transactional producer/consumer
- Что такое choreography vs orchestration?
  - *Подсказка:* Децентрализованная vs централизованная координация