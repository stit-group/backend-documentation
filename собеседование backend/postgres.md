# PostgreSQL Interview Questions - 2025

## 1. Индексы и производительность

**Вопрос:** Объясните разницу между B-tree, Hash, GiST, GIN и BRIN индексами в PostgreSQL. Когда использовать каждый тип?

**Подсказки:**
- B-tree подходит для операций сравнения (<, <=, =, >=, >)
- Hash только для операций равенства (=)
- GIN оптимален для составных значений (массивы, jsonb, полнотекстовый поиск)
- GiST для геометрических данных и полнотекстового поиска
- BRIN для больших таблиц с естественной сортировкой

**Дополнительные вопросы:**
- Как проверить использование индекса в запросе?
- Что такое partial index и когда его применять?
- Объясните понятие index bloat и как с ним бороться?

---

## 2. Window Functions

**Вопрос:** Напишите запрос с использованием оконных функций для расчета скользящего среднего продаж за последние 3 месяца.

**Подсказки:**
- Используйте ROWS BETWEEN для определения окна
- AVG() OVER() для расчета среднего
- Сортировка по дате важна для корректного окна

**Дополнительные вопросы:**
- В чем разница между ROWS и RANGE в оконных функциях?
- Как работает PARTITION BY в оконных функциях?
- Можно ли использовать несколько оконных функций в одном запросе?

---

## 3. CTE и рекурсивные запросы

**Вопрос:** Создайте рекурсивный CTE для обхода иерархии сотрудников (сотрудник -> менеджер).

**Подсказки:**
- WITH RECURSIVE для рекурсивных CTE
- UNION ALL для объединения базового и рекурсивного случаев
- Условие остановки рекурсии обязательно

**Дополнительные вопросы:**
- Как избежать бесконечной рекурсии?
- В чем разница между материализованными и обычными CTE?
- Когда CTE предпочтительнее подзапросов?

---

## 4. JSONB операции

**Вопрос:** Как эффективно запросить данные из JSONB поля и создать для этого оптимальный индекс?

**Подсказки:**
- Операторы ->, ->>, #>, #>> для извлечения данных
- GIN индексы для JSONB
- jsonb_path_ops vs обычные GIN индексы

**Дополнительные вопросы:**
- Как обновить конкретное поле в JSONB?
- Что такое JSONB path expressions (SQL/JSON path)?
- Как сравнить производительность JSONB vs отдельных колонок?

---

## 5. Транзакции и изоляция

**Вопрос:** Объясните уровни изоляции транзакций в PostgreSQL и какие проблемы каждый решает.

**Подсказки:**
- Read Uncommitted, Read Committed, Repeatable Read, Serializable
- Dirty reads, non-repeatable reads, phantom reads
- PostgreSQL не поддерживает dirty reads

**Дополнительные вопросы:**
- Что такое serialization failure и как его обработать?
- Как работает MVCC в PostgreSQL?
- В каких случаях нужен SERIALIZABLE уровень?

---

## 6. Планировщик запросов

**Вопрос:** Как интерпретировать план выполнения запроса? Объясните основные операции.

**Подсказки:**
- EXPLAIN (ANALYZE, BUFFERS) для детального анализа
- Seq Scan, Index Scan, Bitmap Heap Scan
- Nested Loop, Hash Join, Merge Join

**Дополнительные вопросы:**
- Что означает cost в плане выполнения?
- Как принудительно изменить план запроса?
- Что такое query hints и поддерживает ли их PostgreSQL?

---

## 7. Партиционирование

**Вопрос:** Опишите стратегии партиционирования в PostgreSQL 15+. Когда использовать range, list, hash партиционирование?

**Подсказки:**
- PARTITION BY RANGE для временных рядов
- PARTITION BY LIST для категориальных данных
- PARTITION BY HASH для равномерного распределения
- Декларативное партиционирование vs наследование

**Дополнительные вопросы:**
- Как работает partition pruning?
- Можно ли создавать индексы на партиционированных таблицах?
- Что такое partition-wise joins?

---

## 8. Репликация и высокая доступность

**Вопрос:** Объясните разницу между streaming и logical репликацией в PostgreSQL.

**Подсказки:**
- Streaming репликация на уровне WAL
- Logical репликация на уровне изменений данных
- Синхронная vs асинхронная репликация

**Дополнительные вопросы:**
- Как настроить автоматический failover?
- Что такое replication slots?
- Можно ли реплицировать только часть данных?

---

## 9. Vacuum и автовакуум

**Вопрос:** Как работает VACUUM в PostgreSQL и зачем нужен ANALYZE?

**Подсказки:**
- VACUUM удаляет мертвые строки (dead tuples)
- ANALYZE обновляет статистику для планировщика
- Автовакуум автоматизирует процесс

**Дополнительные вопросы:**
- В чем разница между VACUUM и VACUUM FULL?
- Как настроить параметры автовакуума?
- Что такое table bloat и как его измерить?

---

## 10. Полнотекстовый поиск

**Вопрос:** Как реализовать полнотекстовый поиск в PostgreSQL с поддержкой ранжирования результатов?

**Подсказки:**
- tsvector и tsquery типы данных
- to_tsvector() и to_tsquery() функции
- ts_rank() для ранжирования результатов
- GIN индексы для tsvector

**Дополнительные вопросы:**
- Как создать собственный словарь для поиска?
- Что такое text search configurations?
- Как обрабатывать морфологию в поиске?

---

## 11. Агрегатные функции и GROUP BY

**Вопрос:** Объясните разницу между HAVING и WHERE. Напишите запрос с использованием GROUPING SETS.

**Подсказки:**
- WHERE фильтрует строки до группировки
- HAVING фильтрует группы после GROUP BY
- GROUPING SETS позволяет несколько группировок в одном запросе

**Дополнительные вопросы:**
- Что такое ROLLUP и CUBE в GROUP BY?
- Как создать собственную агрегатную функцию?
- В каком порядке выполняются операции в SELECT?

---

## 12. Constraint и ограничения

**Вопрос:** Какие типы ограничений поддерживает PostgreSQL и как они влияют на производительность?

**Подсказки:**
- NOT NULL, UNIQUE, PRIMARY KEY, FOREIGN KEY, CHECK
- Deferrable constraints
- Exclusion constraints

**Дополнительные вопросы:**
- Как создать составной уникальный индекс?
- Что такое partial unique constraints?
- Как работают exclusion constraints с GiST индексами?

---

## 13. Временные данные и часовые пояса

**Вопрос:** Как правильно работать с временными данными в PostgreSQL? Объясните разницу между TIMESTAMP и TIMESTAMPTZ.

**Подсказки:**
- TIMESTAMP без часового пояса
- TIMESTAMPTZ с часовым поясом
- AT TIME ZONE для конвертации
- Функции NOW(), CURRENT_TIMESTAMP

**Дополнительные вопросы:**
- Как выполнить группировку по периодам времени?
- Что такое время epoch в PostgreSQL?
- Как обрабатывать переход на летнее время?

---

## 14. Расширения PostgreSQL

**Вопрос:** Какие популярные расширения PostgreSQL вы знаете и для чего они используются?

**Подсказки:**
- PostGIS для геоданных
- pg_stat_statements для мониторинга
- uuid-ossp для UUID
- hstore для ключ-значение данных

**Дополнительные вопросы:**
- Как создать собственное расширение?
- Что такое shared_preload_libraries?
- Как управлять версиями расширений?

---

## 15. Безопасность и роли

**Вопрос:** Объясните систему ролей и привилегий в PostgreSQL.

**Подсказки:**
- Роли могут быть пользователями и группами
- GRANT/REVOKE для управления привилегиями
- Row Level Security (RLS)
- Policy для RLS

**Дополнительные вопросы:**
- Как реализовать принцип наименьших привилегий?
- Что такое SECURITY DEFINER функции?
- Как настроить SSL подключение?

---

## 16. Хранимые процедуры и функции

**Вопрос:** В чем разница между функциями и процедурами в PostgreSQL? Какие языки программирования поддерживаются?

**Подсказки:**
- Процедуры не возвращают значений
- Функции всегда возвращают значение
- PL/pgSQL, SQL, Python, Perl и др.
- VOLATILE, STABLE, IMMUTABLE для функций

**Дополнительные вопросы:**
- Как обрабатывать исключения в PL/pgSQL?
- Что такое trigger функции?
- Как дебажить PL/pgSQL код?

---

## 17. Подключения и пулинг

**Вопрос:** Как оптимизировать работу с подключениями к PostgreSQL в высоконагруженных приложениях?

**Подсказки:**
- Connection pooling (PgBouncer, pgpool-II)
- max_connections параметр
- Prepared statements
- Persistent connections

**Дополнительные вопросы:**
- В чем разница между session и transaction pooling?
- Как мониторить активные подключения?
- Что такое connection leak и как его избежать?

---

## 18. Мониторинг и диагностика

**Вопрос:** Какие системные представления и функции PostgreSQL используются для мониторинга производительности?

**Подсказки:**
- pg_stat_activity для активных запросов
- pg_stat_user_tables для статистики таблиц
- pg_locks для блокировок
- pg_stat_statements для анализа запросов

**Дополнительные вопросы:**
- Как найти медленные запросы?
- Что показывает pg_stat_bgwriter?
- Как диагностировать проблемы с блокировками?

---

## 19. Backup и восстановление

**Вопрос:** Опишите стратегии резервного копирования в PostgreSQL.

**Подсказки:**
- pg_dump/pg_restore для логических бэкапов
- pg_basebackup для физических бэкапов
- Point-in-Time Recovery (PITR)
- WAL архивирование

**Дополнительные вопросы:**
- Как выполнить backup без блокировки таблиц?
- Что такое incremental backup?
- Как автоматизировать процесс бэкапирования?

---

## 20. Производительность и оптимизация

**Вопрос:** Как диагностировать и устранить проблемы производительности в PostgreSQL?

**Подсказки:**
- EXPLAIN ANALYZE для анализа запросов
- pg_stat_statements для статистики
- Настройка shared_buffers, work_mem
- Анализ wait events

**Дополнительные вопросы:**
- Как настроить параметры конфигурации для OLTP vs OLAP?
- Что такое checkpoint и как его оптимизировать?
- Как влияет размер страницы на производительность?

---

## 21. Advanced SQL конструкции

**Вопрос:** Объясните использование LATERAL JOIN и приведите практический пример.

**Подсказки:**
- LATERAL позволяет ссылаться на колонки из левой части JOIN
- Полезно для корреляционных подзапросов
- Можно использовать с функциями

**Дополнительные вопросы:**
- В чем разница между LATERAL и обычным JOIN?
- Как LATERAL влияет на производительность?
- Можно ли использовать LATERAL с оконными функциями?

---

## 22. Типы данных и домены

**Вопрос:** Как создать собственный тип данных или домен в PostgreSQL?

**Подсказки:**
- CREATE TYPE для составных типов
- CREATE DOMAIN для ограниченных типов
- Enum типы
- Array типы

**Дополнительные вопросы:**
- Как создать тип данных с методами?
- Что такое range типы?
- Как работать с многомерными массивами?

---

## 23. Concurrency и блокировки

**Вопрос:** Объясните типы блокировок в PostgreSQL и как избежать deadlock'ов.

**Подсказки:**
- Row-level locks, table-level locks
- ACCESS SHARE, ROW SHARE, ROW EXCLUSIVE и др.
- NOWAIT и SKIP LOCKED опции
- Advisory locks

**Дополнительные вопросы:**
- Как мониторить блокировки в реальном времени?
- Что такое lock queue?
- Как работают advisory locks?

---

## 24. Foreign Data Wrappers (FDW)

**Вопрос:** Что такое Foreign Data Wrappers и как их использовать для интеграции с внешними системами?

**Подсказки:**
- postgres_fdw для других БД PostgreSQL
- file_fdw для CSV файлов
- CREATE FOREIGN TABLE
- IMPORT FOREIGN SCHEMA

**Дополнительные вопросы:**
- Как оптимизировать запросы через FDW?
- Можно ли писать данные через FDW?
- Какие ограничения у Foreign Tables?

---

## 25. Logical Decoding и Change Data Capture

**Вопрос:** Как использовать logical decoding для реализации Change Data Capture?

**Подсказки:**
- Logical replication slots
- pgoutput plugin
- CREATE PUBLICATION/SUBSCRIPTION
- WAL level = logical

**Дополнительные вопросы:**
- Как создать собственный logical decoding plugin?
- Что такое logical decoding context?
- Как обрабатывать schema changes в CDC?

---

## 26. PostgreSQL 15+ новые возможности

**Вопрос:** Какие новые возможности появились в PostgreSQL 15 и 16?

**Подсказки:**
- MERGE команда (PostgreSQL 15)
- Multi-range типы данных
- Улучшения в партиционировании
- Новые возможности в мониторинге

**Дополнительные вопросы:**
- Как использовать MERGE для upsert операций?
- Что изменилось в logical replication?
- Какие улучшения производительности появились?

---

## 27. Event Triggers

**Вопрос:** Как использовать event triggers для аудита DDL операций?

**Подсказки:**
- ddl_command_start, ddl_command_end события
- sql_drop для отслеживания удалений
- pg_event_trigger_* функции

**Дополнительные вопросы:**
- Какие события поддерживают event triggers?
- Как получить информацию о выполняемой команде?
- Можно ли отменить DDL операцию в event trigger?

---

## 28. Массовые операции и COPY

**Вопрос:** Как эффективно загружать большие объемы данных в PostgreSQL?

**Подсказки:**
- COPY FROM для массовой загрузки
- UNLOGGED таблицы для временных данных
- Отключение автовакуума и индексов при загрузке
- Параллельная загрузка

**Дополнительные вопросы:**
- Как обрабатывать ошибки при COPY?
- Что такое binary format в COPY?
- Как оптимизировать memory использование при загрузке?

---

## 29. Генерация тестовых данных

**Вопрос:** Как сгенерировать большой объем тестовых данных для нагрузочного тестирования?

**Подсказки:**
- generate_series() функция
- random() для случайных значений
- INSERT INTO ... SELECT для массовых вставок
- Использование CTE для сложных паттернов

**Дополнительные вопросы:**
- Как создать реалистичные распределения данных?
- Как сгенерировать связанные данные между таблицами?
- Какие расширения помогают в генерации тестовых данных?

---

## 30. Оптимизация конфигурации

**Вопрос:** Как правильно настроить основные параметры postgresql.conf для продакшена?

**Подсказки:**
- shared_buffers (~25% от RAM)
- work_mem зависит от количества соединений
- maintenance_work_mem для maintenance операций
- effective_cache_size для планировщика

**Дополнительные вопросы:**
- Как настроить checkpoint параметры?
- Что такое huge pages и когда их использовать?
- Как мониторить эффективность настроек?

---

# ПРАКТИЧЕСКИЕ ЗАДАЧИ SQL

## Задача 1: Аналитические запросы с оконными функциями

**Задание:** Есть таблица продаж `sales(id, product_id, user_id, amount, sale_date)`. Напишите запрос, который для каждой продажи покажет:
- Сумму продажи
- Накопительную сумму продаж по дням
- Ранг продажи по сумме среди всех продаж за тот же день
- Разность между текущей и предыдущей продажей по времени

**Подсказки:**
```sql
-- Используйте SUM() OVER(), RANK(), LAG()
-- ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW для накопительной суммы
-- PARTITION BY для группировки внутри окна
```

**Дополнительные вопросы:**
- Как изменить запрос для скользящего окна в 7 дней?
- Что будет, если добавить DISTINCT к оконной функции?
- Как получить процентиль продажи относительно всех продаж дня?

---

## Задача 2: Рекурсивные CTE для иерархий

**Задание:** Таблица сотрудников `employees(id, name, manager_id, salary, department)`. Напишите запрос для:
- Получения всех подчиненных определенного менеджера (включая подчиненных подчиненных)
- Расчета общей зарплаты всех подчиненных
- Определения уровня каждого сотрудника в иерархии

**Подсказки:**
```sql
-- WITH RECURSIVE для обхода дерева
-- UNION ALL для соединения базового и рекурсивного случаев
-- Счетчик уровня level + 1 в рекурсивной части
```

**Дополнительные вопросы:**
- Как изменить запрос для обхода снизу вверх (от сотрудника к топ-менеджеру)?
- Как предотвратить бесконечную рекурсию при циклических ссылках?
- Можно ли в одном запросе получить и путь до корня, и всех потомков?

---

## Задача 3: Сложная группировка и агрегация

**Задание:** Таблицы `orders(id, customer_id, order_date, total)` и `order_items(order_id, product_id, quantity, price)`. Найдите:
- Топ-10 клиентов по сумме заказов за последние 6 месяцев
- Для каждого клиента: количество заказов, среднюю сумму заказа, самый дорогой товар
- Клиентов, которые делали заказы каждый месяц в течение последних 3 месяцев

**Подсказки:**
```sql
-- JOIN между таблицами для получения полной информации
-- DATE_TRUNC для группировки по месяцам
-- HAVING COUNT(DISTINCT месяц) = 3 для постоянных клиентов
-- MAX() и различные агрегатные функции
```

**Дополнительные вопросы:**
- Как изменить запрос для нахождения клиентов с растущими тратами?
- Что если нужно исключить возвраты из расчетов?
- Как добавить сравнение с аналогичным периодом прошлого года?

---

## Задача 4: JSONB запросы и индексация

**Задание:** Таблица `products(id, name, attributes jsonb)` где attributes содержит характеристики товара. Напишите запросы для:
- Поиска товаров с определенными характеристиками (например, цвет = 'красный' И размер = 'L')
- Группировки товаров по категориям (хранится в attributes.category)
- Обновления цены товара в JSONB поле

**Подсказки:**
```sql
-- Операторы ->, ->>, @>, ? для работы с JSONB
-- jsonb_set() для обновления конкретных полей
-- jsonb_path_query для сложных запросов
-- CREATE INDEX USING GIN для оптимизации
```

**Дополнительные вопросы:**
- Как создать индекс только по определенному полю JSONB?
- В чем разница между @> и ? операторами?
- Как эффективно искать по вложенным массивам в JSONB?

---

## Задача 5: Временные ряды и интервалы

**Задание:** Таблица метрик `metrics(timestamp, metric_name, value)`. Создайте запросы для:
- Группировки данных по часам/дням/месяцам
- Заполнения пропусков в данных (если нет записи за час, показать 0)
- Расчета скользящего среднего за 24 часа для каждой метрики

**Подсказки:**
```sql
-- generate_series() для создания временных интервалов
-- DATE_TRUNC для группировки по времени
-- COALESCE для замены NULL на 0
-- LEFT JOIN с сгенерированными интервалами
```

**Дополнительные вопросы:**
- Как обработать разные часовые пояса?
- Что делать с дублирующимися записями в одном интервале?
- Как оптимизировать запросы по большим временным диапазонам?

---

## Задача 6: Pivot и unpivot операции

**Задание:** Таблица продаж по месяцам `monthly_sales(year, month, product, sales)`. Преобразуйте данные в:
- Pivot: строки - товары, колонки - месяцы, значения - продажи
- Unpivot: из широкой таблицы в длинную
- Сравнение продаж год к году для каждого товара

**Подсказки:**
```sql
-- CASE WHEN с GROUP BY для pivot
-- UNION ALL с VALUES для unpivot
-- LAG() OVER(PARTITION BY product ORDER BY year, month) для сравнения
```

**Дополнительные вопросы:**
- Как создать динамический pivot для неизвестного количества колонок?
- Можно ли использовать CROSSTAB функцию?
- Как обработать NULL значения в pivot таблице?

---

## Задача 7: Сложные соединения и подзапросы

**Задание:** База данных интернет-магазина с таблицами `users`, `orders`, `products`, `reviews`. Найдите:
- Пользователей, которые купили товар, но не оставили отзыв
- Товары, которые покупают вместе (market basket analysis)
- Пользователей с аномально большими заказами (выше 95 перцентиля)

**Подсказки:**
```sql
-- LEFT JOIN с WHERE IS NULL для поиска отсутствующих записей
-- SELF JOIN или оконные функции для анализа корзины
-- PERCENTILE_CONT() для расчета перцентилей
-- EXISTS/NOT EXISTS для сложных условий
```

**Дополнительные вопросы:**
- Как оптимизировать запрос для миллионов записей?
- В каких случаях EXISTS лучше, чем JOIN?
- Как реализовать рекомендательную систему на SQL?

---

## Задача 8: Работа с массивами и типами данных

**Задание:** Таблица `user_interests(user_id, interests text[], tags text[])`. Создайте запросы для:
- Поиска пользователей с пересекающимися интересами
- Подсчета популярности каждого интереса
- Рекомендации пользователей на основе схожих интересов

**Подсказки:**
```sql
-- && оператор для пересечения массивов
-- unnest() для разворачивания массивов
-- array_agg() для сборки массивов
-- GIN индексы для массивов
```

**Дополнительные вопросы:**
- Как эффективно обновлять элементы массива?
- В чем разница между array_agg() и string_agg()?
- Можно ли создать уникальный индекс на элементы массива?

---

## Задача 9: Статистические функции

**Задание:** Таблица результатов тестов `test_results(student_id, subject, score, test_date)`. Вычислите:
- Стандартное отклонение оценок по предметам
- Корреляцию между оценками по разным предметам
- Z-score для каждой оценки (насколько она отклоняется от среднего)

**Подсказки:**
```sql
-- STDDEV(), CORR() статистические функции
-- (score - AVG(score)) / STDDEV(score) для Z-score
-- WINDOW функции для группировки
```

**Дополнительные вопросы:**
- Как найти выбросы в данных?
- Можно ли вычислить медиану без PERCENTILE_CONT?
- Как сравнить распределения оценок между группами?

---

## Задача 10: Деревья и графы

**Задание:** Таблица связей `connections(user_from, user_to, connection_type)` представляет социальную сеть. Найдите:
- Взаимные подписки (A подписан на B И B подписан на A)
- Путь между двумя пользователями (кратчайший)
- Пользователей с наибольшим количеством подписчиков второго уровня

**Подсказки:**
```sql
-- SELF JOIN для поиска взаимных связей
-- Рекурсивные CTE для поиска путей
-- Ограничение глубины рекурсии для производительности
```

**Дополнительные вопросы:**
- Как найти циклы в графе?
- Можно ли найти все простые пути между узлами?
- Как реализовать алгоритм PageRank на SQL?

---

## Задача 11: Оптимизация и производительность

**Задание:** Запрос выполняется медленно. Проанализируйте и оптимизируйте:
```sql
SELECT u.name, COUNT(o.id), SUM(o.total)
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE u.created_at > '2023-01-01'
  AND (o.status = 'completed' OR o.status IS NULL)
GROUP BY u.id, u.name
HAVING COUNT(o.id) > 5
ORDER BY SUM(o.total) DESC;
```

**Подсказки:**
- Анализ плана выполнения EXPLAIN (ANALYZE, BUFFERS)
- Создание подходящих индексов
- Переписывание запроса для лучшей производительности

**Дополнительные вопросы:**
- Какие индексы нужны для оптимизации?
- Можно ли избежать сортировки большого результата?
- Как влияет размер work_mem на этот запрос?

---

## Задача 12: Обработка дубликатов

**Задание:** Таблица содержит дубликаты `customer_data(id, email, name, phone, created_at)`. Создайте запросы для:
- Поиска всех дубликатов по email
- Удаления дубликатов, оставив самую новую запись
- Слияния информации из дублирующихся записей

**Подсказки:**
```sql
-- ROW_NUMBER() OVER(PARTITION BY email ORDER BY created_at DESC)
-- DELETE с использованием CTE
-- COALESCE для объединения не-NULL значений
```

**Дополнительные вопросы:**
- Как обработать частичные дубликаты (похожие, но не идентичные)?
- Можно ли создать constraint для предотвращения дубликатов?
- Как эффективно найти дубликаты в очень большой таблице?

---

## Задача 13: Сложные условия и CASE

**Задание:** Система скидок с таблицами `customers(id, total_spent, vip_level)`, `products(id, category, price)`, `orders`. Рассчитайте скидку по правилам:
- VIP Gold: 15% на все
- VIP Silver: 10% на электронику, 5% на остальное
- Обычные клиенты: 5% при заказе >1000, 2% при >500
- Дополнительно 3% за лояльность (>10 заказов)

**Подсказки:**
```sql
-- Nested CASE WHEN для сложной логики
-- Подзапросы для подсчета количества заказов
-- GREATEST/LEAST для ограничения значений
```

**Дополнительные вопросы:**
- Как сделать систему скидок конфигурируемой через таблицы?
- Можно ли реализовать накопительные скидки?
- Как обработать конфликтующие правила скидок?

---

## Задача 14: Полнотекстовый поиск

**Задание:** Таблица статей `articles(id, title, content, tags)`. Реализуйте поиск который:
- Ищет по заголовку и содержимому с разным весом
- Поддерживает синонимы и морфологию
- Ранжирует результаты по релевантности
- Подсвечивает найденные фрагменты

**Подсказки:**
```sql
-- to_tsvector() с разными весами для полей
-- ts_rank() и ts_rank_cd() для ранжирования
-- ts_headline() для подсветки
-- CREATE INDEX USING GIN для производительности
```

**Дополнительные вопросы:**
- Как создать собственный словарь для поиска?
- Можно ли искать по звуковому сходству (soundex)?
- Как реализовать автодополнение поисковых запросов?

---

## Задача 15: Партиционирование запросов

**Задание:** Большая таблица логов `logs(timestamp, user_id, action, data)` партиционирована по месяцам. Напишите эффективные запросы для:
- Анализа активности пользователей за год
- Поиска аномалий в поведении
- Очистки старых данных

**Подсказки:**
```sql
-- WHERE условия должны включать partition key
-- EXPLAIN для проверки partition pruning
-- pg_stat_user_tables для мониторинга партиций
```

**Дополнительные вопросы:**
- Как проверить, что используется partition pruning?
- Можно ли создать индекс на все партиции сразу?
- Как эффективно джойнить партиционированные таблицы?

---

## Задача 16: Материализованные представления

**Задание:** Создайте систему отчетности с материализованными представлениями для:
- Ежедневных продаж по регионам
- Топ товаров по категориям
- Метрик активности пользователей
- Настройте автоматическое обновление

**Подсказки:**
```sql
-- CREATE MATERIALIZED VIEW
-- REFRESH MATERIALIZED VIEW CONCURRENTLY
-- Уникальные индексы для конкурентного обновления
-- pg_cron для автоматизации
```

**Дополнительные вопросы:**
- Когда использовать CONCURRENTLY обновление?
- Как мониторить актуальность материализованных представлений?
- Можно ли создать инкрементальное обновление?

---

## Задача 17: Транзакционная обработка

**Задание:** Реализуйте систему перевода денег между счетами с проверками:
- Достаточность средств
- Атомарность операции
- Блокировка счетов на время операции
- Логирование всех действий

**Подсказки:**
```sql
-- BEGIN/COMMIT для транзакций
-- SELECT FOR UPDATE для блокировки
-- SAVEPOINT для частичного отката
-- RAISE EXCEPTION для ошибок
```

**Дополнительные вопросы:**
- Как избежать deadlock'ов при переводах?
- Можно ли реализовать распределенные транзакции?
- Как обработать сбой в середине транзакции?

---

## Задача 18: ETL процессы

**Задание:** Создайте процедуру загрузки данных из staging таблицы в основную с:
- Валидацией данных
- Обработкой дубликатов
- Логированием ошибок
- Возможностью отката

**Подсказки:**
```sql
-- Temporary таблицы для промежуточных результатов
-- INSERT ... ON CONFLICT для upsert
-- EXCEPTION блоки для обработки ошибок
-- pg_stat_progress_* для мониторинга
```

**Дополнительные вопросы:**
- Как распараллелить ETL процесс?
- Можно ли загружать данные без блокировки таблиц?
- Как обрабатывать изменения схемы данных?

---

## Задача 19: Аудит и логирование

**Задание:** Создайте систему аудита изменений данных:
- Таблица аудита для отслеживания всех изменений
- Триггеры для автоматического логирования
- Запросы для анализа истории изменений
- Восстановление состояния на определенную дату

**Подсказки:**
```sql
-- Триггеры BEFORE/AFTER для INSERT/UPDATE/DELETE
-- hstore для хранения старых/новых значений
-- row_to_json() для сериализации данных
-- temporal таблицы для версионирования
```

**Дополнительные вопросы:**
- Как минимизировать влияние аудита на производительность?
- Можно ли восстановить удаленные данные?
- Как реализовать soft delete с аудитом?

---

## Задача 20: Расширенная аналитика

**Задание:** Система веб-аналитики. Реализуйте расчет:
- Конверсии воронки продаж (funnel analysis)
- Cohort анализ удержания пользователей
- RFM сегментацию клиентов
- A/B тестирование результатов

**Подсказки:**
```sql
-- LEAD/LAG для анализа воронки
-- Оконные функции для cohort анализа
-- NTILE() для RFM сегментации
-- Статистические функции для A/B тестов
```

**Дополнительные вопросы:**
- Как рассчитать статистическую значимость A/B теста?
- Можно ли автоматизировать создание cohort таблиц?
- Как эффективно хранить события для аналитики?

---

## Дополнительные темы для углубленного изучения:

- **Performance Schema**: pg_stat_* представления
- **Extensions Development**: Создание собственных расширений
- **Sharding**: Горизонтальное масштабирование
- **Advanced Indexing**: Covering indexes, expression indexes
- **Database Internals**: Как PostgreSQL хранит данные на диске
- **Security**: Row Level Security, Column Level Security
- **Cloud PostgreSQL**: Особенности работы в облаке
- **DevOps Integration**: Автоматизация развертывания и миграций