# 🚀 Блок 4: Транспортные протоколы и сервисы
## Связующее звено между сетью и приложениями

---

## 📋 Обзор блока

**Время изучения:** 2-3 месяца  
**Уровень сложности:** Средний-продвинутый  
**Предварительные требования:** Знание IP-маршрутизации и сетевого уровня

### Что вы изучите:
- Глубокие принципы работы TCP и UDP
- Управление потоком и контроль перегрузки
- Ключевые сетевые сервисы (DNS, DHCP, NTP)
- Прикладные протоколы (HTTP, SMTP, FTP)
- Методы анализа и оптимизации сетевого трафика

---

## 🔌 Глава 4.1: TCP и UDP
### Транспортный уровень - диспетчер сетевого взаимодействия

#### Концепция транспортного уровня

Транспортный уровень работает как почтовая служба: IP доставляет письма до правильного здания (хоста), а транспортный уровень доставляет их в правильную квартиру (приложение).

```
Аналогия с почтовой доставкой:
┌─────────────────────────────────────────────────────┐
│                 Почтовая система                    │
├─────────────────┬─────────────────┬─────────────────┤
│ Международная   │ Региональная    │ Местная         │
│ доставка        │ сортировка      │ доставка        │
│ (Интернет)      │ (Маршрутизация) │ (Порты/Сокеты)  │
└─────────────────┴─────────────────┴─────────────────┘

IP-адрес = Адрес здания
Порт = Номер квартиры/офиса
Протокол = Способ доставки (курьер/обычная почта)
```

#### Концепция портов и сокетов

**Порты - виртуальные двери приложений:**
```
Структура порта (16 бит = 0-65535):
┌──────────────┬─────────────────┬─────────────────┐
│   0 - 1023   │   1024 - 49151  │  49152 - 65535  │
│ Well-Known   │   Registered    │    Dynamic      │
│   Порты      │     Порты       │ (Ephemeral)     │
└──────────────┴─────────────────┴─────────────────┘

Well-Known порты (системные):
├── 20/21: FTP (данные/управление)
├── 22: SSH (Secure Shell)
├── 23: Telnet
├── 25: SMTP (отправка почты)
├── 53: DNS (преобразование имен)
├── 80: HTTP (веб-трафик)
├── 110: POP3 (получение почты)
├── 143: IMAP (почта)
├── 443: HTTPS (защищенный веб)
└── 993: IMAPS (защищенная почта)

Registered порты (приложения):
├── 1433: Microsoft SQL Server
├── 3389: Windows RDP
├── 5432: PostgreSQL
└── 8080: Альтернативный HTTP

Dynamic порты:
└── Автоматически назначаются клиентским приложениям
```

**Сокеты - конечные точки соединения:**
```
Сокет = IP-адрес + Порт + Протокол

Примеры сокетов:
├── 192.168.1.100:80/TCP    (веб-сервер)
├── 192.168.1.100:53/UDP    (DNS-сервер)
├── 192.168.1.50:45892/TCP  (клиентское приложение)
└── 8.8.8.8:53/UDP          (Google DNS)

Соединение определяется парой сокетов:
Client Socket ←→ Server Socket
192.168.1.50:45892/TCP ←→ 93.184.216.34:80/TCP
      (браузер)                (веб-сервер)
```

#### TCP - Надежный транспорт

TCP (Transmission Control Protocol) обеспечивает надежную, упорядоченную доставку данных.

**Основные характеристики TCP:**
```
Особенности TCP:
├── Connection-oriented (ориентирован на соединение)
├── Reliable delivery (надежная доставка)
├── Ordered delivery (упорядоченная доставка)
├── Flow control (управление потоком)
├── Congestion control (контроль перегрузки)
├── Full-duplex (дуплексная связь)
└── Byte-stream service (потоковый сервис)

TCP Header (20-60 байт):
┌─────────────────────────────────────────────────┐
│ Source Port (16)    │ Destination Port (16)     │
├─────────────────────────────────────────────────┤
│              Sequence Number (32)               │
├─────────────────────────────────────────────────┤
│            Acknowledgment Number (32)           │
├─────┬─────┬─────────────────┬─────────────────────┤
│Hlen │Res  │     Flags       │    Window Size      │
│ (4) │(6)  │     (6)         │       (16)          │
├─────────────────────────────┴─────────────────────┤
│   Checksum (16)     │    Urgent Pointer (16)     │
├─────────────────────────────────────────────────┤
│                Options (0-40)                   │
└─────────────────────────────────────────────────┘
```

#### Трехсторонний рукопожатие (Three-Way Handshake)

Процесс установления TCP соединения похож на вежливое знакомство:

```
Клиент                           Сервер
  │                                │
  │ 1. SYN (seq=100)              │
  │ ─────────────────────────────→ │
  │                                │
  │      2. SYN-ACK (seq=200,     │
  │          ack=101)              │
  │ ←───────────────────────────── │
  │                                │
  │ 3. ACK (seq=101, ack=201)     │
  │ ─────────────────────────────→ │
  │                                │
  │    Соединение установлено      │

Аналогия с разговором:
1. "Привет, меня зовут Алекс" (SYN)
2. "Привет Алекс, меня зовут Боб" (SYN-ACK)  
3. "Приятно познакомиться, Боб" (ACK)

Состояния TCP соединения:
CLOSED → SYN-SENT → ESTABLISHED
   ↑         ↓
LISTEN → SYN-RECEIVED
```

#### Управление потоком в TCP

**Sliding Window (скользящее окно):**
```
Принцип: Получатель сообщает отправителю, сколько данных
он готов принять

Пример обмена:
Отправитель                     Получатель
     │                              │
     │ Данные (1000 байт)          │
     │ ─────────────────────────→   │
     │                              │
     │ ACK + Window Size = 2000     │
     │ ←─────────────────────────   │
     │                              │
     │ Данные (2000 байт)          │
     │ ─────────────────────────→   │
     │                              │
     │ ACK + Window Size = 0        │
     │ ←─────────────────────────   │ (буфер полон)
     │                              │
     │    Ожидание освобождения     │
     │                              │
     │ ACK + Window Size = 1500     │
     │ ←─────────────────────────   │
     │                              │
     │ Данные (1500 байт)          │
     │ ─────────────────────────→   │

Визуализация окна:
┌─────────────────────────────────────────────┐
│ Отправлено │ Окно    │ Не может │ Будущие  │
│ и         │передачи │отправить │ данные   │
│подтверждено│         │   сейчас │          │
└─────────────────────────────────────────────┘
```

#### Контроль перегрузки TCP

**Алгоритмы предотвращения перегрузки:**

```
1. Slow Start (медленный старт):
Размер окна удваивается каждый RTT до достижения threshold

Окно перегрузки (cwnd):
RTT 1: 1 MSS    ████
RTT 2: 2 MSS    ████████  
RTT 3: 4 MSS    ████████████████
RTT 4: 8 MSS    ████████████████████████████████

2. Congestion Avoidance (предотвращение перегрузки):
После threshold окно растет линейно (+1 MSS за RTT)

3. Fast Retransmit:
При получении 3 дублированных ACK - немедленная повторная передача

4. Fast Recovery:
Уменьшение cwnd вдвое при обнаружении потерь, но без slow start

График изменения cwnd:
    cwnd
     ↑
     │     ╱╲
     │    ╱  ╲
     │   ╱    ╲     ╱╲
     │  ╱      ╲   ╱  ╲
     │ ╱        ╲ ╱    ╲
     │╱          ╲╱      ╲
     └─────────────────────→ время
      Slow    Cong.   Fast
      Start   Avoid.  Recovery
```

#### Таймеры TCP

**Критически важные таймеры:**
```
1. Retransmission Timer (RTO):
   ├── Адаптивный расчет на основе RTT
   ├── RTO = SRTT + 4 × RTTVAR
   ├── Удваивается при каждом timeout
   └── Максимум обычно 60-120 секунд

2. Persistence Timer:
   ├── Активируется при Window Size = 0
   ├── Периодические зондирующие пакеты
   └── Предотвращает deadlock

3. Keep-alive Timer:
   ├── Проверка активности соединения
   ├── По умолчанию 2 часа бездействия
   └── Опциональный механизм

4. TIME_WAIT Timer:
   ├── 2 × MSL (Maximum Segment Lifetime)
   ├── Обычно 30-120 секунд
   └── Гарантирует закрытие соединения

Диаграмма состояний RTO:
Packet Lost ─→ RTO = 2×previous_RTO ─→ Retransmit
     ↑                                      │
     └──── Max retries exceeded ←───────────┘
                     │
                  Close connection
```

#### UDP - Простой транспорт

UDP (User Datagram Protocol) - простой, быстрый протокол без гарантий.

**Характеристики UDP:**
```
Особенности UDP:
├── Connectionless (без соединения)
├── Unreliable (ненадежная доставка)
├── No ordering (нет гарантии порядка)
├── No flow control (нет управления потоком)
├── No congestion control (нет контроля перегрузки)
├── Low overhead (минимальные накладные расходы)
└── Fast (быстрая передача)

UDP Header (8 байт):
┌─────────────────────────────────────────┐
│ Source Port (16) │ Dest Port (16)      │
├──────────────────┴─────────────────────┤
│ Length (16)      │ Checksum (16)       │
└─────────────────────────────────────────┘

Простота = Скорость + Ответственность приложения
```

**Когда использовать UDP:**
```
Идеальные случаи для UDP:
├── Real-time приложения (игры, VoIP, видео)
├── DNS запросы (быстрые, короткие)
├── DHCP (широковещательные сообщения)
├── Streaming медиа (потери допустимы)
├── IoT устройства (ограниченные ресурсы)
├── Multicast/Broadcast трафик
└── Простые request-response протоколы

Примеры протоколов на UDP:
┌─────────────────┬─────────────────────────────┐
│ Протокол        │ Причина выбора UDP          │
├─────────────────┼─────────────────────────────┤
│ DNS             │ Быстрые короткие запросы    │
│ DHCP            │ Broadcast, простота         │
│ NTP             │ Периодические обновления    │
│ SNMP            │ Простые get/set операции    │
│ VoIP (RTP)      │ Real-time, потери допустимы │
│ Online Games    │ Низкая задержка критична    │
│ Video Streaming │ Скорость важнее надежности  │
└─────────────────┴─────────────────────────────┘
```

#### Multicast и UDP

**Концепция Multicast:**
```
Типы передачи:
┌─────────────┬────────────────┬─────────────────┐
│  Unicast    │   Broadcast    │    Multicast    │
│     1→1     │      1→все     │     1→группа    │
├─────────────┼────────────────┼─────────────────┤
│     A       │        A       │        A        │
│     │       │      ╱│╲       │      ╱ │        │
│     ▼       │     ╱ │ ╲      │     ╱  │        │
│     B       │    B  │  C     │    B   │        │
│             │       │        │   (в группе)    │
│             │       ▼        │        │        │
│             │       D        │        ▼        │
│             │                │        C        │
│             │                │   (в группе)    │
└─────────────┴────────────────┴─────────────────┘

Multicast группы (IPv4):
├── 224.0.0.0 - 239.255.255.255
├── 224.0.0.1: Все хосты в сегменте
├── 224.0.0.2: Все маршрутизаторы
├── 224.0.0.22: IGMP
└── 239.x.x.x: Организационно-локальные

IGMP (Internet Group Management Protocol):
Управляет членством в multicast группах
```

---

## 🌐 Глава 4.2: DNS и системные сервисы
### Критически важные службы сети

#### DNS - Телефонная книга интернета

DNS преобразует понятные людям имена в IP-адреса, работая как глобальная распределенная база данных.

**Иерархическая структура DNS:**
```
Корневая зона (.)
         │
    ┌────┼────┐
    │    │    │
   com  org   net  ru  uk ...
    │    │    │    │   │
    │   ┌┴┐   │   ┌┴┐  │
    │  yandex │  mail │
    │    │    │    │   │
google wikipedia │   rambler
    │      │      │     │
   www    www    www   www
   maps   mobile
   mail
   
Полное доменное имя (FQDN):
www.google.com.
│   │      │   │
│   │      │   └─ корневая зона
│   │      └───── домен верхнего уровня (TLD)
│   └──────────── домен второго уровня
└──────────────── поддомен (хост)
```

**Типы DNS записей:**
```
Основные типы записей:
┌─────┬─────────────────────────────────────────────────┐
│ Тип │ Назначение и пример                             │
├─────┼─────────────────────────────────────────────────┤
│ A   │ IPv4 адрес                                      │
│     │ www.example.com → 93.184.216.34                 │
├─────┼─────────────────────────────────────────────────┤
│AAAA │ IPv6 адрес                                      │
│     │ www.example.com → 2606:2800:220:1:248:1893::25c │
├─────┼─────────────────────────────────────────────────┤
│CNAME│ Каноническое имя (псевдоним)                    │
│     │ mail.example.com → webmail.hosting.com          │
├─────┼─────────────────────────────────────────────────┤
│ MX  │ Почтовый сервер (с приоритетом)                 │
│     │ example.com → 10 mail.example.com               │
├─────┼─────────────────────────────────────────────────┤
│ NS  │ Сервер имен (делегирование)                     │
│     │ example.com → ns1.example.com                   │
├─────┼─────────────────────────────────────────────────┤
│ PTR │ Обратное разрешение (IP → имя)                  │
│     │ 34.216.184.93.in-addr.arpa → www.example.com   │
├─────┼─────────────────────────────────────────────────┤
│ TXT │ Текстовая информация                            │
│     │ example.com → "v=spf1 include:_spf.google.com" │
├─────┼─────────────────────────────────────────────────┤
│ SRV │ Сервисные записи                                │
│     │ _http._tcp.example.com → 0 5 80 www.example.com │
└─────┴─────────────────────────────────────────────────┘
```

**Процесс разрешения DNS:**
```
Полный процесс запроса www.example.com:

1. Клиент ─────→ Локальный DNS resolver
                      │
2. Проверка кэша ─────┘
   ├─ Найдено → Ответ клиенту
   └─ Не найдено → Рекурсивный запрос

3. Resolver ─────→ Root DNS Server (.)
                      │
4. Root Server ──→ "Спроси .com сервер"
                      │
5. Resolver ─────→ .com TLD Server  
                      │
6. TLD Server ───→ "Спроси ns1.example.com"
                      │
7. Resolver ─────→ ns1.example.com
                      │
8. Auth Server ──→ A запись: 93.184.216.34
                      │
9. Resolver ─────→ Кэширование + ответ клиенту

Временная диаграмма:
Client    Resolver   Root    TLD    Auth
  │         │         │       │      │
  ├─Query──→│         │       │      │
  │         ├─Query──→│       │      │
  │         │←─NS────┤│       │      │
  │         ├─Query──┼─────→│      │
  │         │←─NS────┼─────┤│      │
  │         ├─Query──┼─────┼────→│
  │         │←─A─────┼─────┼────┤│
  │←─Answer─┤         │       │      │

Кэширование:
├── Клиент: секунды-минуты
├── Resolver: часы-дни (по TTL)
├── Браузер: 60 секунд
└── ОС: по настройкам
```

#### DNS безопасность и производительность

**DNSSEC - цифровые подписи:**
```
Проблема: DNS ответы могут быть поддельными
Решение: Криптографические подписи

DNSSEC записи:
├── DNSKEY: Открытые ключи зоны
├── RRSIG: Подписи для записей
├── DS: Делегация безопасности
├── NSEC/NSEC3: Доказательство отсутствия
└── CDNSKEY/CDS: Автоматизация

Цепочка доверия:
Root (.) → .com → example.com → www.example.com
   │        │         │             │
 DNSKEY → DS в .com → DNSKEY → RRSIG для A записи

Процесс проверки:
1. Получить A запись + RRSIG
2. Получить DNSKEY для проверки подписи
3. Проверить DS запись в родительской зоне
4. Рекурсивно до корневой зоны
```

**Оптимизация DNS:**
```
Методы ускорения:
├── Локальное кэширование
├── Anycast DNS серверы  
├── DNS prefetching в браузерах
├── Длительные TTL для статичных записей
├── CDN интеграция
└── DNS over HTTPS (DoH) / DNS over TLS (DoT)

Выбор DNS серверов:
Публичные DNS:
├── Google: 8.8.8.8, 8.8.4.4
├── Cloudflare: 1.1.1.1, 1.0.0.1
├── Quad9: 9.9.9.9, 149.112.112.112
└── OpenDNS: 208.67.222.222, 208.67.220.220

Критерии выбора:
├── Задержка (latency)
├── Надежность (uptime)
├── Безопасность (фильтрация)
├── Приватность (логирование)
└── Функциональность (DNSSEC)
```

#### DHCP - Автоматизация конфигурации

**Расширенные возможности DHCP:**

```
DHCP Relay Agent:
Проблема: DHCP broadcast не проходит через маршрутизаторы

Сеть A (192.168.1.0/24)     Сеть B (192.168.2.0/24)
┌─────────────────┐         ┌─────────────────┐
│ [Клиент]        │         │ [DHCP Server]   │
│      │          │         │                 │
│      ▼          │         │                 │
│ [DHCP Relay] ←──┼─────────┼→ DHCP Server    │
│ (маршрутизатор) │ unicast │                 │
└─────────────────┘         └─────────────────┘

Relay Agent:
1. Получает DHCP Discover broadcast
2. Добавляет свой IP как GIADDR
3. Пересылает unicast на DHCP сервер
4. Получает ответ и отправляет обратно клиенту
```

**DHCP опции для корпоративных сетей:**
```
Расширенные опции:
┌─────┬─────────────────────────────────────────────┐
│ № │ Описание и применение                       │
├─────┼─────────────────────────────────────────────┤
│ 66  │ TFTP Server - для загрузки конфигураций    │
│ 67  │ Boot filename - имя файла для загрузки     │
│ 150 │ Cisco IP Phone - список TFTP серверов      │
│ 160 │ Cisco IP Phone - адрес HTTP сервера        │
│ 43  │ Vendor Specific - настройки производителя  │
│ 119 │ Domain Search List - список доменов поиска │
│ 121 │ Classless Static Routes - статические      │
│     │ маршруты                                   │
│ 252 │ Proxy Auto-Discovery (WPAD)                │
└─────┴─────────────────────────────────────────────┘

Резервирование адресов:
├── По MAC-адресу: статическое назначение
├── По Client ID: идентификация клиента
├── По классу устройства: разные политики
└── По местоположению: через DHCP relay

DHCP Failover (отказоустойчивость):
Primary ←→ Secondary
    │        │
    └── Синхронизация состояния клиентов
    └── Разделение адресного пула
    └── Автоматическое переключение
```

#### NTP - Синхронизация времени

**Важность точного времени:**
```
Критичные применения:
├── Логирование и аудит безопасности
├── Криптографические сертификаты
├── Финансовые транзакции
├── Распределенные системы
├── Мониторинг и метрики
└── Соответствие требованиям (compliance)

Иерархия NTP:
┌─────────────────────────────────────────┐
│ Stratum 0: Точные источники времени     │
│ (GPS, атомные часы, радиосигналы)       │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│ Stratum 1: Первичные NTP серверы        │
│ (прямое подключение к Stratum 0)        │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│ Stratum 2: Вторичные NTP серверы        │
│ (синхронизация с Stratum 1)             │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│ Stratum 3-15: Клиенты и локальные       │
│ серверы                                 │
└─────────────────────────────────────────┘

Публичные NTP пулы:
├── pool.ntp.org (глобальный пул)
├── 0.pool.ntp.org, 1.pool.ntp.org...
├── ru.pool.ntp.org (российский пул)
└── time.google.com (Google)
```

**Алгоритм синхронизации NTP:**
```
Измерение задержки и смещения:

Клиент                    Сервер
  │                         │
  │ Request (T1) ──────────→ │ (T2)
  │                         │
  │ (T4) ←────────── Reply  │ (T3)
  │                         │

Расчеты:
Delay = (T4 - T1) - (T3 - T2)
Offset = ((T2 - T1) + (T3 - T4)) / 2

Где:
T1 = время отправки запроса
T2 = время получения запроса сервером  
T3 = время отправки ответа сервером
T4 = время получения ответа клиентом

Точность:
├── LAN: 1-50 микросекунд
├── WAN: 1-50 миллисекунд
├── Интернет: 10-100 миллисекунд
└── Dial-up: 100-1000 миллисекунд
```

#### SNMP - Мониторинг и управление

**Архитектура SNMP:**
```
Компоненты SNMP:
┌─────────────────┬─────────────────────────────┐
│ NMS             │ Network Management Station  │
│ (Manager)       │ - Центральная консоль       │
├─────────────────┼─────────────────────────────┤
│ Agent           │ SNMP агент на устройстве    │
│                 │ - Сбор и предоставление МИБ │
├─────────────────┼─────────────────────────────┤
│ MIB             │ Management Information Base │
│                 │ - База данных параметров    │
└─────────────────┴─────────────────────────────┘

SNMP версии:
├── SNMPv1: Простая, небезопасная (community strings)
├── SNMPv2c: Добавлены bulk операции, та же безопасность
└── SNMPv3: Аутентификация, шифрование, контроль доступа

Операции SNMP:
├── GET: Получить значение OID
├── GET-NEXT: Получить следующий OID
├── GET-BULK: Получить множественные OID (v2c+)
├── SET: Установить значение OID
└── TRAP: Уведомление от агента к менеджеру
```

**MIB структура:**
```
Иерархия OID (Object Identifier):
iso(1).org(3).dod(6).internet(1)
                    │
        ┌───────────┼───────────┐
     mgmt(2)    private(4)   security(5)
        │           │
     mib-2(1)   enterprises(1)
        │           │
    ┌───┼───┐      └─── cisco(9)
 system(1) interfaces(2)    │
    │           │        ├─── local(2)
 sysDescr(1) ifNumber(1) └─── temporary(3)
    │           │
 .1.3.6.1.2.1.1.1  .1.3.6.1.2.1.2.1

Примеры важных OID:
├── .1.3.6.1.2.1.1.1.0: sysDescr (описание системы)
├── .1.3.6.1.2.1.1.3.0: sysUpTime (время работы)
├── .1.3.6.1.2.1.2.2.1.10: ifInOctets (входящие байты)
├── .1.3.6.1.2.1.2.2.1.16: ifOutOctets (исходящие байты)
└── .1.3.6.1.2.1.25.1.1.0: hrSystemUptime (время работы хоста)

Типы данных SNMP:
├── INTEGER: Целые числа
├── OCTET STRING: Строки байт
├── OBJECT IDENTIFIER: OID ссылки
├── Counter: Растущие счетчики (32-bit)
├── Gauge: Текущие значения
├── TimeTicks: Временные метки
└── Counter64: 64-битные счетчики (v2c+)
```

---

## 📧 Глава 4.3: Прикладные протоколы
### Протоколы пользовательских приложений

#### HTTP/HTTPS - Основа всемирной паутины

**Эволюция HTTP:**
```
HTTP/0.9 (1991):
├── Только GET запросы
├── Только HTML ответы
├── Закрытие соединения после каждого запроса
└── Нет заголовков

HTTP/1.0 (1996):
├── Методы: GET, POST, HEAD
├── Заголовки запросов и ответов
├── Коды состояния
├── Поддержка разных типов контента
└── Все еще закрытие соединения

HTTP/1.1 (1997):
├── Persistent connections (keep-alive)
├── Pipelining запросов
├── Chunked transfer encoding
├── Host заголовок (виртуальные хосты)
├── Кэширование (ETag, If-Modified-Since)
└── Дополнительные методы (PUT, DELETE, OPTIONS)

HTTP/2 (2015):
├── Бинарный протокол
├── Multiplexing потоков
├── Server Push
├── Header compression (HPACK)
└── Приоритизация запросов

HTTP/3 (2022):
├── QUIC транспорт (UDP)
├── Встроенное шифрование
├── Улучшенная производительность
└── Устранение head-of-line blocking
```

**Структура HTTP запроса/ответа:**
```
HTTP Request:
┌─────────────────────────────────────────────┐
│ GET /index.html HTTP/1.1                    │ ← Request Line
│ Host: www.example.com                       │ ← Headers
│ User-Agent: Mozilla/5.0...                  │
│ Accept: text/html,application/xhtml+xml     │
│ Accept-Encoding: gzip, deflate              │
│ Connection: keep-alive                      │
│                                             │ ← Empty Line
│ [Request Body - для POST/PUT]               │ ← Body (optional)
└─────────────────────────────────────────────┘

HTTP Response:
┌─────────────────────────────────────────────┐
│ HTTP/1.1 200 OK                             │ ← Status Line
│ Date: Mon, 01 Jul 2024 12:00:00 GMT         │ ← Headers
│ Server: Apache/2.4.41                      │
│ Content-Type: text/html; charset=UTF-8     │
│ Content-Length: 1234                       │
│ Cache-Control: max-age=3600                │
│                                             │ ← Empty Line
│ <!DOCTYPE html>                             │ ← Body
│ <html>                                      │
│ <head><title>Example</title></head>         │
│ <body>Hello World!</body>                   │
│ </html>                                     │
└─────────────────────────────────────────────┘
```

**HTTP методы и коды состояния:**
```
Основные HTTP методы:
┌─────────┬────────────────────────────────────────┐
│ Метод   │ Назначение                             │
├─────────┼────────────────────────────────────────┤
│ GET     │ Получение ресурса                      │
│ POST    │ Отправка данных (создание ресурса)     │
│ PUT     │ Создание/обновление ресурса            │
│ DELETE  │ Удаление ресурса                       │
│ HEAD    │ Получение только заголовков            │
│ OPTIONS │ Получение поддерживаемых методов       │
│ PATCH   │ Частичное обновление ресурса           │
│ CONNECT │ Туннелирование (для HTTPS proxy)       │
│ TRACE   │ Диагностика пути запроса               │
└─────────┴────────────────────────────────────────┘

Коды состояния HTTP:
┌─────┬─────────────────────────────────────────────┐
│Класс│ Значение и примеры                          │
├─────┼─────────────────────────────────────────────┤
│ 1xx │ Информационные                              │
│     │ 100 Continue, 101 Switching Protocols      │
├─────┼─────────────────────────────────────────────┤
│ 2xx │ Успешные                                    │
│     │ 200 OK, 201 Created, 204 No Content        │
├─────┼─────────────────────────────────────────────┤
│ 3xx │ Перенаправления                             │
│     │ 301 Moved Permanently, 302 Found,          │
│     │ 304 Not Modified                           │
├─────┼─────────────────────────────────────────────┤
│ 4xx │ Ошибки клиента                              │
│     │ 400 Bad Request, 401 Unauthorized,         │
│     │ 403 Forbidden, 404 Not Found               │
├─────┼─────────────────────────────────────────────┤
│ 5xx │ Ошибки сервера                              │
│     │ 500 Internal Server Error,                 │
│     │ 502 Bad Gateway, 503 Service Unavailable   │
└─────┴─────────────────────────────────────────────┘
```

**HTTPS и TLS:**
```
TLS Handshake процесс:
Клиент                         Сервер
  │                              │
  │ 1. Client Hello              │
  │ ─────────────────────────────→ │
  │                              │
  │ 2. Server Hello              │
  │    Certificate               │
  │    Server Key Exchange       │
  │    Server Hello Done         │
  │ ←───────────────────────────── │
  │                              │
  │ 3. Client Key Exchange       │
  │    Change Cipher Spec        │
  │    Finished                  │
  │ ─────────────────────────────→ │
  │                              │
  │ 4. Change Cipher Spec        │
  │    Finished                  │
  │ ←───────────────────────────── │
  │                              │
  │ Encrypted Application Data   │
  │ ←─────────────────────────────→ │

Компоненты TLS:
├── Cipher Suites: Алгоритмы шифрования
├── Certificate Authority: Доверенные центры
├── Digital Certificates: X.509 сертификаты
├── Perfect Forward Secrecy: Уникальные ключи сессии
└── HSTS: HTTP Strict Transport Security
```

#### Электронная почта

**Архитектура почтовой системы:**
```
Компоненты почтовой инфраструктуры:
┌─────────────┬─────────────────────────────────────┐
│ Компонент   │ Функция                             │
├─────────────┼─────────────────────────────────────┤
│ MUA         │ Mail User Agent (клиент)            │
│ (Client)    │ Outlook, Thunderbird, Webmail       │
├─────────────┼─────────────────────────────────────┤
│ MSA         │ Mail Submission Agent               │
│             │ Прием писем от клиентов             │
├─────────────┼─────────────────────────────────────┤
│ MTA         │ Mail Transfer Agent                 │
│             │ Маршрутизация между серверами       │
├─────────────┼─────────────────────────────────────┤
│ MDA         │ Mail Delivery Agent                 │
│             │ Доставка в почтовые ящики           │
└─────────────┴─────────────────────────────────────┘

Поток почтового сообщения:
[MUA] ─SMTP─→ [MSA] ─SMTP─→ [MTA] ─SMTP─→ [MTA] ─LMTP─→ [MDA]
  │                                                        │
  │                                                        ▼
  │                                                   [Mailbox]
  │                                                        │
  └─────────────── POP3/IMAP ←─────────────────────────────┘
```

**SMTP - Отправка почты:**
```
SMTP сессия:
Client                          Server
  │                               │
  │ TCP connection port 25        │
  │ ─────────────────────────────→ │
  │                               │
  │ 220 mail.example.com ESMTP    │
  │ ←───────────────────────────── │
  │                               │
  │ EHLO client.domain.com        │
  │ ─────────────────────────────→ │
  │                               │
  │ 250-mail.example.com          │
  │ 250-SIZE 52428800             │
  │ 250 STARTTLS                  │
  │ ←───────────────────────────── │
  │                               │
  │ MAIL FROM:<sender@domain.com> │
  │ ─────────────────────────────→ │
  │                               │
  │ 250 OK                        │
  │ ←───────────────────────────── │
  │                               │
  │ RCPT TO:<recip@example.com>   │
  │ ─────────────────────────────→ │
  │                               │
  │ 250 OK                        │
  │ ←───────────────────────────── │
  │                               │
  │ DATA                          │
  │ ─────────────────────────────→ │
  │                               │
  │ 354 Send message              │
  │ ←───────────────────────────── │
  │                               │
  │ [Message headers and body]    │
  │ .                             │
  │ ─────────────────────────────→ │
  │                               │
  │ 250 Message accepted          │
  │ ←───────────────────────────── │

SMTP коды ответов:
├── 2xx: Успех (250 OK, 221 Bye)
├── 3xx: Промежуточные (354 Start mail input)
├── 4xx: Временные ошибки (450 Mailbox busy)
└── 5xx: Постоянные ошибки (550 User unknown)
```

**POP3 vs IMAP:**
```
POP3 (Post Office Protocol):
┌─────────────────┬─────────────────────────────────┐
│ Особенности     │ Описание                        │
├─────────────────┼─────────────────────────────────┤
│ Модель          │ Download-and-delete             │
│ Синхронизация   │ Нет (локальное хранение)        │
│ Папки           │ Только Inbox на сервере         │
│ Поиск           │ Только локально                 │
│ Мультиустройства│ Проблематично                   │
│ Трафик          │ Минимальный                     │
│ Оффлайн доступ  │ Полный                          │
└─────────────────┴─────────────────────────────────┘

IMAP (Internet Message Access Protocol):
┌─────────────────┬─────────────────────────────────┐
│ Особенности     │ Описание                        │
├─────────────────┼─────────────────────────────────┤
│ Модель          │ Server-side storage             │
│ Синхронизация   │ Полная между устройствами       │
│ Папки           │ Любая структура папок           │
│ Поиск           │ На сервере (быстро)             │
│ Мультиустройства│ Идеально                        │
│ Трафик          │ Больше                          │
│ Оффлайн доступ  │ Частичный (кэш)                 │
└─────────────────┴─────────────────────────────────┘

IMAP команды:
├── SELECT INBOX: Выбор папки
├── FETCH 1:10 BODY: Получение тел сообщений
├── SEARCH FROM "example.com": Поиск писем
├── STORE 1:5 +FLAGS (\Seen): Пометка как прочитанное
└── EXPUNGE: Физическое удаление помеченных писем
```

#### FTP - Передача файлов

**Архитектура FTP:**
```
FTP использует два канала:
┌─────────────────┬─────────────────────────────────┐
│ Control Channel │ Data Channel                    │
├─────────────────┼─────────────────────────────────┤
│ Порт 21         │ Порт 20 (активный) или          │
│                 │ произвольный (пассивный)        │
├─────────────────┼─────────────────────────────────┤
│ Команды         │ Передача файлов                 │
│ USER, PASS      │ Содержимое файлов               │
│ LIST, PWD       │ Листинги каталогов              │
│ CWD, MKD        │                                 │
└─────────────────┴─────────────────────────────────┘

Активный режим FTP:
Client                    Server
  │ Control (21) ─────────→ │
  │ PORT 2000              │
  │ ←──────────────────────── │
  │                        │
  │ ←────── Data (20) ─────── │ (Сервер подключается)
  │                        │

Пассивный режим FTP:
Client                    Server  
  │ Control (21) ─────────→ │
  │ PASV                   │
  │ ←──────────────────────── │
  │ 227 (192.168.1.1,8,0) │ (Порт 8*256+0=2048)
  │                        │
  │ Data (2048) ─────────→ │ (Клиент подключается)
```

**Современные альтернативы FTP:**
```
SFTP (SSH File Transfer Protocol):
├── Работает поверх SSH (порт 22)
├── Шифрование всего трафика
├── Аутентификация SSH ключами
├── Один канал для команд и данных
└── Поддержка resume передач

FTPS (FTP over SSL/TLS):
├── FTP с шифрованием SSL/TLS
├── Explicit (FTPES) - команда AUTH TLS
├── Implicit - сразу защищенное соединение
├── Сложности с пассивным режимом через NAT
└── Два варианта защиты каналов

HTTP/HTTPS файловые API:
├── RESTful интерфейсы
├── Простота интеграции
├── Работа через веб-браузеры
├── Поддержка resume (Range заголовки)
└── Стандартные методы аутентификации
```

#### VoIP протоколы

**SIP (Session Initiation Protocol):**
```
SIP участники:
┌─────────────────┬─────────────────────────────────┐
│ User Agent (UA) │ Клиентские устройства           │
│                 │ Телефоны, софтфоны              │
├─────────────────┼─────────────────────────────────┤
│ Proxy Server    │ Маршрутизация SIP сообщений     │
│                 │ Балансировка нагрузки           │
├─────────────────┼─────────────────────────────────┤
│ Registrar       │ Регистрация пользователей       │
│                 │ Location Service                │
├─────────────────┼─────────────────────────────────┤
│ Redirect Server │ Перенаправление запросов        │
│                 │ Альтернативные маршруты         │
└─────────────────┴─────────────────────────────────┘

SIP методы:
├── INVITE: Установление сессии
├── ACK: Подтверждение ответа на INVITE
├── BYE: Завершение сессии
├── CANCEL: Отмена незавершенной транзакции
├── REGISTER: Регистрация пользователя
├── OPTIONS: Запрос возможностей
└── INFO: Информационные сообщения

Установление вызова:
UA-A          Proxy         UA-B
  │             │             │
  │ INVITE      │             │
  │ ─────────→  │ INVITE      │
  │             │ ─────────→  │
  │             │             │
  │             │ 180 Ringing │
  │ 180 Ringing │ ←─────────  │
  │ ←─────────  │             │
  │             │             │
  │             │ 200 OK      │
  │ 200 OK      │ ←─────────  │
  │ ←─────────  │             │
  │             │             │
  │ ACK         │             │
  │ ─────────→  │ ACK         │
  │             │ ─────────→  │
  │             │             │
  │ ←─────── RTP Media ─────→ │
```

**RTP (Real-time Transport Protocol):**
```
RTP для медиа-потоков:
┌─────────────────────────────────────────────────┐
│ RTP Header (12 bytes minimum)                  │
├─────┬─────┬─────┬─────────────────────────────┤
│ V   │ P   │ X   │ CC    │ M │ PT      │ Seq   │
│ (2) │ (1) │ (1) │ (4)   │(1)│ (7)     │ (16)  │
├─────┴─────┴─────┴───────┴───┴─────────┴───────┤
│                Timestamp (32)                 │
├───────────────────────────────────────────────┤
│            Synchronization Source (32)        │
└───────────────────────────────────────────────┘

Где:
V = Version (обычно 2)
P = Padding
X = Extension
CC = Contributing source Count
M = Marker (важные события)
PT = Payload Type (тип кодека)
Seq = Sequence number (порядок пакетов)

Кодеки и качество:
┌─────────┬──────────┬─────────┬─────────────────┐
│ Кодек   │ Битрейт  │ Качество│ Применение      │
├─────────┼──────────┼─────────┼─────────────────┤
│ G.711   │ 64 kbps  │ Высокое │ PSTN качество   │
│ G.729   │ 8 kbps   │ Хорошее │ Экономия трафика│
│ G.722   │ 64 kbps  │ HD      │ Конференции     │
│ Opus    │ 6-510kbps│ Отличное│ Современный     │
└─────────┴──────────┴─────────┴─────────────────┘
```

---

## 🔍 Методы анализа сетевого трафика

#### Wireshark - Швейцарский нож сетевого анализа

**Основы захвата пакетов:**
```
Уровни анализа в Wireshark:
┌─────────────────────────────────────────────────┐
│ Frame: Физическая информация кадра              │
├─────────────────────────────────────────────────┤
│ Ethernet: Заголовки канального уровня           │
├─────────────────────────────────────────────────┤
│ IP: Заголовки сетевого уровня                   │
├─────────────────────────────────────────────────┤
│ TCP/UDP: Заголовки транспортного уровня         │
├─────────────────────────────────────────────────┤
│ HTTP/DNS/etc: Протоколы прикладного уровня      │
└─────────────────────────────────────────────────┘

Полезные фильтры:
├── ip.addr == 192.168.1.1: Трафик с/на IP
├── tcp.port == 80: HTTP трафик
├── dns: Только DNS запросы
├── http.request.method == "POST": POST запросы
├── tcp.flags.syn == 1: SYN пакеты
├── ip.ttl < 10: Пакеты с малым TTL
└── frame.time_relative > 5: Пакеты после 5 секунд
```

**Анализ производительности:**
```
Ключевые метрики:
┌─────────────────┬─────────────────────────────────┐
│ Метрика         │ Что показывает                  │
├─────────────────┼─────────────────────────────────┤
│ RTT             │ Round Trip Time - задержка      │
│ Throughput      │ Пропускная способность          │
│ Packet Loss     │ Потери пакетов                  │
│ Jitter          │ Вариация задержки               │
│ Window Scaling  │ Эффективность TCP окон          │
│ Retransmissions │ Повторные передачи              │
└─────────────────┴─────────────────────────────────┘

TCP анализ в Wireshark:
├── Statistics → Flow Graph: Диаграмма потока
├── Statistics → TCP Stream Graphs: Графики TCP
├── Analyze → Expert Information: Автоматический анализ
├── Statistics → Conversations: Статистика соединений
└── Statistics → I/O Graphs: Графики трафика по времени

Экспертные уведомления:
├── Note: Информационные (переиспользование портов)
├── Chat: Нормальные события (handshake)
├── Warning: Подозрительные (дублированные ACK)
└── Error: Проблемы (TCP retransmission)
```

---

## 🎯 Практические задания для закрепления

### Задание 1: Анализ TCP соединения
```
Используя Wireshark, проанализируйте:
1. Захватите трафик HTTP запроса к веб-сайту
2. Найдите three-way handshake
3. Определите размер TCP window
4. Найдите время RTT
5. Проследите закрытие соединения

Вопросы для анализа:
- Какие флаги TCP установлены в каждом сегменте?
- Как изменяется размер окна в течение сессии?
- Есть ли повторные передачи?
```

### Задание 2: Настройка DHCP с опциями
```
Настройте DHCP сервер для корпоративной сети:
- Основная сеть: 192.168.100.0/24
- Исключения: .1-.10 для серверов
- DNS серверы: 8.8.8.8, 8.8.4.4
- Домен: company.local
- Время аренды: 8 часов
- Опция 66: TFTP сервер 192.168.100.5
- Резервирование для принтера 00:11:22:33:44:55 → .200

Протестируйте:
1. Обычное получение адреса
2. Обновление аренды
3. Резервирование
```

### Задание 3: DNS troubleshooting
```
Диагностируйте проблемы DNS:
1. Клиент не может разрешить www.example.com
2. Разрешение работает, но очень медленно
3. Некоторые домены разрешаются, другие нет

Инструменты для диагностики:
- nslookup/dig для прямых запросов
- Wireshark для анализа трафика
- Проверка DNS серверов и путей
- Анализ TTL и кэширования
```

---

## 📚 Ключевые понятия для запоминания

### TCP vs UDP:
- **TCP** - надежность, упорядоченность, управление потоком
- **UDP** - скорость, простота, минимальные накладные расходы
- **Порты** - логические каналы для приложений
- **Сокеты** - конечные точки сетевого соединения

### Системные сервисы:
- **DNS** - преобразование имен в IP-адреса
- **DHCP** - автоматическое назначение IP-конфигурации
- **NTP** - синхронизация времени в сети
- **SNMP** - мониторинг и управление устройствами

### Прикладные протоколы:
- **HTTP/HTTPS** - веб-трафик и безопасность
- **SMTP/POP3/IMAP** - электронная почта
- **FTP/SFTP** - передача файлов
- **SIP/RTP** - VoIP коммуникации

### Анализ и оптимизация:
- **Wireshark** - глубокий анализ пакетов
- **RTT** - ключевая метрика производительности
- **TCP Window** - управление потоком данных
- **Expert Analysis** - автоматическое обнаружение проблем

---

## 🎯 Готовность к следующему блоку

После изучения этого блока вы должны уметь:

✅ **Понимать работу TCP и UDP** на глубоком уровне  
✅ **Настраивать системные сервисы** (DNS, DHCP, NTP, SNMP)  
✅ **Анализировать прикладные протоколы** (HTTP, SMTP, FTP)  
✅ **Диагностировать проблемы** с помощью Wireshark  
✅ **Оптимизировать производительность** транспортного уровня  

**Следующий блок:** Безопасность и мониторинг - углубление в сетевую безопасность, VPN технологии, системы обнаружения вторжений и комплексный мониторинг инфраструктуры.

---

*Время на изучение: 2-3 месяца при 20+ часах в неделю*  
*Практика: 60% лабораторных работ, 40% теории*  
*Цель: Экспертное понимание транспортного уровня и сетевых сервисов*