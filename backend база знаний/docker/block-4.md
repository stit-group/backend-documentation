# 🔧 Блок 4: Docker Compose и оркестрация

## Введение в блок

Добро пожаловать в четвертый блок изучения Docker! На этом этапе мы переходим от работы с отдельными контейнерами к управлению сложными многоконтейнерными приложениями. Представьте, что до сих пор вы учились водить одну машину, а теперь будете управлять целым автопарком.

```
Эволюция управления контейнерами:

Одиночный контейнер → Несколько связанных контейнеров → Оркестрация
     🚗                    🚗🚗🚗                        🚛🚚🚐
  (простая задача)      (сложное приложение)        (производственная система)
```

---

## 📋 Глава 4.1: Введение в Docker Compose
*Время изучения: 6-7 дней*

### 🎯 Что такое Docker Compose?

Docker Compose — это инструмент для определения и запуска многоконтейнерных Docker приложений. Думайте о нем как о "дирижере оркестра", который координирует работу множества музыкантов (контейнеров) для создания единой симфонии (приложения).

#### Зачем нужен Docker Compose?

До появления Compose разработчикам приходилось:
- Запускать каждый контейнер отдельно длинными командами
- Помнить все параметры и зависимости
- Создавать сложные bash-скрипты для автоматизации

```
Без Compose:
┌─────────────────────────────────────────────────────────────┐
│ docker run -d --name database postgres                     │
│ docker run -d --name redis redis                           │
│ docker run -d --name app --link database --link redis ...  │
│ docker run -d --name nginx --link app ...                  │
└─────────────────────────────────────────────────────────────┘

С Compose:
┌─────────────────────────────────────────────────────────────┐
│ docker-compose up                                           │
└─────────────────────────────────────────────────────────────┘
```

### 🏗️ Архитектура Docker Compose

```
Docker Compose Architecture:

    docker-compose.yml
           │
           ▼
    ┌─────────────────┐
    │  Compose CLI    │ ◄── команды пользователя
    └─────────────────┘
           │
           ▼
    ┌─────────────────┐
    │  Docker Engine  │ ◄── создание контейнеров
    └─────────────────┘
           │
           ▼
    ┌─────┬─────┬─────┐
    │ Web │ DB  │Cache│ ◄── контейнеры приложения
    └─────┴─────┴─────┘
```

### 📝 YAML: Язык конфигурации

YAML (YAML Ain't Markup Language) — человекочитаемый формат сериализации данных. Основные принципы:

```yaml
# Комментарии начинаются с #
ключ: значение

# Списки (массивы)
fruits:
  - apple
  - banana
  - orange

# Вложенные объекты
person:
  name: John
  age: 30
  address:
    street: 123 Main St
    city: New York

# Строки можно писать без кавычек
simple_string: Hello World
quoted_string: "Hello World"
multiline_string: |
  Это многострочная
  строка в YAML
```

#### Важные правила YAML:
- **Отступы только пробелами** (не табуляцией!)
- **Одинаковый уровень = одинаковые отступы**
- **Регистр имеет значение**

### 🌟 Основные концепции Compose

#### 1. Сервисы (Services)
Сервис — это определение контейнера в Compose файле. Каждый сервис описывает:
- Какой образ использовать
- Какие порты открыть
- Какие переменные окружения передать
- Как связать с другими сервисами

```
Сервисы в веб-приложении:

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   frontend  │    │   backend   │    │  database   │
│   (React)   │◄──►│   (Node.js) │◄──►│ (PostgreSQL)│
│   port:3000 │    │   port:8000 │    │   port:5432 │
└─────────────┘    └─────────────┘    └─────────────┘
```

#### 2. Сети (Networks)
Compose автоматически создает сеть для всех сервисов, позволяя им общаться друг с другом по именам сервисов.

```
Автоматическая сеть Compose:

    myapp_default (bridge network)
    ┌─────────────────────────────────────┐
    │  ┌─────┐    ┌─────┐    ┌─────┐     │
    │  │ web │◄──►│ api │◄──►│ db  │     │
    │  └─────┘    └─────┘    └─────┘     │
    └─────────────────────────────────────┘
```

#### 3. Тома (Volumes)
Volumes в Compose управляют постоянным хранением данных между запусками контейнеров.

```
Типы хранения в Compose:

Named Volume:           Bind Mount:           tmpfs Mount:
┌─────────────┐        ┌─────────────┐       ┌─────────────┐
│   Docker    │        │    Host     │       │   Memory    │
│  managed    │        │ filesystem  │       │    only     │
│             │        │             │       │             │
│ /var/lib/   │        │ /home/user/ │       │    tmpfs    │
│ docker/     │        │ project/    │       │             │
└─────────────┘        └─────────────┘       └─────────────┘
```

### 📋 Структура docker-compose.yml

Базовая структура Compose файла:

```yaml
version: '3.8'  # Версия схемы Compose

services:       # Определение всех сервисов
  service1:
    # конфигурация первого сервиса
  service2:
    # конфигурация второго сервиса

networks:       # Пользовательские сети (опционально)
  network1:
    # конфигурация сети

volumes:        # Именованные тома (опционально)
  volume1:
    # конфигурация тома
```

#### Версии Compose файлов:
```
Эволюция версий Compose:

v1.0 (legacy) → v2.x (2016-2018) → v3.x (2017-2020) → Compose Spec (2020+)
     │               │                    │                    │
 устаревшая     основные функции    Docker Swarm        современный
               networks, volumes     совместимость        стандарт
```

### 🚀 Первые шаги с Compose

#### Простейший пример:

```yaml
version: '3.8'

services:
  web:
    image: nginx:alpine
    ports:
      - "8080:80"
```

Этот файл создает один сервис `web` с nginx, доступный на порту 8080.

#### Более сложный пример:

```yaml
version: '3.8'

services:
  # Веб-сервер
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    depends_on:
      - app
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

  # Приложение
  app:
    build: .
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://user:password@database:5432/myapp
    depends_on:
      - database

  # База данных
  database:
    image: postgres:13
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: myapp
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  db_data:
```

### 🔧 Основные команды Docker Compose

```
Жизненный цикл приложения с Compose:

create → build → start → logs → stop → remove
   │        │       │       │      │       │
   │        │       │       │      │       └─► docker-compose down
   │        │       │       │      └─────────► docker-compose stop
   │        │       │       └────────────────► docker-compose logs
   │        │       └────────────────────────► docker-compose up
   │        └────────────────────────────────► docker-compose build
   └─────────────────────────────────────────► docker-compose create
```

#### Основные команды:

```bash
# Запустить все сервисы
docker-compose up

# Запустить в фоновом режиме
docker-compose up -d

# Пересобрать образы перед запуском
docker-compose up --build

# Остановить все сервисы
docker-compose stop

# Остановить и удалить контейнеры, сети
docker-compose down

# Остановить и удалить + volumes
docker-compose down -v

# Просмотр логов
docker-compose logs

# Логи конкретного сервиса
docker-compose logs web

# Выполнить команду в сервисе
docker-compose exec web bash

# Масштабирование сервиса
docker-compose up --scale web=3
```

### 🔄 Переменные окружения в Compose

#### 1. Переменные в docker-compose.yml:

```yaml
services:
  app:
    image: myapp
    environment:
      - NODE_ENV=production
      - API_KEY=${API_KEY}  # Из переменной хоста
      - DATABASE_URL=postgresql://user:${DB_PASSWORD}@db:5432/app
```

#### 2. Использование .env файла:

```bash
# .env файл в том же каталоге
NODE_ENV=development
DB_PASSWORD=secret123
API_KEY=your-api-key-here
```

#### 3. Приоритет переменных:

```
Приоритет переменных окружения (от высшего к низшему):

1. Shell environment variables
        │
        ▼
2. Environment file (.env)
        │
        ▼
3. docker-compose.yml environment
        │
        ▼
4. Dockerfile ENV
        │
        ▼
5. Default values in application
```

### 🎯 Практические упражнения

#### Упражнение 1: Простое веб-приложение
Создайте Compose файл для nginx + статичный сайт:

**Цель:** Понять базовую структуру Compose файла
**Результат:** Работающий веб-сервер на localhost:8080

#### Упражнение 2: Веб-приложение с базой данных
Добавьте PostgreSQL к веб-приложению:

**Цель:** Научиться связывать сервисы и работать с volumes
**Результат:** Приложение, которое сохраняет данные в БД

#### Упражнение 3: Многоуровневое приложение
Создайте архитектуру: Frontend + Backend + Database + Cache

**Цель:** Понять сложные зависимости между сервисами
**Результат:** Полноценное приложение с несколькими уровнями

### 📊 Диагностика и отладка

#### Проверка статуса сервисов:

```bash
# Список запущенных сервисов
docker-compose ps

# Подробная информация о сервисах
docker-compose top

# Использование ресурсов
docker-compose exec web top
```

#### Отладка сетевых соединений:

```bash
# Проверка связности между сервисами
docker-compose exec web ping database

# Просмотр сетевых настроек
docker-compose exec web cat /etc/hosts

# Проверка портов
docker-compose exec web netstat -tlnp
```

### 🔍 Распространенные проблемы

#### 1. Проблемы с отступами в YAML:
```
❌ Неправильно:
services:
web:  # неправильный отступ
  image: nginx

✅ Правильно:
services:
  web:  # правильный отступ
    image: nginx
```

#### 2. Проблемы с зависимостями:
```yaml
# depends_on не ждет готовности сервиса!
services:
  app:
    depends_on:
      - database  # Только ждет запуска контейнера
    # Нужно добавить health check или wait-script
```

#### 3. Конфликты портов:
```
Error: Port 80 is already in use
Решение: Изменить mapping портов на свободные
```

### 📈 Мониторинг и логирование

```yaml
services:
  app:
    image: myapp
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

---

## 📚 Заключение главы 4.1

В этой главе вы изучили:

✅ **Концепции Docker Compose**: Понимаете, зачем нужен Compose и как он упрощает управление многоконтейнерными приложениями

✅ **YAML синтаксис**: Умеете читать и писать YAML файлы, понимаете важность правильных отступов

✅ **Основные компоненты**: Знаете, что такое сервисы, сети и тома в контексте Compose

✅ **Команды управления**: Можете запускать, останавливать и управлять приложениями через Compose

✅ **Переменные окружения**: Понимаете, как конфигурировать приложения через переменные

### 🎯 Следующие шаги

В следующей главе мы изучим продвинутые возможности Compose:
- Override файлы для разных окружений
- Профили для условного запуска сервисов  
- Health checks и зависимости
- Масштабирование и производительность

### 💡 Ключевые принципы для запоминания

1. **Compose = Декларативное описание инфраструктуры**
2. **Один файл описывает всю архитектуру приложения**
3. **Сервисы автоматически могут общаться по именам**
4. **Volumes обеспечивают персистентность данных**
5. **Переменные окружения делают конфигурацию гибкой**

---

*Продолжение следует... Переходите к изучению продвинутых возможностей Compose! 🚀*