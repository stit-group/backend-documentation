# Python Backend Developer: –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ—Ç –Ω—É–ª—è –¥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞

## üéØ –í–≤–µ–¥–µ–Ω–∏–µ: –í–∞—à –ø—É—Ç—å –≤ backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É

### –ü–æ—á–µ–º—É Python –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç –≤ backend?

Python —Å—Ç–∞–ª —è–∑—ã–∫–æ–º –≤—ã–±–æ—Ä–∞ –¥–ª—è backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ. –†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:

```
–†–æ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Python –≤ backend (2020-2024):
‚îú‚îÄ‚îÄ 2020: 31% –ø—Ä–æ–µ–∫—Ç–æ–≤
‚îú‚îÄ‚îÄ 2021: 38% –ø—Ä–æ–µ–∫—Ç–æ–≤  
‚îú‚îÄ‚îÄ 2022: 45% –ø—Ä–æ–µ–∫—Ç–æ–≤
‚îú‚îÄ‚îÄ 2023: 52% –ø—Ä–æ–µ–∫—Ç–æ–≤
‚îî‚îÄ‚îÄ 2024: 58% –ø—Ä–æ–µ–∫—Ç–æ–≤
```

**üè¢ –ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Python –≤ backend:**
- **Instagram** - 500+ –º–ª–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ Django
- **Spotify** - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–∞ Python
- **Netflix** - –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- **Uber** - —Å–∏—Å—Ç–µ–º–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- **Dropbox** - —Ñ–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ Python –¥–ª—è backend

```
Python Backend Ecosystem
‚îÇ
‚îú‚îÄ‚îÄ üåê Web Frameworks
‚îÇ   ‚îú‚îÄ‚îÄ FastAPI (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –±—ã—Å—Ç—Ä—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ Django (–ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π)
‚îÇ   ‚îú‚îÄ‚îÄ Flask (–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π)
‚îÇ   ‚îî‚îÄ‚îÄ Starlette (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
‚îÇ
‚îú‚îÄ‚îÄ üóÑÔ∏è Databases & ORM
‚îÇ   ‚îú‚îÄ‚îÄ SQLAlchemy (—Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π ORM)
‚îÇ   ‚îú‚îÄ‚îÄ Django ORM (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ Django)
‚îÇ   ‚îú‚îÄ‚îÄ Tortoise ORM (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
‚îÇ   ‚îî‚îÄ‚îÄ Peewee (–ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π)
‚îÇ
‚îú‚îÄ‚îÄ ‚ö° Performance & Caching
‚îÇ   ‚îú‚îÄ‚îÄ Redis (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–µ—Å—Å–∏–∏)
‚îÇ   ‚îú‚îÄ‚îÄ Celery (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
‚îÇ   ‚îú‚îÄ‚îÄ Gunicorn (WSGI —Å–µ—Ä–≤–µ—Ä)
‚îÇ   ‚îî‚îÄ‚îÄ Uvicorn (ASGI —Å–µ—Ä–≤–µ—Ä)
‚îÇ
‚îî‚îÄ‚îÄ üõ†Ô∏è Tools & Libraries
    ‚îú‚îÄ‚îÄ Pydantic (–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)
    ‚îú‚îÄ‚îÄ Pytest (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    ‚îú‚îÄ‚îÄ Alembic (–º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î)
    ‚îî‚îÄ‚îÄ Poetry (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
```

### –ö–∞—Ä—å–µ—Ä–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è Python Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

```
–£—Ä–æ–≤–µ–Ω—å          –ó–∞—Ä–ø–ª–∞—Ç–∞*         –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ Trainee      $800-1500         –ò–∑—É—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤, –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏
‚îú‚îÄ‚îÄ Junior       $1500-3000        CRUD API, —Ä–∞–±–æ—Ç–∞ —Å –ë–î
‚îú‚îÄ‚îÄ Middle       $3000-5500        –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Senior       $5500-8500        –¢–µ—Ö–ª–∏–¥—Å—Ç–≤–æ, —Å–ª–æ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
‚îî‚îÄ‚îÄ Lead/Architect $8500+          –°—Ç—Ä–∞—Ç–µ–≥–∏—è, –º–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ

* –ó–∞—Ä–ø–ª–∞—Ç—ã —É–∫–∞–∑–∞–Ω—ã –¥–ª—è —Ä—ã–Ω–∫–∞ –°–ù–ì –≤ USD
```

---

## üìö –§–∞–∑–∞ 1: –û—Å–Ω–æ–≤—ã Python (4-6 –Ω–µ–¥–µ–ª—å)

### üéØ –¶–µ–ª–∏ —Ñ–∞–∑—ã:
- –û—Å–≤–æ–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python
- –ü–æ–Ω—è—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
- –ò–∑—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–∞—É—á–∏—Ç—å—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –º–æ–¥—É–ª—è–º–∏

---

## üìÖ –ù–µ–¥–µ–ª—è 1-2: –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –§–∏–ª–æ—Å–æ—Ñ–∏—è Python: Zen of Python

```python
import this
```

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–ª—è backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:**
1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ** - –∫–æ–¥ —á–∏—Ç–∞–µ—Ç—Å—è —á–∞—â–µ, —á–µ–º –ø–∏—à–µ—Ç—Å—è
2. **–ü—Ä–æ—Å—Ç–æ–µ –ª—É—á—à–µ —Å–ª–æ–∂–Ω–æ–≥–æ** - –∏–∑–±–µ–≥–∞–π—Ç–µ overengineering
3. **–ü–ª–æ—Å–∫–æ–µ –ª—É—á—à–µ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ** - –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–Ω–∏ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
4. **–Ø–≤–Ω–æ–µ –ª—É—á—à–µ –Ω–µ—è–≤–Ω–æ–≥–æ** - –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–º

### –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ backend

#### 1. –ß–∏—Å–ª–æ–≤—ã–µ —Ç–∏–ø—ã –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

```python
# –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Decimal –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
from decimal import Decimal

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –ø–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏
price = 19.99
tax_rate = 0.08
total = price * (1 + tax_rate)  # 21.589999999999996

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - —Ç–æ—á–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
price = Decimal('19.99')
tax_rate = Decimal('0.08')
total = price * (1 + tax_rate)  # 21.59

# –†–∞–±–æ—Ç–∞ —Å ID –∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏
user_id = 12345
page_number = 1
items_per_page = 20
offset = (page_number - 1) * items_per_page

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
def validate_pagination(page: int, limit: int) -> tuple[int, int]:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
    page = max(1, page)  # –ú–∏–Ω–∏–º—É–º 1
    limit = min(max(1, limit), 100)  # –û—Ç 1 –¥–æ 100
    offset = (page - 1) * limit
    return offset, limit
```

#### 2. –°—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```python
# URL –∏ –ø—É—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞
api_base = "https://api.example.com"
version = "v1"
endpoint = "users"
user_id = 123

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL
url = f"{api_base}/{version}/{endpoint}/{user_id}"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: https://api.example.com/v1/users/123

# –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
def clean_username(username: str) -> str:
    """–û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    cleaned = username.strip().lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    import re
    if not re.match(r'^[a-z0-9_]+$', cleaned):
        raise ValueError("Username —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã")
    
    return cleaned

# –†–∞–±–æ—Ç–∞ —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
email_template = """
–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {name}!

–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –Ω–∞—à–µ–º —Å–∞–π—Ç–µ.
–í–∞—à –ª–æ–≥–∏–Ω: {username}
–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {date}

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞
""".strip()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
formatted_email = email_template.format(
    name="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    username="ivan_petrov", 
    date="2024-01-15"
)
```

#### 3. –°–ø–∏—Å–∫–∏ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö

```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
users = [
    {"id": 1, "name": "Alice", "role": "admin", "active": True},
    {"id": 2, "name": "Bob", "role": "user", "active": True},
    {"id": 3, "name": "Charlie", "role": "user", "active": False},
    {"id": 4, "name": "Diana", "role": "moderator", "active": True}
]

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
active_users = [user for user in users if user["active"]]

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–º–µ–Ω
names = [user["name"] for user in users]

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–æ–ª—è–º
from collections import defaultdict

users_by_role = defaultdict(list)
for user in users:
    users_by_role[user["role"]].append(user)

# –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
sorted_users = sorted(users, key=lambda u: u["name"])

# –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞
def paginate_list(items: list, page: int, per_page: int) -> dict:
    """–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤"""
    total = len(items)
    start = (page - 1) * per_page
    end = start + per_page
    
    return {
        "items": items[start:end],
        "total": total,
        "page": page,
        "per_page": per_page,
        "pages": (total + per_page - 1) // per_page
    }

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
page_data = paginate_list(users, page=1, per_page=2)
```

#### 4. –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```python
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app_config = {
    "database": {
        "host": "localhost",
        "port": 5432,
        "name": "myapp",
        "user": "postgres"
    },
    "redis": {
        "host": "localhost", 
        "port": 6379,
        "db": 0
    },
    "api": {
        "host": "0.0.0.0",
        "port": 8000,
        "debug": False
    }
}

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
def get_nested_value(data: dict, path: str, default=None):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ø—É—Ç–∏ –≤–∏–¥–∞ 'database.host'"""
    keys = path.split('.')
    value = data
    
    for key in keys:
        if isinstance(value, dict) and key in value:
            value = value[key]
        else:
            return default
    
    return value

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
db_host = get_nested_value(app_config, "database.host", "localhost")
cache_ttl = get_nested_value(app_config, "cache.ttl", 3600)

# HTTP Response —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
def success_response(data, message="Success"):
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç"""
    return {
        "status": "success",
        "message": message,
        "data": data,
        "timestamp": datetime.now().isoformat()
    }

def error_response(message, code=400, details=None):
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π"""
    response = {
        "status": "error", 
        "message": message,
        "code": code,
        "timestamp": datetime.now().isoformat()
    }
    
    if details:
        response["details"] = details
        
    return response

# –ö—ç—à –≤ –ø–∞–º—è—Ç–∏ —Å TTL
class SimpleCache:
    def __init__(self):
        self._cache = {}
        self._expiry = {}
    
    def set(self, key: str, value, ttl: int = 3600):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å TTL –≤ —Å–µ–∫—É–Ω–¥–∞—Ö"""
        import time
        self._cache[key] = value
        self._expiry[key] = time.time() + ttl
    
    def get(self, key: str, default=None):
        """–ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∏–≤ TTL"""
        import time
        
        if key not in self._cache:
            return default
            
        if time.time() > self._expiry[key]:
            del self._cache[key]
            del self._expiry[key]
            return default
            
        return self._cache[key]
```

### –î–∏–∞–≥—Ä–∞–º–º–∞: –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö Python –≤ backend

```
Backend Data Structures Usage
‚îÇ
‚îú‚îÄ‚îÄ üìä –ß–∏—Å–ª–∞ (int, float, Decimal)
‚îÇ   ‚îú‚îÄ‚îÄ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–∞–ø–∏—Å–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ –°—á–µ—Ç—á–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏  
‚îÇ   ‚îú‚îÄ‚îÄ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã (Decimal)
‚îÇ   ‚îî‚îÄ‚îÄ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ (timestamp)
‚îÇ
‚îú‚îÄ‚îÄ üìù –°—Ç—Ä–æ–∫–∏ (str)
‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ URL –∏ –ø—É—Ç–∏ API
‚îÇ   ‚îú‚îÄ‚îÄ Email –∏ —à–∞–±–ª–æ–Ω—ã
‚îÇ   ‚îî‚îÄ‚îÄ JSON —Å—Ç—Ä–æ–∫–∏
‚îÇ
‚îú‚îÄ‚îÄ üìã –°–ø–∏—Å–∫–∏ (list)
‚îÇ   ‚îú‚îÄ‚îÄ –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –∑–∞–ø–∏—Å–µ–π –∏–∑ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ –°–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ –û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á
‚îÇ
‚îú‚îÄ‚îÄ üóÇÔ∏è –°–ª–æ–≤–∞—Ä–∏ (dict)
‚îÇ   ‚îú‚îÄ‚îÄ JSON –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ –ö—ç—à –∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ
‚îÇ
‚îî‚îÄ‚îÄ üîß –ú–Ω–æ–∂–µ—Å—Ç–≤–∞ (set)
    ‚îú‚îÄ‚îÄ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID
    ‚îú‚îÄ‚îÄ –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    ‚îú‚îÄ‚îÄ –¢–µ–≥–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    ‚îî‚îÄ‚îÄ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
```

---

## üìÖ –ù–µ–¥–µ–ª—è 3-4: –£–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏

### –£—Å–ª–æ–≤–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ backend –ª–æ–≥–∏–∫–µ

#### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

```python
from enum import Enum
from typing import Optional

class UserRole(Enum):
    ADMIN = "admin"
    MODERATOR = "moderator" 
    USER = "user"
    GUEST = "guest"

class Permission:
    def __init__(self, user_role: UserRole, resource: str, action: str):
        self.user_role = user_role
        self.resource = resource
        self.action = action
    
    def can_access(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"""
        
        # –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤—Å–µ
        if self.user_role == UserRole.ADMIN:
            return True
        
        # –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ —É–¥–∞–ª—è—Ç—å
        if self.user_role == UserRole.MODERATOR:
            if self.action in ["read", "update"]:
                return True
            elif self.action == "delete" and self.resource in ["comments", "posts"]:
                return True
            else:
                return False
        
        # –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
        if self.user_role == UserRole.USER:
            if self.action == "read":
                return True
            elif self.action in ["update", "delete"] and self.resource == "own_profile":
                return True
            else:
                return False
        
        # –ì–æ—Å—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if self.user_role == UserRole.GUEST:
            return self.action == "read" and self.resource in ["posts", "comments"]
        
        return False

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
def check_permission(user_role: str, resource: str, action: str) -> bool:
    permission = Permission(UserRole(user_role), resource, action)
    return permission.can_access()

# –ü—Ä–∏–º–µ—Ä—ã
print(check_permission("user", "own_profile", "update"))  # True
print(check_permission("user", "admin_panel", "read"))    # False
print(check_permission("moderator", "posts", "delete"))   # True
```

#### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```python
import re
from datetime import datetime, date
from typing import Union, List

class ValidationError(Exception):
    """–ö–∞—Å—Ç–æ–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    pass

class UserValidator:
    @staticmethod
    def validate_email(email: str) -> str:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è email –∞–¥—Ä–µ—Å–∞"""
        if not email:
            raise ValidationError("Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
        
        # –ü—Ä–æ—Å—Ç–∞—è regex –¥–ª—è email
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(pattern, email):
            raise ValidationError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email")
        
        return email.lower().strip()
    
    @staticmethod
    def validate_password(password: str) -> str:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è"""
        errors = []
        
        if len(password) < 8:
            errors.append("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤")
        
        if not re.search(r'[A-Z]', password):
            errors.append("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É")
        
        if not re.search(r'[a-z]', password):
            errors.append("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É")
        
        if not re.search(r'\d', password):
            errors.append("–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—É")
        
        if errors:
            raise ValidationError("; ".join(errors))
        
        return password
    
    @staticmethod
    def validate_age(birth_date: Union[str, date]) -> int:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è"""
        if isinstance(birth_date, str):
            try:
                birth_date = datetime.strptime(birth_date, "%Y-%m-%d").date()
            except ValueError:
                raise ValidationError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YYYY-MM-DD")
        
        today = date.today()
        age = today.year - birth_date.year - ((today.month, today.day) < (birth_date.month, birth_date.day))
        
        if age < 0:
            raise ValidationError("–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º")
        elif age < 13:
            raise ValidationError("–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: 13 –ª–µ—Ç")
        elif age > 120:
            raise ValidationError("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: 120 –ª–µ—Ç")
        
        return age

def validate_user_data(data: dict) -> dict:
    """–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    validated = {}
    errors = []
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è email
    try:
        validated['email'] = UserValidator.validate_email(data.get('email', ''))
    except ValidationError as e:
        errors.append(f"Email: {e}")
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
    try:
        validated['password'] = UserValidator.validate_password(data.get('password', ''))
    except ValidationError as e:
        errors.append(f"–ü–∞—Ä–æ–ª—å: {e}")
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
    try:
        validated['age'] = UserValidator.validate_age(data.get('birth_date', ''))
    except ValidationError as e:
        errors.append(f"–í–æ–∑—Ä–∞—Å—Ç: {e}")
    
    if errors:
        raise ValidationError("; ".join(errors))
    
    return validated
```

### –¶–∏–∫–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

#### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö

```python
from typing import Iterator, Dict, Any
import json

def process_users_batch(users: List[Dict]) -> Dict[str, Any]:
    """–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    stats = {
        "total": 0,
        "active": 0,
        "inactive": 0,
        "by_role": {},
        "errors": []
    }
    
    for user in users:
        stats["total"] += 1
        
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if not all(key in user for key in ['id', 'email', 'role']):
                stats["errors"].append(f"User {user.get('id', 'unknown')}: missing required fields")
                continue
            
            # –ü–æ–¥—Å—á–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É
            if user.get('is_active', False):
                stats["active"] += 1
            else:
                stats["inactive"] += 1
            
            # –ü–æ–¥—Å—á–µ—Ç –ø–æ —Ä–æ–ª—è–º
            role = user['role']
            stats["by_role"][role] = stats["by_role"].get(role, 0) + 1
            
        except Exception as e:
            stats["errors"].append(f"User {user.get('id', 'unknown')}: {str(e)}")
    
    return stats

# –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
def read_large_json_file(filename: str) -> Iterator[Dict]:
    """–ß—Ç–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ JSON —Ñ–∞–π–ª–∞ –ø–æ —á–∞—Å—Ç—è–º"""
    with open(filename, 'r', encoding='utf-8') as file:
        data = json.load(file)
        
        # –ï—Å–ª–∏ —ç—Ç–æ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if isinstance(data, list):
            for item in data:
                yield item
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        elif 'users' in data:
            for item in data['users']:
                yield item

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
def process_large_dataset(filename: str, batch_size: int = 1000):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –±–∞—Ç—á–∞–º–∏"""
    batch = []
    
    for user in read_large_json_file(filename):
        batch.append(user)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–∞
        if len(batch) >= batch_size:
            stats = process_users_batch(batch)
            print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω –±–∞—Ç—á: {stats['total']} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            batch = []  # –û—á–∏—â–∞–µ–º –±–∞—Ç—á
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–µ–ø–æ–ª–Ω–æ–≥–æ –±–∞—Ç—á–∞
    if batch:
        stats = process_users_batch(batch)
        print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞—Ç—á: {stats['total']} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
```

#### 2. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```python
from collections import defaultdict, Counter
from datetime import datetime, timedelta

def analyze_user_activity(logs: List[Dict]) -> Dict[str, Any]:
    """–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    user_stats = defaultdict(lambda: {
        "sessions": 0,
        "total_time": 0,
        "last_activity": None,
        "actions": Counter()
    })
    
    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º
    daily_stats = defaultdict(lambda: {
        "unique_users": set(),
        "total_sessions": 0,
        "popular_actions": Counter()
    })
    
    for log in logs:
        user_id = log['user_id']
        action = log['action']
        timestamp = datetime.fromisoformat(log['timestamp'])
        session_time = log.get('session_time', 0)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_stats[user_id]["sessions"] += 1
        user_stats[user_id]["total_time"] += session_time
        user_stats[user_id]["actions"][action] += 1
        
        if (user_stats[user_id]["last_activity"] is None or 
            timestamp > user_stats[user_id]["last_activity"]):
            user_stats[user_id]["last_activity"] = timestamp
        
        # –î–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        day_key = timestamp.date().isoformat()
        daily_stats[day_key]["unique_users"].add(user_id)
        daily_stats[day_key]["total_sessions"] += 1
        daily_stats[day_key]["popular_actions"][action] += 1
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    result = {
        "summary": {
            "total_users": len(user_stats),
            "total_sessions": sum(stats["sessions"] for stats in user_stats.values()),
            "avg_session_time": sum(stats["total_time"] for stats in user_stats.values()) / len(user_stats) if user_stats else 0
        },
        "top_users": [],
        "daily_breakdown": {}
    }
    
    # –¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    sorted_users = sorted(
        user_stats.items(), 
        key=lambda x: x[1]["sessions"], 
        reverse=True
    )
    
    for user_id, stats in sorted_users[:10]:  # –¢–æ–ø 10
        result["top_users"].append({
            "user_id": user_id,
            "sessions": stats["sessions"],
            "total_time": stats["total_time"],
            "last_activity": stats["last_activity"].isoformat() if stats["last_activity"] else None,
            "top_actions": dict(stats["actions"].most_common(3))
        })
    
    # –î–Ω–µ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    for day, stats in daily_stats.items():
        result["daily_breakdown"][day] = {
            "unique_users": len(stats["unique_users"]),
            "total_sessions": stats["total_sessions"],
            "top_actions": dict(stats["popular_actions"].most_common(5))
        }
    
    return result
```

### –§—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏

#### 1. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –¥–ª—è backend —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

```python
import time
import functools
from typing import Callable, Any

def timer(func: Callable) -> Callable:
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        print(f"{func.__name__} –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –∑–∞ {end_time - start_time:.4f} —Å–µ–∫—É–Ω–¥")
        return result
    return wrapper

def retry(max_attempts: int = 3, delay: float = 1.0):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫"""
    def decorator(func: Callable) -> Callable:
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            last_exception = None
            
            for attempt in range(max_attempts):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    last_exception = e
                    if attempt < max_attempts - 1:
                        print(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1} –Ω–µ—É–¥–∞—á–Ω–∞: {e}. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {delay} —Å–µ–∫...")
                        time.sleep(delay)
                    else:
                        print(f"–í—Å–µ {max_attempts} –ø–æ–ø—ã—Ç–æ–∫ –∏—Å—á–µ—Ä–ø–∞–Ω—ã")
            
            raise last_exception
        return wrapper
    return decorator

def cache_result(ttl: int = 300):
    """–ü—Ä–æ—Å—Ç–æ–π –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å TTL"""
    def decorator(func: Callable) -> Callable:
        cache = {}
        
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            # –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –∫—ç—à–∞
            cache_key = f"{func.__name__}:{hash(str(args) + str(sorted(kwargs.items())))}"
            current_time = time.time()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if cache_key in cache:
                result, timestamp = cache[cache_key]
                if current_time - timestamp < ttl:
                    print(f"Cache hit for {func.__name__}")
                    return result
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏ –∫—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = func(*args, **kwargs)
            cache[cache_key] = (result, current_time)
            print(f"Cache miss for {func.__name__}")
            return result
            
        return wrapper
    return decorator

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤
@timer
@retry(max_attempts=3, delay=2.0)
@cache_result(ttl=600)
def fetch_user_data(user_id: int) -> Dict[str, Any]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–Ω–µ—à–Ω–µ–≥–æ API"""
    import random
    
    # –°–∏–º—É–ª—è—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—à–∏–±–∫–∏
    if random.random() < 0.3:
        raise ConnectionError("–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏")
    
    # –°–∏–º—É–ª—è—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ API
    time.sleep(1)
    
    return {
        "id": user_id,
        "name": f"User {user_id}",
        "email": f"user{user_id}@example.com",
        "created_at": datetime.now().isoformat()
    }
```

#### 2. –§—É–Ω–∫—Ü–∏–∏ –≤—ã—Å—à–µ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```python
from typing import List, Callable, TypeVar, Optional

T = TypeVar('T')
U = TypeVar('U')

def pipeline(*functions: Callable) -> Callable:
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö"""
    def process(data):
        result = data
        for func in functions:
            result = func(result)
        return result
    return process

def filter_and_map(
    data: List[T], 
    filter_func: Callable[[T], bool], 
    map_func: Callable[[T], U]
) -> List[U]:
    """–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"""
    return [map_func(item) for item in data if filter_func(item)]

def reduce_with_key(
    data: List[T], 
    key_func: Callable[[T], str], 
    reduce_func: Callable[[List[T]], U]
) -> Dict[str, U]:
    """–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª—é—á—É –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è"""
    groups = {}
    
    for item in data:
        key = key_func(item)
        if key not in groups:
            groups[key] = []
        groups[key].append(item)
    
    return {key: reduce_func(items) for key, items in groups.items()}

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –∑–∞–∫–∞–∑–∞—Ö
orders = [
    {"id": 1, "user_id": 10, "amount": 100, "status": "completed", "date": "2024-01-01"},
    {"id": 2, "user_id": 11, "amount": 250, "status": "completed", "date": "2024-01-01"},
    {"id": 3, "user_id": 10, "amount": 75, "status": "pending", "date": "2024-01-02"},
    {"id": 4, "user_id": 12, "amount": 300, "status": "completed", "date": "2024-01-02"},
    {"id": 5, "user_id": 11, "amount": 150, "status": "cancelled", "date": "2024-01-03"},
]

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
def is_completed(order: Dict) -> bool:
    return order["status"] == "completed"

def extract_amount(order: Dict) -> float:
    return order["amount"]

def sum_amounts(orders: List[Dict]) -> float:
    return sum(order["amount"] for order in orders)

def get_user_id(order: Dict) -> str:
    return f"user_{order['user_id']}"

def get_date(order: Dict) -> str:
    return order["date"]

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
def process_completed_orders():
    # –¢–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã -> —Å—É–º–º—ã
    completed_amounts = filter_and_map(orders, is_completed, extract_amount)
    print(f"–°—É–º–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤: {completed_amounts}")
    
    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    revenue_by_user = reduce_with_key(
        [order for order in orders if is_completed(order)],
        get_user_id,
        sum_amounts
    )
    print(f"–í—ã—Ä—É—á–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º: {revenue_by_user}")
    
    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–Ω—è–º
    revenue_by_date = reduce_with_key(
        [order for order in orders if is_completed(order)],
        get_date,
        sum_amounts
    )
    print(f"–í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º: {revenue_by_date}")

process_completed_orders()
```

---

## üìÖ –ù–µ–¥–µ–ª—è 5-6: –û–û–ü –∏ —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏

### –û–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ backend

#### 1. –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∫ –∫–ª–∞—Å—Å—ã

```python
from datetime import datetime, date
from typing import Optional, List, Dict, Any
from enum import Enum
import hashlib
import json

class UserStatus(Enum):
    ACTIVE = "active"
    INACTIVE = "inactive"
    SUSPENDED = "suspended"
    DELETED = "deleted"

class User:
    """–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    def __init__(self, email: str, password: str, name: str, birth_date: date = None):
        self.id: Optional[int] = None
        self.email = email
        self._password_hash = self._hash_password(password)
        self.name = name
        self.birth_date = birth_date
        self.status = UserStatus.ACTIVE
        self.created_at = datetime.utcnow()
        self.updated_at = datetime.utcnow()
        self.last_login: Optional[datetime] = None
        self._login_attempts = 0
        self._is_locked = False
    
    @staticmethod
    def _hash_password(password: str) -> str:
        """–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
        return hashlib.sha256(password.encode()).hexdigest()
    
    def verify_password(self, password: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è"""
        if self._is_locked:
            raise ValueError("–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
        
        is_valid = self._password_hash == self._hash_password(password)
        
        if is_valid:
            self._login_attempts = 0
            self.last_login = datetime.utcnow()
        else:
            self._login_attempts += 1
            if self._login_attempts >= 5:
                self._is_locked = True
                raise ValueError("–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫")
        
        return is_valid
    
    def change_password(self, old_password: str, new_password: str):
        """–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è"""
        if not self.verify_password(old_password):
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å")
        
        self._password_hash = self._hash_password(new_password)
        self.updated_at = datetime.utcnow()
    
    def deactivate(self, reason: str = ""):
        """–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        self.status = UserStatus.INACTIVE
        self.updated_at = datetime.utcnow()
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        print(f"User {self.email} deactivated. Reason: {reason}")
    
    def to_dict(self, include_sensitive: bool = False) -> Dict[str, Any]:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–ª–æ–≤–∞—Ä—å"""
        data = {
            "id": self.id,
            "email": self.email,
            "name": self.name,
            "status": self.status.value,
            "created_at": self.created_at.isoformat(),
            "updated_at": self.updated_at.isoformat(),
            "last_login": self.last_login.isoformat() if self.last_login else None
        }
        
        if self.birth_date:
            data["birth_date"] = self.birth_date.isoformat()
        
        if include_sensitive:
            data["_login_attempts"] = self._login_attempts
            data["_is_locked"] = self._is_locked
        
        return data
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'User':
        """–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è"""
        user = cls.__new__(cls)  # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –±–µ–∑ –≤—ã–∑–æ–≤–∞ __init__
        
        user.id = data.get("id")
        user.email = data["email"]
        user._password_hash = data["password_hash"]
        user.name = data["name"]
        
        if "birth_date" in data and data["birth_date"]:
            user.birth_date = date.fromisoformat(data["birth_date"])
        else:
            user.birth_date = None
        
        user.status = UserStatus(data.get("status", "active"))
        user.created_at = datetime.fromisoformat(data["created_at"])
        user.updated_at = datetime.fromisoformat(data["updated_at"])
        
        if data.get("last_login"):
            user.last_login = datetime.fromisoformat(data["last_login"])
        else:
            user.last_login = None
        
        user._login_attempts = data.get("_login_attempts", 0)
        user._is_locked = data.get("_is_locked", False)
        
        return user
    
    def __str__(self) -> str:
        return f"User(id={self.id}, email={self.email}, status={self.status.value})"
    
    def __repr__(self) -> str:
        return (f"User(id={self.id}, email='{self.email}', name='{self.name}', "
                f"status={self.status.value}, created_at='{self.created_at}')")
```

#### 2. –ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

```python
class AdminUser(User):
    """–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏"""
    
    def __init__(self, email: str, password: str, name: str, department: str = "IT"):
        super().__init__(email, password, name)
        self.department = department
        self.admin_level = 1
        self.can_manage_users = True
        self.can_access_logs = True
    
    def promote_user(self, user: User, new_status: UserStatus):
        """–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if not self.can_manage_users:
            raise PermissionError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏")
        
        old_status = user.status
        user.status = new_status
        user.updated_at = datetime.utcnow()
        
        print(f"Admin {self.email} changed user {user.email} status from {old_status.value} to {new_status.value}")
    
    def view_user_details(self, user: User) -> Dict[str, Any]:
        """–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        if not self.can_access_logs:
            raise PermissionError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        
        return user.to_dict(include_sensitive=True)
    
    def to_dict(self, include_sensitive: bool = False) -> Dict[str, Any]:
        data = super().to_dict(include_sensitive)
        data.update({
            "department": self.department,
            "admin_level": self.admin_level,
            "can_manage_users": self.can_manage_users,
            "can_access_logs": self.can_access_logs,
            "user_type": "admin"
        })
        return data

class PremiumUser(User):
    """–ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏"""
    
    def __init__(self, email: str, password: str, name: str, subscription_plan: str = "basic"):
        super().__init__(email, password, name)
        self.subscription_plan = subscription_plan
        self.subscription_start = datetime.utcnow()
        self.subscription_end = None
        self.storage_limit_gb = self._get_storage_limit()
        self.api_rate_limit = self._get_api_rate_limit()
    
    def _get_storage_limit(self) -> int:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ —Ç–∞—Ä–∏—Ñ—É"""
        limits = {
            "basic": 10,
            "premium": 100,
            "enterprise": 1000
        }
        return limits.get(self.subscription_plan, 1)
    
    def _get_api_rate_limit(self) -> int:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —Ç–∞—Ä–∏—Ñ—É"""
        limits = {
            "basic": 1000,
            "premium": 10000,
            "enterprise": 100000
        }
        return limits.get(self.subscription_plan, 100)
    
    def upgrade_subscription(self, new_plan: str):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏"""
        if new_plan == self.subscription_plan:
            return
        
        old_plan = self.subscription_plan
        self.subscription_plan = new_plan
        self.storage_limit_gb = self._get_storage_limit()
        self.api_rate_limit = self._get_api_rate_limit()
        self.updated_at = datetime.utcnow()
        
        print(f"User {self.email} upgraded from {old_plan} to {new_plan}")
    
    def is_subscription_active(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
        if self.subscription_end is None:
            return True
        return datetime.utcnow() < self.subscription_end
    
    def to_dict(self, include_sensitive: bool = False) -> Dict[str, Any]:
        data = super().to_dict(include_sensitive)
        data.update({
            "subscription_plan": self.subscription_plan,
            "subscription_start": self.subscription_start.isoformat(),
            "subscription_end": self.subscription_end.isoformat() if self.subscription_end else None,
            "storage_limit_gb": self.storage_limit_gb,
            "api_rate_limit": self.api_rate_limit,
            "user_type": "premium"
        })
        return data
```

#### 3. –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```python
class UserManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    
    def __init__(self):
        self._users: Dict[int, User] = {}
        self._email_index: Dict[str, int] = {}
        self._next_id = 1
    
    def create_user(self, email: str, password: str, name: str, 
                   user_type: str = "regular", **kwargs) -> User:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
        if email in self._email_index:
            raise ValueError(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å email {email} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–∏–ø—É
        if user_type == "admin":
            user = AdminUser(email, password, name, kwargs.get("department", "IT"))
        elif user_type == "premium":
            user = PremiumUser(email, password, name, kwargs.get("subscription_plan", "basic"))
        else:
            user = User(email, password, name, kwargs.get("birth_date"))
        
        # –ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ ID –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        user.id = self._next_id
        self._users[user.id] = user
        self._email_index[email] = user.id
        self._next_id += 1
        
        print(f"–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user}")
        return user
    
    def get_user_by_id(self, user_id: int) -> Optional[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        return self._users.get(user_id)
    
    def get_user_by_email(self, email: str) -> Optional[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email"""
        user_id = self._email_index.get(email)
        return self._users.get(user_id) if user_id else None
    
    def authenticate(self, email: str, password: str) -> Optional[User]:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.get_user_by_email(email)
        if user and user.verify_password(password):
            return user
        return None
    
    def get_users_by_status(self, status: UserStatus) -> List[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å—É"""
        return [user for user in self._users.values() if user.status == status]
    
    def get_active_users(self, limit: int = None) -> List[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        active_users = self.get_users_by_status(UserStatus.ACTIVE)
        return active_users[:limit] if limit else active_users
    
    def get_statistics(self) -> Dict[str, Any]:
        """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        total_users = len(self._users)
        
        status_counts = {}
        type_counts = {"regular": 0, "admin": 0, "premium": 0}
        
        for user in self._users.values():
            # –ü–æ–¥—Å—á–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
            status = user.status.value
            status_counts[status] = status_counts.get(status, 0) + 1
            
            # –ü–æ–¥—Å—á–µ—Ç –ø–æ —Ç–∏–ø–∞–º
            if isinstance(user, AdminUser):
                type_counts["admin"] += 1
            elif isinstance(user, PremiumUser):
                type_counts["premium"] += 1
            else:
                type_counts["regular"] += 1
        
        return {
            "total_users": total_users,
            "by_status": status_counts,
            "by_type": type_counts,
            "last_created": max(self._users.values(), key=lambda u: u.created_at).created_at.isoformat() if self._users else None
        }
    
    def export_users(self, filename: str = "users_export.json"):
        """–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ JSON"""
        users_data = []
        for user in self._users.values():
            user_dict = user.to_dict()
            # –î–æ–±–∞–≤–ª—è–µ–º —Ö–µ—à –ø–∞—Ä–æ–ª—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            user_dict["password_hash"] = user._password_hash
            users_data.append(user_dict)
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(users_data, f, ensure_ascii=False, indent=2)
        
        print(f"–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {len(users_data)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ {filename}")
    
    def import_users(self, filename: str):
        """–ò–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ JSON"""
        with open(filename, 'r', encoding='utf-8') as f:
            users_data = json.load(f)
        
        imported_count = 0
        for user_data in users_data:
            try:
                user = User.from_dict(user_data)
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
                if user.email in self._email_index:
                    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.email} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                    continue
                
                # –ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ ID –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
                if user.id is None or user.id in self._users:
                    user.id = self._next_id
                    self._next_id += 1
                else:
                    self._next_id = max(self._next_id, user.id + 1)
                
                self._users[user.id] = user
                self._email_index[user.email] = user.id
                imported_count += 1
                
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        
        print(f"–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ {imported_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ {filename}")

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
def demo_user_management():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    
    manager = UserManager()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
    regular_user = manager.create_user("john@example.com", "password123", "John Doe")
    admin_user = manager.create_user("admin@example.com", "admin123", "Admin User", 
                                   user_type="admin", department="Security")
    premium_user = manager.create_user("premium@example.com", "premium123", "Premium User",
                                     user_type="premium", subscription_plan="enterprise")
    
    # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    authenticated = manager.authenticate("john@example.com", "password123")
    print(f"–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: {authenticated is not None}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = manager.get_statistics()
    print(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {stats}")
    
    # –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç
    manager.export_users("demo_users.json")
    
    return manager

# –ó–∞–ø—É—Å–∫ –¥–µ–º–æ
if __name__ == "__main__":
    demo_user_management()
```

### –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

#### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```python
import json
import yaml
import os
from pathlib import Path
from typing import Dict, Any, Optional
import configparser

class ConfigManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    
    def __init__(self, config_dir: str = "config"):
        self.config_dir = Path(config_dir)
        self.config_dir.mkdir(exist_ok=True)
        self._config_cache: Dict[str, Any] = {}
    
    def load_json_config(self, filename: str) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        config_path = self.config_dir / filename
        
        if not config_path.exists():
            print(f"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª {config_path} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return {}
        
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                config = json.load(f)
                self._config_cache[filename] = config
                return config
        except json.JSONDecodeError as e:
            print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –≤ {filename}: {e}")
            return {}
    
    def save_json_config(self, filename: str, config: Dict[str, Any]):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        config_path = self.config_dir / filename
        
        with open(config_path, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        
        self._config_cache[filename] = config
        print(f"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {config_path}")
    
    def load_yaml_config(self, filename: str) -> Dict[str, Any]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        config_path = self.config_dir / filename
        
        if not config_path.exists():
            print(f"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª {config_path} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return {}
        
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                config = yaml.safe_load(f)
                self._config_cache[filename] = config
                return config
        except yaml.YAMLError as e:
            print(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ YAML –≤ {filename}: {e}")
            return {}
    
    def load_env_config(self, filename: str = ".env") -> Dict[str, str]:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞"""
        config_path = self.config_dir / filename
        env_vars = {}
        
        if config_path.exists():
            with open(config_path, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        key, value = line.split('=', 1)
                        env_vars[key.strip()] = value.strip()
        
        return env_vars
    
    def get_database_config(self) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞
        db_config = self.load_json_config("database.json")
        
        # –ó–∞—Ç–µ–º –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        env_vars = self.load_env_config()
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        if "DATABASE_URL" in env_vars:
            # –ü–∞—Ä—Å–∏–Ω–≥ URL –≤–∏–¥–∞ postgresql://user:pass@host:port/db
            import re
            match = re.match(r'(\w+)://([^:]+):([^@]+)@([^:]+):(\d+)/(.+)', env_vars["DATABASE_URL"])
            if match:
                db_config.update({
                    "driver": match.group(1),
                    "user": match.group(2),
                    "password": match.group(3),
                    "host": match.group(4),
                    "port": int(match.group(5)),
                    "database": match.group(6)
                })
        
        # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        for env_key, config_key in [
            ("DB_HOST", "host"),
            ("DB_PORT", "port"),
            ("DB_NAME", "database"),
            ("DB_USER", "user"),
            ("DB_PASSWORD", "password")
        ]:
            if env_key in env_vars:
                db_config[config_key] = env_vars[env_key]
        
        return db_config
    
    def create_default_configs(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        
        # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
        default_db_config = {
            "driver": "postgresql",
            "host": "localhost",
            "port": 5432,
            "database": "myapp",
            "user": "postgres",
            "password": "password",
            "pool_size": 10,
            "max_overflow": 20
        }
        self.save_json_config("database.json", default_db_config)
        
        # Redis
        default_redis_config = {
            "host": "localhost",
            "port": 6379,
            "db": 0,
            "password": null,
            "socket_timeout": 30,
            "connection_pool_size": 10
        }
        self.save_json_config("redis.json", default_redis_config)
        
        # API —Å–µ—Ä–≤–µ—Ä
        default_api_config = {
            "host": "0.0.0.0",
            "port": 8000,
            "debug": false,
            "reload": false,
            "workers": 4,
            "cors": {
                "allowed_origins": ["*"],
                "allowed_methods": ["GET", "POST", "PUT", "DELETE"],
                "allowed_headers": ["*"]
            },
            "rate_limiting": {
                "enabled": true,
                "requests_per_minute": 60,
                "burst": 10
            }
        }
        self.save_json_config("api.json", default_api_config)
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        default_logging_config = {
            "version": 1,
            "disable_existing_loggers": false,
            "formatters": {
                "default": {
                    "format": "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
                },
                "json": {
                    "format": "{\"timestamp\":\"%(asctime)s\",\"logger\":\"%(name)s\",\"level\":\"%(levelname)s\",\"message\":\"%(message)s\"}"
                }
            },
            "handlers": {
                "console": {
                    "class": "logging.StreamHandler",
                    "level": "INFO",
                    "formatter": "default",
                    "stream": "ext://sys.stdout"
                },
                "file": {
                    "class": "logging.FileHandler",
                    "level": "DEBUG",
                    "formatter": "json",
                    "filename": "logs/app.log"
                }
            },
            "loggers": {
                "": {
                    "level": "INFO",
                    "handlers": ["console", "file"]
                }
            }
        }
        self.save_json_config("logging.json", default_logging_config)
        
        # .env —Ñ–∞–π–ª
        env_content = """# Database
DATABASE_URL=postgresql://postgres:password@localhost:5432/myapp
DB_HOST=localhost
DB_PORT=5432
DB_NAME=myapp
DB_USER=postgres
DB_PASSWORD=password

# Redis
REDIS_URL=redis://localhost:6379/0

# API
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=false
SECRET_KEY=your-secret-key-here

# External Services
EMAIL_SMTP_HOST=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your-email@gmail.com
EMAIL_PASSWORD=your-app-password

# Monitoring
SENTRY_DSN=your-sentry-dsn-here
ENABLE_METRICS=true
"""
        
        with open(self.config_dir / ".env", 'w', encoding='utf-8') as f:
            f.write(env_content)
        
        print("–°–æ–∑–¥–∞–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
```

#### 2. –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```python
import logging
import logging.config
from pathlib import Path
import json
from datetime import datetime
from typing import Dict, Any

class LogManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    def __init__(self, config_manager: ConfigManager):
        self.config_manager = config_manager
        self.logs_dir = Path("logs")
        self.logs_dir.mkdir(exist_ok=True)
        self._setup_logging()
    
    def _setup_logging(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
        logging_config = self.config_manager.load_json_config("logging.json")
        
        if logging_config:
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥ —Ñ–∞–π–ª–æ–≤
            for handler_name, handler_config in logging_config.get("handlers", {}).items():
                if "filename" in handler_config:
                    log_file = Path(handler_config["filename"])
                    log_file.parent.mkdir(parents=True, exist_ok=True)
            
            logging.config.dictConfig(logging_config)
        else:
            # –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            logging.basicConfig(
                level=logging.INFO,
                format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                handlers=[
                    logging.StreamHandler(),
                    logging.FileHandler(self.logs_dir / "app.log")
                ]
            )
    
    def get_logger(self, name: str) -> logging.Logger:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–≥–µ—Ä–∞ –ø–æ –∏–º–µ–Ω–∏"""
        return logging.getLogger(name)
    
    def log_api_request(self, method: str, path: str, user_id: int = None, 
                       ip_address: str = None, response_code: int = None,
                       response_time: float = None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å–∞"""
        logger = self.get_logger("api.requests")
        
        log_data = {
            "method": method,
            "path": path,
            "user_id": user_id,
            "ip_address": ip_address,
            "response_code": response_code,
            "response_time": response_time,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        level = logging.INFO
        if response_code and response_code >= 400:
            level = logging.WARNING if response_code < 500 else logging.ERROR
        
        logger.log(level, json.dumps(log_data))
    
    def log_database_query(self, query: str, duration: float, 
                          rows_affected: int = None, error: str = None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
        logger = self.get_logger("database.queries")
        
        log_data = {
            "query": query[:200] + "..." if len(query) > 200 else query,
            "duration": duration,
            "rows_affected": rows_affected,
            "error": error,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        level = logging.INFO if error is None else logging.ERROR
        logger.log(level, json.dumps(log_data))
    
    def log_user_action(self, user_id: int, action: str, details: Dict[str, Any] = None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        logger = self.get_logger("user.actions")
        
        log_data = {
            "user_id": user_id,
            "action": action,
            "details": details or {},
            "timestamp": datetime.utcnow().isoformat()
        }
        
        logger.info(json.dumps(log_data))
    
    def analyze_logs(self, log_file: str = "logs/app.log") -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑ –ª–æ–≥ —Ñ–∞–π–ª–æ–≤"""
        if not Path(log_file).exists():
            return {"error": "Log file not found"}
        
        stats = {
            "total_lines": 0,
            "by_level": {},
            "by_logger": {},
            "errors": [],
            "api_requests": {
                "total": 0,
                "by_status": {},
                "by_method": {}
            }
        }
        
        with open(log_file, 'r', encoding='utf-8') as f:
            for line in f:
                stats["total_lines"] += 1
                
                try:
                    # –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –ª–æ–≥–∞
                    if line.strip().startswith('{'):
                        log_entry = json.loads(line.strip())
                        
                        # API –∑–∞–ø—Ä–æ—Å—ã
                        if "method" in log_entry and "path" in log_entry:
                            stats["api_requests"]["total"] += 1
                            
                            method = log_entry["method"]
                            stats["api_requests"]["by_method"][method] = \
                                stats["api_requests"]["by_method"].get(method, 0) + 1
                            
                            if "response_code" in log_entry:
                                code = log_entry["response_code"]
                                stats["api_requests"]["by_status"][code] = \
                                    stats["api_requests"]["by_status"].get(code, 0) + 1
                    
                    # –û–±—ã—á–Ω—ã–µ –ª–æ–≥–∏
                    else:
                        # –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤
                        if " - " in line:
                            parts = line.split(" - ")
                            if len(parts) >= 3:
                                level = parts[2].strip()
                                stats["by_level"][level] = stats["by_level"].get(level, 0) + 1
                                
                                logger_name = parts[1].strip()
                                stats["by_logger"][logger_name] = stats["by_logger"].get(logger_name, 0) + 1
                                
                                if level in ["ERROR", "CRITICAL"]:
                                    stats["errors"].append({
                                        "timestamp": parts[0].strip(),
                                        "logger": logger_name,
                                        "level": level,
                                        "message": " - ".join(parts[3:]).strip()
                                    })
                
                except Exception as e:
                    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
                    pass
        
        return stats

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã —Ñ–∞–π–ª–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
def demo_file_management():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"""
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    config_manager = ConfigManager()
    log_manager = LogManager(config_manager)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    config_manager.create_default_configs()
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ë–î
    db_config = config_manager.get_database_config()
    print(f"Database config: {db_config}")
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    logger = log_manager.get_logger("demo")
    logger.info("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è")
    
    log_manager.log_api_request("GET", "/api/users", user_id=123, response_code=200, response_time=0.045)
    log_manager.log_user_action(123, "login", {"ip": "192.168.1.1", "user_agent": "Mozilla/5.0"})
    
    # –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
    log_stats = log_manager.analyze_logs()
    print(f"Log statistics: {log_stats}")

if __name__ == "__main__":
    demo_file_management()

---

## üìö –§–∞–∑–∞ 2: Backend-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (6-8 –Ω–µ–¥–µ–ª—å)

### üéØ –¶–µ–ª–∏ —Ñ–∞–∑—ã:
- –ü–æ–Ω—è—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—ã HTTP –∏ REST API
- –û—Å–≤–æ–∏—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ (FastAPI)
- –ò–∑—É—á–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ ORM
- –í–Ω–µ–¥—Ä–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

---

## üìÖ –ù–µ–¥–µ–ª—è 7-8: HTTP –∏ –≤–µ–±-–æ—Å–Ω–æ–≤—ã

### –ü—Ä–æ—Ç–æ–∫–æ–ª HTTP: —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

#### –ê–Ω–∞—Ç–æ–º–∏—è HTTP –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞

```
HTTP Request Structure:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ GET /api/users/123 HTTP/1.1         ‚îÇ ‚Üê Request Line
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Host: api.example.com               ‚îÇ
‚îÇ Authorization: Bearer eyJ0eXAi...   ‚îÇ ‚Üê Headers
‚îÇ Content-Type: application/json      ‚îÇ
‚îÇ User-Agent: MyApp/1.0               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ ‚Üê Empty line
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ {"filter": "active"}                ‚îÇ ‚Üê Body (optional)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

HTTP Response Structure:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HTTP/1.1 200 OK                     ‚îÇ ‚Üê Status Line
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Content-Type: application/json      ‚îÇ
‚îÇ Content-Length: 156                 ‚îÇ ‚Üê Headers
‚îÇ Cache-Control: max-age=300          ‚îÇ
‚îÇ X-Rate-Limit: 1000                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                     ‚îÇ ‚Üê Empty line
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ {"id": 123, "name": "John"}         ‚îÇ ‚Üê Body
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### HTTP –º–µ—Ç–æ–¥—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–π

```python
class HTTPMethodHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ HTTP –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π"""
    
    def __init__(self):
        self.users_db = {}  # –ò–º–∏—Ç–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        self.next_id = 1
    
    def handle_get(self, path: str, query_params: dict = None) -> tuple[dict, int]:
        """
        GET - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (READ)
        –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥
        """
        if path == "/users":
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
            users = list(self.users_db.values())
            
            if query_params:
                # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
                if "status" in query_params:
                    users = [u for u in users if u.get("status") == query_params["status"]]
                
                # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
                if "page" in query_params and "limit" in query_params:
                    page = int(query_params["page"])
                    limit = int(query_params["limit"])
                    start = (page - 1) * limit
                    users = users[start:start + limit]
            
            return {
                "users": users,
                "total": len(self.users_db),
                "page": query_params.get("page", 1) if query_params else 1
            }, 200
        
        elif path.startswith("/users/"):
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_id = int(path.split("/")[-1])
            user = self.users_db.get(user_id)
            
            if user:
                return {"user": user}, 200
            else:
                return {"error": "User not found"}, 404
        
        else:
            return {"error": "Not found"}, 404
    
    def handle_post(self, path: str, data: dict) -> tuple[dict, int]:
        """
        POST - –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ (CREATE)
        –ù–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –º–µ—Ç–æ–¥
        """
        if path == "/users":
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            required_fields = ["name", "email"]
            for field in required_fields:
                if field not in data:
                    return {"error": f"Missing required field: {field}"}, 400
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
            for user in self.users_db.values():
                if user["email"] == data["email"]:
                    return {"error": "Email already exists"}, 409
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user = {
                "id": self.next_id,
                "name": data["name"],
                "email": data["email"],
                "status": data.get("status", "active"),
                "created_at": datetime.now().isoformat()
            }
            
            self.users_db[self.next_id] = user
            self.next_id += 1
            
            return {"user": user, "message": "User created successfully"}, 201
        
        else:
            return {"error": "Method not allowed"}, 405
    
    def handle_put(self, path: str, data: dict) -> tuple[dict, int]:
        """
        PUT - –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ (UPDATE)
        –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –º–µ—Ç–æ–¥
        """
        if path.startswith("/users/"):
            user_id = int(path.split("/")[-1])
            
            if user_id not in self.users_db:
                return {"error": "User not found"}, 404
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            required_fields = ["name", "email", "status"]
            for field in required_fields:
                if field not in data:
                    return {"error": f"Missing required field: {field}"}, 400
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email (–∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
            for uid, user in self.users_db.items():
                if uid != user_id and user["email"] == data["email"]:
                    return {"error": "Email already exists"}, 409
            
            # –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updated_user = {
                "id": user_id,
                "name": data["name"],
                "email": data["email"],
                "status": data["status"],
                "created_at": self.users_db[user_id]["created_at"],
                "updated_at": datetime.now().isoformat()
            }
            
            self.users_db[user_id] = updated_user
            
            return {"user": updated_user, "message": "User updated successfully"}, 200
        
        else:
            return {"error": "Method not allowed"}, 405
    
    def handle_patch(self, path: str, data: dict) -> tuple[dict, int]:
        """
        PATCH - –ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞
        –ù–µ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –º–µ—Ç–æ–¥
        """
        if path.startswith("/users/"):
            user_id = int(path.split("/")[-1])
            
            if user_id not in self.users_db:
                return {"error": "User not found"}, 404
            
            user = self.users_db[user_id].copy()
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ email –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
            if "email" in data:
                for uid, existing_user in self.users_db.items():
                    if uid != user_id and existing_user["email"] == data["email"]:
                        return {"error": "Email already exists"}, 409
            
            # –ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            for key, value in data.items():
                if key in ["name", "email", "status"]:
                    user[key] = value
            
            user["updated_at"] = datetime.now().isoformat()
            self.users_db[user_id] = user
            
            return {"user": user, "message": "User updated successfully"}, 200
        
        else:
            return {"error": "Method not allowed"}, 405
    
    def handle_delete(self, path: str) -> tuple[dict, int]:
        """
        DELETE - –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞
        –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –º–µ—Ç–æ–¥
        """
        if path.startswith("/users/"):
            user_id = int(path.split("/")[-1])
            
            if user_id not in self.users_db:
                # –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –æ—à–∏–±–∫–∞
                return {"message": "User already deleted"}, 200
            
            deleted_user = self.users_db.pop(user_id)
            
            return {
                "message": "User deleted successfully",
                "deleted_user": deleted_user
            }, 200
        
        else:
            return {"error": "Method not allowed"}, 405

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å HTTP –º–µ—Ç–æ–¥–∞–º–∏
def demo_http_methods():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP –º–µ—Ç–æ–¥–æ–≤"""
    
    handler = HTTPMethodHandler()
    
    print("=== HTTP Methods Demo ===\n")
    
    # POST - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    print("1. POST /users - –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    response, status = handler.handle_post("/users", {
        "name": "Alice Smith",
        "email": "alice@example.com"
    })
    print(f"Status: {status}, Response: {response}\n")
    
    response, status = handler.handle_post("/users", {
        "name": "Bob Johnson", 
        "email": "bob@example.com",
        "status": "inactive"
    })
    print(f"Status: {status}, Response: {response}\n")
    
    # GET - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    print("2. GET /users - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    response, status = handler.handle_get("/users")
    print(f"Status: {status}, Response: {response}\n")
    
    print("3. GET /users/1 - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    response, status = handler.handle_get("/users/1")
    print(f"Status: {status}, Response: {response}\n")
    
    # PUT - –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    print("4. PUT /users/1 - –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    response, status = handler.handle_put("/users/1", {
        "name": "Alice Cooper",
        "email": "alice.cooper@example.com",
        "status": "active"
    })
    print(f"Status: {status}, Response: {response}\n")
    
    # PATCH - —á–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    print("5. PATCH /users/2 - –ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    response, status = handler.handle_patch("/users/2", {
        "status": "active"
    })
    print(f"Status: {status}, Response: {response}\n")
    
    # DELETE - —É–¥–∞–ª–µ–Ω–∏–µ
    print("6. DELETE /users/2 - –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    response, status = handler.handle_delete("/users/2")
    print(f"Status: {status}, Response: {response}\n")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ DELETE
    print("7. DELETE /users/2 - –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)")
    response, status = handler.handle_delete("/users/2")
    print(f"Status: {status}, Response: {response}\n")

if __name__ == "__main__":
    demo_http_methods()
```

#### –ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP

```python
from enum import IntEnum

class HTTPStatus(IntEnum):
    """–ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è HTTP —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏"""
    
    # 2xx Success
    OK = 200                    # GET: –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    CREATED = 201              # POST: –†–µ—Å—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω
    ACCEPTED = 202             # –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç, –Ω–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    NO_CONTENT = 204           # DELETE: –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ, –Ω–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    
    # 3xx Redirection
    MOVED_PERMANENTLY = 301    # –†–µ—Å—É—Ä—Å –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞
    FOUND = 302               # –í—Ä–µ–º–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    NOT_MODIFIED = 304        # –†–µ—Å—É—Ä—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
    
    # 4xx Client Error
    BAD_REQUEST = 400         # –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
    UNAUTHORIZED = 401        # –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    FORBIDDEN = 403           # –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
    NOT_FOUND = 404           # –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
    METHOD_NOT_ALLOWED = 405  # –ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
    CONFLICT = 409            # –ö–æ–Ω—Ñ–ª–∏–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
    UNPROCESSABLE_ENTITY = 422 # –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    TOO_MANY_REQUESTS = 429   # –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
    
    # 5xx Server Error
    INTERNAL_SERVER_ERROR = 500 # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    BAD_GATEWAY = 502          # –û—à–∏–±–∫–∞ —à–ª—é–∑–∞
    SERVICE_UNAVAILABLE = 503  # –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    GATEWAY_TIMEOUT = 504      # –¢–∞–π–º–∞—É—Ç —à–ª—é–∑–∞

class APIResponseBuilder:
    """–°—Ç—Ä–æ–∏—Ç–µ–ª—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö API –æ—Ç–≤–µ—Ç–æ–≤"""
    
    @staticmethod
    def success(data=None, message="Success", status_code=HTTPStatus.OK):
        """–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç"""
        response = {
            "status": "success",
            "message": message,
            "timestamp": datetime.now().isoformat()
        }
        
        if data is not None:
            response["data"] = data
        
        return response, status_code
    
    @staticmethod
    def error(message, status_code=HTTPStatus.BAD_REQUEST, details=None, error_code=None):
        """–û—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π"""
        response = {
            "status": "error",
            "message": message,
            "timestamp": datetime.now().isoformat()
        }
        
        if error_code:
            response["error_code"] = error_code
        
        if details:
            response["details"] = details
        
        return response, status_code
    
    @staticmethod
    def validation_error(errors: dict, message="Validation failed"):
        """–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        return APIResponseBuilder.error(
            message=message,
            status_code=HTTPStatus.UNPROCESSABLE_ENTITY,
            details={"validation_errors": errors}
        )
    
    @staticmethod
    def not_found(resource="Resource", resource_id=None):
        """–†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"""
        message = f"{resource} not found"
        if resource_id:
            message += f" (ID: {resource_id})"
        
        return APIResponseBuilder.error(
            message=message,
            status_code=HTTPStatus.NOT_FOUND,
            error_code="RESOURCE_NOT_FOUND"
        )
    
    @staticmethod
    def conflict(message, conflicting_field=None):
        """–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–µ—Å—É—Ä—Å–æ–≤"""
        details = {}
        if conflicting_field:
            details["conflicting_field"] = conflicting_field
        
        return APIResponseBuilder.error(
            message=message,
            status_code=HTTPStatus.CONFLICT,
            error_code="RESOURCE_CONFLICT",
            details=details if details else None
        )

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
def demo_api_responses():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö API –æ—Ç–≤–µ—Ç–æ–≤"""
    
    print("=== API Response Standards Demo ===\n")
    
    # –£—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    print("1. –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:")
    response, status = APIResponseBuilder.success(
        data={"id": 1, "name": "John Doe"},
        message="User retrieved successfully"
    )
    print(f"Status: {status}\nResponse: {json.dumps(response, indent=2)}\n")
    
    print("2. –£—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ:")
    response, status = APIResponseBuilder.success(
        data={"id": 2, "name": "Jane Smith"},
        message="User created successfully",
        status_code=HTTPStatus.CREATED
    )
    print(f"Status: {status}\nResponse: {json.dumps(response, indent=2)}\n")
    
    # –û—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
    print("3. –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:")
    response, status = APIResponseBuilder.validation_error({
        "email": "Invalid email format",
        "age": "Must be between 18 and 100"
    })
    print(f"Status: {status}\nResponse: {json.dumps(response, indent=2)}\n")
    
    print("4. –†–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω:")
    response, status = APIResponseBuilder.not_found("User", 999)
    print(f"Status: {status}\nResponse: {json.dumps(response, indent=2)}\n")
    
    print("5. –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–µ—Å—É—Ä—Å–æ–≤:")
    response, status = APIResponseBuilder.conflict(
        "Email already exists",
        conflicting_field="email"
    )
    print(f"Status: {status}\nResponse: {json.dumps(response, indent=2)}\n")

if __name__ == "__main__":
    demo_api_responses()
```

### REST –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã API –¥–∏–∑–∞–π–Ω–∞

#### 6 –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ REST

```
REST Architectural Constraints:
‚îÇ
‚îú‚îÄ‚îÄ 1. üîÑ Client-Server
‚îÇ   ‚îî‚îÄ‚îÄ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º
‚îÇ
‚îú‚îÄ‚îÄ 2. üö´ Stateless  
‚îÇ   ‚îî‚îÄ‚îÄ –°–µ—Ä–≤–µ—Ä –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
‚îÇ
‚îú‚îÄ‚îÄ 3. üíæ Cacheable
‚îÇ   ‚îî‚îÄ‚îÄ –û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —è–≤–Ω–æ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –∫–µ—à–∏—Ä—É–µ–º—ã–µ –∏–ª–∏ –Ω–µ—Ç
‚îÇ
‚îú‚îÄ‚îÄ 4. üèóÔ∏è Layered System
‚îÇ   ‚îî‚îÄ‚îÄ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö —Å–ª–æ–µ–≤
‚îÇ
‚îú‚îÄ‚îÄ 5. üìù Code on Demand (optional)
‚îÇ   ‚îî‚îÄ‚îÄ –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –∫–æ–¥ –∫–ª–∏–µ–Ω—Ç—É
‚îÇ
‚îî‚îÄ‚îÄ 6. üîó Uniform Interface
    ‚îú‚îÄ‚îÄ Resource identification (URI)
    ‚îú‚îÄ‚îÄ Resource manipulation through representations
    ‚îú‚îÄ‚îÄ Self-descriptive messages  
    ‚îî‚îÄ‚îÄ HATEOAS (Hypermedia as the Engine of Application State)
```

#### –î–∏–∑–∞–π–Ω RESTful API

```python
class RESTfulAPIDesign:
    """–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–µ–≥–æ –¥–∏–∑–∞–π–Ω–∞ RESTful API"""
    
    def __init__(self):
        self.base_url = "https://api.example.com/v1"
    
    def get_resource_urls(self):
        """–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤"""
        return {
            # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ
            "users": f"{self.base_url}/users",
            "posts": f"{self.base_url}/posts", 
            "comments": f"{self.base_url}/comments",
            "categories": f"{self.base_url}/categories",
            
            # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: –≥–ª–∞–≥–æ–ª—ã, –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ
            # "getUser": f"{self.base_url}/getUser",
            # "user": f"{self.base_url}/user",
            # "createPost": f"{self.base_url}/createPost"
        }
    
    def get_endpoint_examples(self):
        """–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤"""
        return {
            # –ö–æ–ª–ª–µ–∫—Ü–∏–∏
            "GET /users": "–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            "POST /users": "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
            
            # –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
            "GET /users/123": "–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID 123",
            "PUT /users/123": "–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123",
            "PATCH /users/123": "–ß–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123", 
            "DELETE /users/123": "–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123",
            
            # –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
            "GET /users/123/posts": "–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123",
            "POST /users/123/posts": "–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123",
            "GET /users/123/posts/456": "–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç 456 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123",
            
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
            "GET /users?status=active": "–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            "GET /users?role=admin&limit=10": "–ü–µ—Ä–≤—ã–µ 10 –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤",
            "GET /posts?author=123&published=true": "–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∞ 123",
            
            # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            "GET /users?page=2&limit=20": "–í—Ç–æ—Ä–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ 20 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
            "GET /posts?offset=40&limit=20": "–ü–æ—Å—Ç—ã —Å 41 –ø–æ 60",
            
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            "GET /users?sort=created_at": "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è",
            "GET /posts?sort=-published_at,title": "–ü–æ –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É–±—ã–≤., –ø–æ—Ç–æ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é",
        }

class HATEOASExample:
    """–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ HATEOAS"""
    
    def get_user_with_links(self, user_id: int):
        """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏"""
        user = {
            "id": user_id,
            "name": "John Doe",
            "email": "john@example.com",
            "status": "active",
            "_links": {
                "self": {"href": f"/users/{user_id}"},
                "edit": {"href": f"/users/{user_id}", "method": "PUT"},
                "delete": {"href": f"/users/{user_id}", "method": "DELETE"},
                "posts": {"href": f"/users/{user_id}/posts"},
                "avatar": {"href": f"/users/{user_id}/avatar"},
                "deactivate": {
                    "href": f"/users/{user_id}/deactivate",
                    "method": "POST",
                    "condition": "status == 'active'"
                }
            }
        }
        
        return user
    
    def get_posts_collection_with_links(self, page=1, limit=10):
        """–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–æ—Å—Ç–æ–≤ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π"""
        posts = [
            {"id": 1, "title": "First Post", "author_id": 123},
            {"id": 2, "title": "Second Post", "author_id": 124}
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –∫ –∫–∞–∂–¥–æ–º—É –ø–æ—Å—Ç—É
        for post in posts:
            post["_links"] = {
                "self": {"href": f"/posts/{post['id']}"},
                "author": {"href": f"/users/{post['author_id']}"},
                "comments": {"href": f"/posts/{post['id']}/comments"},
                "edit": {"href": f"/posts/{post['id']}", "method": "PUT"},
                "delete": {"href": f"/posts/{post['id']}", "method": "DELETE"}
            }
        
        # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        collection = {
            "posts": posts,
            "pagination": {
                "page": page,
                "limit": limit,
                "total": 50,
                "pages": 5
            },
            "_links": {
                "self": {"href": f"/posts?page={page}&limit={limit}"},
                "first": {"href": f"/posts?page=1&limit={limit}"},
                "last": {"href": f"/posts?page=5&limit={limit}"},
                "create": {"href": "/posts", "method": "POST"}
            }
        }
        
        # –£—Å–ª–æ–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏
        if page > 1:
            collection["_links"]["prev"] = {"href": f"/posts?page={page-1}&limit={limit}"}
        
        if page < 5:
            collection["_links"]["next"] = {"href": f"/posts?page={page+1}&limit={limit}"}
        
        return collection

# –í–∞–ª–∏–¥–∞—Ü–∏—è API –¥–∏–∑–∞–π–Ω–∞
class APIDesignValidator:
    """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∏–∑–∞–π–Ω–∞ API"""
    
    def __init__(self):
        self.common_mistakes = {
            "verbs_in_urls": [
                "getUsers", "createUser", "updateUser", "deleteUser",
                "fetchPosts", "addComment", "removeTag"
            ],
            "singular_resources": [
                "user", "post", "comment", "category", "tag"
            ],
            "non_standard_methods": [
                "PATCH /users/123/activate",  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å POST
                "GET /users/create",          # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å GET /users/new (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ñ–æ—Ä–º–∞)
                "POST /users/123/delete"      # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å DELETE /users/123
            ]
        }
    
    def validate_endpoint(self, method: str, path: str) -> dict:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ REST –ø—Ä–∏–Ω—Ü–∏–ø–∞–º"""
        issues = []
        suggestions = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥–ª–∞–≥–æ–ª—ã –≤ URL
        path_parts = path.strip('/').split('/')
        for part in path_parts:
            if part in self.common_mistakes["verbs_in_urls"]:
                issues.append(f"–ì–ª–∞–≥–æ–ª '{part}' –≤ URL –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—ã REST")
                suggestions.append(f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTP –º–µ—Ç–æ–¥ –≤–º–µ—Å—Ç–æ '{part}' –≤ URL")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤
        if len(path_parts) > 0:
            resource = path_parts[0]
            if resource in self.common_mistakes["singular_resources"]:
                issues.append(f"–†–µ—Å—É—Ä—Å '{resource}' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ")
                suggestions.append(f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ '{resource}s' –≤–º–µ—Å—Ç–æ '{resource}'")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ—Ç–æ–¥–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è
        if method == "GET" and any(action in path for action in ["create", "add", "update", "delete"]):
            issues.append("GET –∑–∞–ø—Ä–æ—Å –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è")
            suggestions.append("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ POST/PUT/PATCH/DELETE –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
        if len(path_parts) > 4:
            issues.append("–°–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å —Ä–µ—Å—É—Ä—Å–æ–≤")
            suggestions.append("–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–æ—â–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã")
        
        return {
            "endpoint": f"{method} {path}",
            "is_valid": len(issues) == 0,
            "issues": issues,
            "suggestions": suggestions
        }
    
    def suggest_improvements(self, endpoints: list) -> dict:
        """–ê–Ω–∞–ª–∏–∑ —Å–ø–∏—Å–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —É–ª—É—á—à–µ–Ω–∏–π"""
        results = []
        
        for method, path in endpoints:
            validation = self.validate_endpoint(method, path)
            results.append(validation)
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        total = len(results)
        valid = len([r for r in results if r["is_valid"]])
        
        return {
            "summary": {
                "total_endpoints": total,
                "valid_endpoints": valid,
                "invalid_endpoints": total - valid,
                "compliance_rate": f"{(valid/total)*100:.1f}%" if total > 0 else "0%"
            },
            "detailed_results": results
        }

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–∞ API
def demo_api_design():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –¥–∏–∑–∞–π–Ω–∞ RESTful API"""
    
    print("=== RESTful API Design Demo ===\n")
    
    # –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–µ–≥–æ –¥–∏–∑–∞–π–Ω–∞
    design = RESTfulAPIDesign()
    print("1. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL —Ä–µ—Å—É—Ä—Å–æ–≤:")
    for name, url in design.get_resource_urls().items():
        print(f"   {name}: {url}")
    print()
    
    print("2. –ü—Ä–∏–º–µ—Ä—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤:")
    for endpoint, description in design.get_endpoint_examples().items():
        print(f"   {endpoint:<30} - {description}")
    print()
    
    # HATEOAS –ø—Ä–∏–º–µ—Ä
    hateoas = HATEOASExample()
    print("3. HATEOAS - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏:")
    user = hateoas.get_user_with_links(123)
    print(json.dumps(user, indent=2))
    print()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–∞
    validator = APIDesignValidator()
    test_endpoints = [
        ("GET", "/users"),           # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
        ("POST", "/users"),          # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ  
        ("GET", "/getUsers"),        # ‚ùå –ì–ª–∞–≥–æ–ª –≤ URL
        ("POST", "/user"),           # ‚ùå –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ
        ("GET", "/users/123/posts/456/comments/789/likes")  # ‚ùå –°–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ
    ]
    
    print("4. –í–∞–ª–∏–¥–∞—Ü–∏—è API –¥–∏–∑–∞–π–Ω–∞:")
    analysis = validator.suggest_improvements(test_endpoints)
    
    print(f"–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {analysis['summary']}")
    print("\n–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:")
    for result in analysis['detailed_results']:
        print(f"  {result['endpoint']}: {'‚úÖ' if result['is_valid'] else '‚ùå'}")
        for issue in result['issues']:
            print(f"    ‚ö†Ô∏è {issue}")
        for suggestion in result['suggestions']:
            print(f"    üí° {suggestion}")
        print()

if __name__ == "__main__":
    demo_api_design()
```

---

## üìÖ –ù–µ–¥–µ–ª—è 9-11: –í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ - FastAPI

### –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å FastAPI

#### –ü–æ—á–µ–º—É FastAPI?

```
FastAPI Advantages:
‚îÇ
‚îú‚îÄ‚îÄ ‚ö° Performance
‚îÇ   ‚îú‚îÄ‚îÄ –û–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö Python —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ Starlette (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å)
‚îÇ   ‚îî‚îÄ‚îÄ Pydantic –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (C extensions)
‚îÇ
‚îú‚îÄ‚îÄ üõ†Ô∏è Developer Experience  
‚îÇ   ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (Swagger/OpenAPI)
‚îÇ   ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –≤ IDE –±–ª–∞–≥–æ–¥–∞—Ä—è —Ç–∏–ø–∞–º
‚îÇ   ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îî‚îÄ‚îÄ –ú–∏–Ω–∏–º—É–º boilerplate –∫–æ–¥–∞
‚îÇ
‚îú‚îÄ‚îÄ üîÑ Modern Python
‚îÇ   ‚îú‚îÄ‚îÄ Python 3.7+ —Å type hints
‚îÇ   ‚îú‚îÄ‚îÄ Async/await –ø–æ–¥–¥–µ—Ä–∂–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ Pydantic –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ Dependency Injection
‚îÇ
‚îî‚îÄ‚îÄ üìö Standards Based
    ‚îú‚îÄ‚îÄ OpenAPI (Swagger) –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    ‚îú‚îÄ‚îÄ JSON Schema –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    ‚îî‚îÄ‚îÄ OAuth2, JWT –∏–∑ –∫–æ—Ä–æ–±–∫–∏
```

#### –í–∞—à–µ –ø–µ—Ä–≤–æ–µ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```python
# main.py
from fastapi import FastAPI, HTTPException, Depends, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from pydantic import BaseModel, EmailStr, validator
from typing import List, Optional, Dict, Any
from datetime import datetime, date
import uvicorn

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app = FastAPI(
    title="User Management API",
    description="Comprehensive API for user management with authentication",
    version="1.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

# –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö —Å Pydantic
class UserBase(BaseModel):
    """–ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    name: str
    email: EmailStr
    birth_date: Optional[date] = None
    
    @validator('name')
    def validate_name(cls, v):
        if len(v.strip()) < 2:
            raise ValueError('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞')
        return v.strip().title()
    
    @validator('birth_date')
    def validate_birth_date(cls, v):
        if v and v > date.today():
            raise ValueError('–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º')
        return v

class UserCreate(UserBase):
    """–ú–æ–¥–µ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    password: str
    
    @validator('password')
    def validate_password(cls, v):
        if len(v) < 8:
            raise ValueError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤')
        if not any(c.isupper() for c in v):
            raise ValueError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É')
        if not any(c.islower() for c in v):
            raise ValueError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É')
        if not any(c.isdigit() for c in v):
            raise ValueError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—É')
        return v

class UserUpdate(BaseModel):
    """–ú–æ–¥–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    name: Optional[str] = None
    email: Optional[EmailStr] = None
    birth_date: Optional[date] = None
    is_active: Optional[bool] = None

class UserResponse(UserBase):
    """–ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    id: int
    is_active: bool
    created_at: datetime
    updated_at: Optional[datetime] = None
    
    class Config:
        # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ORM –æ–±—ä–µ–∫—Ç—ã
        from_attributes = True

class LoginRequest(BaseModel):
    """–ú–æ–¥–µ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É"""
    email: EmailStr
    password: str

class TokenResponse(BaseModel):
    """–ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º"""
    access_token: str
    token_type: str = "bearer"
    expires_in: int = 3600

# –ò–º–∏—Ç–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
users_db: Dict[int, Dict[str, Any]] = {}
next_user_id = 1

# –ò–º–∏—Ç–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
active_tokens: Dict[str, int] = {}  # token -> user_id

# –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ä–æ–ª—è–º–∏
import hashlib
import secrets

def hash_password(password: str) -> str:
    """–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
    salt = "your-secret-salt"
    return hashlib.sha256((password + salt).encode()).hexdigest()

def verify_password(password: str, hashed: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è"""
    return hash_password(password) == hashed

def generate_token() -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–∫–µ–Ω–∞"""
    return secrets.token_urlsafe(32)

# Dependency injection –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
security = HTTPBearer()

def get_current_user(credentials: HTTPAuthorizationCredentials = Depends(security)) -> Dict[str, Any]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É"""
    token = credentials.credentials
    
    if token not in active_tokens:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token",
            headers={"WWW-Authenticate": "Bearer"}
        )
    
    user_id = active_tokens[token]
    user = users_db.get(user_id)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="User not found"
        )
    
    if not user["is_active"]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="User account is disabled"
        )
    
    return user

# API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

@app.get("/", summary="Root endpoint")
async def root():
    """–ö–æ—Ä–Ω–µ–≤–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç"""
    return {
        "message": "User Management API",
        "version": "1.0.0",
        "docs": "/docs",
        "redoc": "/redoc"
    }

@app.post("/auth/register", response_model=UserResponse, status_code=status.HTTP_201_CREATED)
async def register_user(user_data: UserCreate):
    """
    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    - **name**: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)
    - **email**: Email –∞–¥—Ä–µ—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º)
    - **password**: –ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É, —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É –∏ —Ü–∏—Ñ—Ä—É)
    - **birth_date**: –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    """
    global next_user_id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
    for user in users_db.values():
        if user["email"] == user_data.email:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail="Email already registered"
            )
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    now = datetime.utcnow()
    user = {
        "id": next_user_id,
        "name": user_data.name,
        "email": user_data.email,
        "birth_date": user_data.birth_date,
        "password_hash": hash_password(user_data.password),
        "is_active": True,
        "created_at": now,
        "updated_at": None
    }
    
    users_db[next_user_id] = user
    next_user_id += 1
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–∞—Ä–æ–ª—è
    return UserResponse(**user)

@app.post("/auth/login", response_model=TokenResponse)
async def login(login_data: LoginRequest):
    """
    –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    """
    # –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
    user = None
    for u in users_db.values():
        if u["email"] == login_data.email:
            user = u
            break
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid email or password"
        )
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
    if not verify_password(login_data.password, user["password_hash"]):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid email or password"
        )
    
    if not user["is_active"]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Account is disabled"
        )
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
    token = generate_token()
    active_tokens[token] = user["id"]
    
    return TokenResponse(access_token=token)

@app.get("/users/me", response_model=UserResponse)
async def get_current_user_profile(current_user: Dict = Depends(get_current_user)):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    return UserResponse(**current_user)

@app.get("/users", response_model=List[UserResponse])
async def get_users(
    skip: int = 0,
    limit: int = 100,
    is_active: Optional[bool] = None,
    current_user: Dict = Depends(get_current_user)
):
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
    - **skip**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º—ã—Ö –∑–∞–ø–∏—Å–µ–π (–¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
    - **limit**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–∞–ø–∏—Å–µ–π
    - **is_active**: –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    """
    users = list(users_db.values())
    
    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if is_active is not None:
        users = [u for u in users if u["is_active"] == is_active]
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    users = users[skip:skip + limit]
    
    return [UserResponse(**user) for user in users]

@app.get("/users/{user_id}", response_model=UserResponse)
async def get_user(user_id: int, current_user: Dict = Depends(get_current_user)):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
    user = users_db.get(user_id)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"User with ID {user_id} not found"
        )
    
    return UserResponse(**user)

@app.put("/users/{user_id}", response_model=UserResponse)
async def update_user(
    user_id: int,
    user_update: UserUpdate,
    current_user: Dict = Depends(get_current_user)
):
    """
    –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if current_user["id"] != user_id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="You can only update your own profile"
        )
    
    user = users_db.get(user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"User with ID {user_id} not found"
        )
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    if user_update.email:
        for uid, u in users_db.items():
            if uid != user_id and u["email"] == user_update.email:
                raise HTTPException(
                    status_code=status.HTTP_409_CONFLICT,
                    detail="Email already exists"
                )
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π
    update_data = user_update.dict(exclude_unset=True)
    for field, value in update_data.items():
        user[field] = value
    
    user["updated_at"] = datetime.utcnow()
    users_db[user_id] = user
    
    return UserResponse(**user)

@app.delete("/users/{user_id}")
async def delete_user(user_id: int, current_user: Dict = Depends(get_current_user)):
    """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è)"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if current_user["id"] != user_id:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="You can only delete your own account"
        )
    
    user = users_db.get(user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"User with ID {user_id} not found"
        )
    
    # –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
    user["is_active"] = False
    user["updated_at"] = datetime.utcnow()
    users_db[user_id] = user
    
    return {"message": "User account deactivated successfully"}

@app.post("/auth/logout")
async def logout(credentials: HTTPAuthorizationCredentials = Depends(security)):
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    token = credentials.credentials
    
    if token in active_tokens:
        del active_tokens[token]
    
    return {"message": "Logged out successfully"}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
@app.exception_handler(ValueError)
async def validation_exception_handler(request, exc):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
    return HTTPException(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        detail=str(exc)
    )

# Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
@app.middleware("http")
async def log_requests(request, call_next):
    """Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤"""
    import time
    
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    
    print(f"{request.method} {request.url.path} - {response.status_code} - {process_time:.4f}s")
    
    return response

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000", "http://localhost:8080"],  # React, Vue
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,  # –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞
        log_level="info"
    )
```

#### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ FastAPI

```python
# advanced_features.py
from fastapi import FastAPI, BackgroundTasks, UploadFile, File, Form
from fastapi.responses import FileResponse, HTMLResponse
from pydantic import BaseModel
import aiofiles
import asyncio
from pathlib import Path
import shutil

app = FastAPI(title="Advanced FastAPI Features")

# 1. Background Tasks - –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
def send_notification_email(email: str, message: str):
    """–ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email"""
    import time
    time.sleep(2)  # –ò–º–∏—Ç–∞—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
    print(f"Email sent to {email}: {message}")

@app.post("/send-notification/")
async def send_notification(
    email: str,
    message: str,
    background_tasks: BackgroundTasks
):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ñ–æ–Ω–µ"""
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Ñ–æ–Ω
    background_tasks.add_task(send_notification_email, email, message)
    
    # –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
    return {"message": "Notification will be sent in background"}

# 2. File Upload - –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
@app.post("/upload-file/")
async def upload_file(file: UploadFile = File(...)):
    """–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞"""
    upload_dir = Path("uploads")
    upload_dir.mkdir(exist_ok=True)
    
    file_path = upload_dir / file.filename
    
    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞
    async with aiofiles.open(file_path, 'wb') as f:
        content = await file.read()
        await f.write(content)
    
    return {
        "filename": file.filename,
        "content_type": file.content_type,
        "file_size": len(content),
        "saved_path": str(file_path)
    }

@app.post("/upload-multiple/")
async def upload_multiple_files(files: List[UploadFile] = File(...)):
    """–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤"""
    upload_dir = Path("uploads")
    upload_dir.mkdir(exist_ok=True)
    
    uploaded_files = []
    
    for file in files:
        file_path = upload_dir / file.filename
        
        async with aiofiles.open(file_path, 'wb') as f:
            content = await file.read()
            await f.write(content)
        
        uploaded_files.append({
            "filename": file.filename,
            "size": len(content)
        })
    
    return {"uploaded_files": uploaded_files}

# 3. Form Data - –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–∞–º–∏
@app.post("/submit-form/")
async def submit_form(
    name: str = Form(...),
    email: str = Form(...),
    age: int = Form(...),
    resume: UploadFile = File(...)
):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å —Ñ–∞–π–ª–æ–º"""
    return {
        "name": name,
        "email": email,
        "age": age,
        "resume_filename": resume.filename,
        "resume_size": resume.size
    }

# 4. Response Models - –†–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –æ—Ç–≤–µ—Ç–æ–≤
@app.get("/download-file/{filename}")
async def download_file(filename: str):
    """–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞"""
    file_path = Path("uploads") / filename
    
    if not file_path.exists():
        raise HTTPException(status_code=404, detail="File not found")
    
    return FileResponse(
        path=file_path,
        filename=filename,
        media_type='application/octet-stream'
    )

@app.get("/health", response_class=HTMLResponse)
async def health_check():
    """Health check —Å HTML –æ—Ç–≤–µ—Ç–æ–º"""
    html_content = """
    <html>
        <head>
            <title>Health Check</title>
        </head>
        <body>
            <h1>Service is running! ‚úÖ</h1>
            <p>All systems operational</p>
        </body>
    </html>
    """
    return html_content

# 5. Dependency Injection - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
from fastapi import Depends

class DatabaseConnection:
    """–ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
    def __init__(self):
        self.is_connected = True
    
    def execute_query(self, query: str):
        return f"Executed: {query}"

class UserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    def __init__(self, db: DatabaseConnection):
        self.db = db
    
    def get_user_stats(self, user_id: int):
        query = f"SELECT stats FROM users WHERE id = {user_id}"
        return self.db.execute_query(query)

# Dependency providers
def get_database():
    """–ü–æ—Å—Ç–∞–≤—â–∏–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î"""
    return DatabaseConnection()

def get_user_service(db: DatabaseConnection = Depends(get_database)):
    """–ü–æ—Å—Ç–∞–≤—â–∏–∫ —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    return UserService(db)

@app.get("/users/{user_id}/stats")
async def get_user_stats(
    user_id: int,
    user_service: UserService = Depends(get_user_service)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ DI"""
    stats = user_service.get_user_stats(user_id)
    return {"user_id": user_id, "stats": stats}

# 6. WebSocket support - –í–µ–±-—Å–æ–∫–µ—Ç—ã
from fastapi import WebSocket, WebSocketDisconnect

class ConnectionManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"""
    def __init__(self):
        self.active_connections: List[WebSocket] = []
    
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)
    
    def disconnect(self, websocket: WebSocket):
        self.active_connections.remove(websocket)
    
    async def send_personal_message(self, message: str, websocket: WebSocket):
        await websocket.send_text(message)
    
    async def broadcast(self, message: str):
        for connection in self.active_connections:
            await connection.send_text(message)

manager = ConnectionManager()

@app.websocket("/ws/{client_id}")
async def websocket_endpoint(websocket: WebSocket, client_id: int):
    """WebSocket —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏"""
    await manager.connect(websocket)
    try:
        while True:
            data = await websocket.receive_text()
            await manager.send_personal_message(f"You wrote: {data}", websocket)
            await manager.broadcast(f"Client #{client_id} says: {data}")
    except WebSocketDisconnect:
        manager.disconnect(websocket)
        await manager.broadcast(f"Client #{client_id} left the chat")

# 7. Middleware - –ö–∞—Å—Ç–æ–º–Ω—ã–µ middleware
import time
from starlette.middleware.base import BaseHTTPMiddleware

class ProcessTimeMiddleware(BaseHTTPMiddleware):
    """Middleware –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    async def dispatch(self, request, call_next):
        start_time = time.time()
        response = await call_next(request)
        process_time = time.time() - start_time
        response.headers["X-Process-Time"] = str(process_time)
        return response

app.add_middleware(ProcessTimeMiddleware)

# 8. Custom Exception Handlers
class CustomException(Exception):
    def __init__(self, name: str):
        self.name = name

@app.exception_handler(CustomException)
async def custom_exception_handler(request, exc):
    return JSONResponse(
        status_code=418,
        content={"message": f"Oops! {exc.name} did something wrong"}
    )

@app.get("/trigger-error")
async def trigger_error():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫"""
    raise CustomException(name="test error")
```

---

## üìÖ –ù–µ–¥–µ–ª—è 12-14: –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ ORM

### –û—Å–Ω–æ–≤—ã —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```sql
-- database_schema.sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

-- 1. –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    birth_date DATE,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP WITH TIME ZONE
);

-- 2. –¢–∞–±–ª–∏—Ü–∞ —Ä–æ–ª–µ–π
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 3. –°–≤—è–∑—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π (–º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º)
CREATE TABLE user_roles (
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE,
    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    assigned_by INTEGER REFERENCES users(id),
    PRIMARY KEY (user_id, role_id)
);

-- 4. –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å—Ç–æ–≤
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    author_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    is_published BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    views_count INTEGER DEFAULT 0,
    likes_count INTEGER DEFAULT 0
);

-- 5. –¢–∞–±–ª–∏—Ü–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    content TEXT NOT NULL,
    post_id INTEGER REFERENCES posts(id) ON DELETE CASCADE,
    author_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    parent_id INTEGER REFERENCES comments(id) ON DELETE CASCADE, -- –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    is_approved BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 6. –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    parent_id INTEGER REFERENCES categories(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 7. –°–≤—è–∑—å –ø–æ—Å—Ç–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
CREATE TABLE post_categories (
    post_id INTEGER REFERENCES posts(id) ON DELETE CASCADE,
    category_id INTEGER REFERENCES categories(id) ON DELETE CASCADE,
    PRIMARY KEY (post_id, category_id)
);

-- 8. –¢–∞–±–ª–∏—Ü–∞ –ª–∞–π–∫–æ–≤
CREATE TABLE likes (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    post_id INTEGER REFERENCES posts(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, post_id) -- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ª–∞–π–∫–Ω—É—Ç—å –ø–æ—Å—Ç –¥–≤–∞–∂–¥—ã
);

-- 9. –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_active ON users(is_active);
CREATE INDEX idx_posts_author ON posts(author_id);
CREATE INDEX idx_posts_published ON posts(is_published, published_at);
CREATE INDEX idx_comments_post ON comments(post_id);
CREATE INDEX idx_comments_author ON comments(author_id);
CREATE INDEX idx_likes_user_post ON likes(user_id, post_id);

-- 10. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$ language plpgsql;

-- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è timestamps
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_posts_updated_at BEFORE UPDATE ON posts
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_comments_updated_at BEFORE UPDATE ON comments
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- –í—Å—Ç–∞–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
INSERT INTO roles (name, description) VALUES
('admin', '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ'),
('moderator', '–ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞'),
('user', '–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');

INSERT INTO categories (name, slug, description) VALUES
('–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', 'tech', '–°—Ç–∞—Ç—å–∏ –æ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö'),
('–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', 'programming', '–°—Ç–∞—Ç—å–∏ –æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏'),
('Python', 'python', '–°—Ç–∞—Ç—å–∏ –æ Python'),
('JavaScript', 'javascript', '–°—Ç–∞—Ç—å–∏ –æ JavaScript');
```

#### –î–∏–∞–≥—Ä–∞–º–º–∞ —Å–≤—è–∑–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```
Database Schema Relationships:
‚îÇ
‚îú‚îÄ‚îÄ üë§ users (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (M) user_roles (M) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1) üîë roles
‚îÇ    ‚îÇ                                                            
‚îÇ    ‚îú‚îÄ‚îÄ (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (M) posts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (M) post_categories (M) ‚îÄ‚îÄ‚îÄ‚îÄ (1) üìÇ categories
‚îÇ    ‚îÇ                      ‚îÇ                                                      ‚îÇ
‚îÇ    ‚îÇ                      ‚îî‚îÄ‚îÄ (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (M) comments                     ‚îî‚îÄ‚îÄ (self-reference)
‚îÇ    ‚îÇ                           ‚îÇ                  ‚îÇ
‚îÇ    ‚îÇ                           ‚îî‚îÄ‚îÄ (M) likes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ    ‚îÇ                                ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ
‚îî‚îÄ‚îÄ Key Relationships:
    ‚îú‚îÄ‚îÄ users ‚Üî roles: Many-to-Many (user_roles)
    ‚îú‚îÄ‚îÄ users ‚Üí posts: One-to-Many (author)
    ‚îú‚îÄ‚îÄ users ‚Üí comments: One-to-Many (author)  
    ‚îú‚îÄ‚îÄ users ‚Üí likes: One-to-Many
    ‚îú‚îÄ‚îÄ posts ‚Üî categories: Many-to-Many (post_categories)
    ‚îú‚îÄ‚îÄ posts ‚Üí comments: One-to-Many
    ‚îú‚îÄ‚îÄ posts ‚Üí likes: One-to-Many
    ‚îî‚îÄ‚îÄ comments ‚Üí comments: Self-reference (nested)
```

### SQLAlchemy ORM: –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SQLAlchemy —Å FastAPI

```python
# database.py
from sqlalchemy import create_engine, Column, Integer, String, Text, Boolean, DateTime, ForeignKey, Table
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, relationship, Session
from sqlalchemy.sql import func
from datetime import datetime
from typing import Generator
import os

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL = os.getenv(
    "DATABASE_URL", 
    "postgresql://postgres:password@localhost:5432/myapp"
)

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
engine = create_engine(
    DATABASE_URL,
    pool_size=10,           # –†–∞–∑–º–µ—Ä –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    max_overflow=20,        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ
    pool_pre_ping=True,     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
    echo=True               # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
)

# –§–∞–±—Ä–∏–∫–∞ —Å–µ—Å—Å–∏–π
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –º–æ–¥–µ–ª–µ–π
Base = declarative_base()

# Dependency –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ë–î
def get_db() -> Generator[Session, None, None]:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–µ—Å—Å–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# –ú–æ–¥–µ–ª–∏ SQLAlchemy
class TimestampMixin:
    """–ú–∏–∫—Å–∏–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫"""
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now())

# –¢–∞–±–ª–∏—Ü–∞ —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Ä–æ–ª–µ–π (–º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º)
user_roles = Table(
    'user_roles',
    Base.metadata,
    Column('user_id', Integer, ForeignKey('users.id', ondelete='CASCADE'), primary_key=True),
    Column('role_id', Integer, ForeignKey('roles.id', ondelete='CASCADE'), primary_key=True),
    Column('assigned_at', DateTime(timezone=True), server_default=func.now()),
    Column('assigned_by', Integer, ForeignKey('users.id'))
)

# –¢–∞–±–ª–∏—Ü–∞ —Å–≤—è–∑–∏ –ø–æ—Å—Ç–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
post_categories = Table(
    'post_categories',
    Base.metadata,
    Column('post_id', Integer, ForeignKey('posts.id', ondelete='CASCADE'), primary_key=True),
    Column('category_id', Integer, ForeignKey('categories.id', ondelete='CASCADE'), primary_key=True)
)

class User(Base, TimestampMixin):
    """–ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    __tablename__ = 'users'
    
    id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), unique=True, index=True, nullable=False)
    password_hash = Column(String(255), nullable=False)
    name = Column(String(100), nullable=False)
    birth_date = Column(DateTime(timezone=True), nullable=True)
    is_active = Column(Boolean, default=True, index=True)
    is_verified = Column(Boolean, default=False)
    last_login = Column(DateTime(timezone=True), nullable=True)
    
    # Relationships
    roles = relationship("Role", secondary=user_roles, back_populates="users")
    posts = relationship("Post", back_populates="author", cascade="all, delete-orphan")
    comments = relationship("Comment", back_populates="author", cascade="all, delete-orphan")
    likes = relationship("Like", back_populates="user", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<User(id={self.id}, email='{self.email}', name='{self.name}')>"

class Role(Base, TimestampMixin):
    """–ú–æ–¥–µ–ª—å —Ä–æ–ª–∏"""
    __tablename__ = 'roles'
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, nullable=False)
    description = Column(Text, nullable=True)
    
    # Relationships
    users = relationship("User", secondary=user_roles, back_populates="roles")

class Category(Base, TimestampMixin):
    """–ú–æ–¥–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    __tablename__ = 'categories'
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), unique=True, nullable=False)
    slug = Column(String(100), unique=True, nullable=False)
    description = Column(Text, nullable=True)
    parent_id = Column(Integer, ForeignKey('categories.id'), nullable=True)
    
    # Self-referential relationship –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    parent = relationship("Category", remote_side=[id], back_populates="children")
    children = relationship("Category", back_populates="parent")
    
    # Relationship —Å –ø–æ—Å—Ç–∞–º–∏
    posts = relationship("Post", secondary=post_categories, back_populates="categories")

class Post(Base, TimestampMixin):
    """–ú–æ–¥–µ–ª—å –ø–æ—Å—Ç–∞"""
    __tablename__ = 'posts'
    
    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(255), nullable=False)
    content = Column(Text, nullable=False)
    author_id = Column(Integer, ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    is_published = Column(Boolean, default=False, index=True)
    published_at = Column(DateTime(timezone=True), nullable=True)
    views_count = Column(Integer, default=0)
    likes_count = Column(Integer, default=0)
    
    # Relationships
    author = relationship("User", back_populates="posts")
    categories = relationship("Category", secondary=post_categories, back_populates="posts")
    comments = relationship("Comment", back_populates="post", cascade="all, delete-orphan")
    likes = relationship("Like", back_populates="post", cascade="all, delete-orphan")
    
    def __repr__(self):
        return f"<Post(id={self.id}, title='{self.title[:30]}...', author_id={self.author_id})>"

class Comment(Base, TimestampMixin):
    """–ú–æ–¥–µ–ª—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"""
    __tablename__ = 'comments'
    
    id = Column(Integer, primary_key=True, index=True)
    content = Column(Text, nullable=False)
    post_id = Column(Integer, ForeignKey('posts.id', ondelete='CASCADE'), nullable=False)
    author_id = Column(Integer, ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    parent_id = Column(Integer, ForeignKey('comments.id', ondelete='CASCADE'), nullable=True)
    is_approved = Column(Boolean, default=True)
    
    # Relationships
    post = relationship("Post", back_populates="comments")
    author = relationship("User", back_populates="comments")
    
    # Self-referential –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    parent = relationship("Comment", remote_side=[id], back_populates="replies")
    replies = relationship("Comment", back_populates="parent")

class Like(Base, TimestampMixin):
    """–ú–æ–¥–µ–ª—å –ª–∞–π–∫–∞"""
    __tablename__ = 'likes'
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey('users.id', ondelete='CASCADE'), nullable=False)
    post_id = Column(Integer, ForeignKey('posts.id', ondelete='CASCADE'), nullable=False)
    
    # Relationships
    user = relationship("User", back_populates="likes")
    post = relationship("Post", back_populates="likes")
    
    __table_args__ = (
        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å - –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ª–∞–π–∫–Ω—É—Ç—å –ø–æ—Å—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
        Index('idx_unique_user_post_like', 'user_id', 'post_id', unique=True),
    )

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
def create_tables():
    """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    Base.metadata.create_all(bind=engine)
    print("–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ")

# Repository pattern –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
class UserRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def create(self, email: str, password_hash: str, name: str, **kwargs) -> User:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = User(
            email=email,
            password_hash=password_hash,
            name=name,
            **kwargs
        )
        self.db.add(user)
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def get_by_id(self, user_id: int) -> User:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID"""
        return self.db.query(User).filter(User.id == user_id).first()
    
    def get_by_email(self, email: str) -> User:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email"""
        return self.db.query(User).filter(User.email == email).first()
    
    def get_all(self, skip: int = 0, limit: int = 100, is_active: bool = None) -> List[User]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π"""
        query = self.db.query(User)
        
        if is_active is not None:
            query = query.filter(User.is_active == is_active)
        
        return query.offset(skip).limit(limit).all()
    
    def update(self, user_id: int, **kwargs) -> User:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.get_by_id(user_id)
        if user:
            for key, value in kwargs.items():
                if hasattr(user, key):
                    setattr(user, key, value)
            self.db.commit()
            self.db.refresh(user)
        return user
    
    def delete(self, user_id: int) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.get_by_id(user_id)
        if user:
            self.db.delete(user)
            self.db.commit()
            return True
        return False
    
    def search_by_name(self, name_pattern: str) -> List[User]:
        """–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∏–º–µ–Ω–∏"""
        return self.db.query(User).filter(
            User.name.ilike(f"%{name_pattern}%")
        ).all()
    
    def get_with_roles(self, user_id: int) -> User:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–æ–ª—è–º–∏"""
        return self.db.query(User).options(
            joinedload(User.roles)
        ).filter(User.id == user_id).first()

class PostRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å—Ç–∞–º–∏"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def create(self, title: str, content: str, author_id: int, **kwargs) -> Post:
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞"""
        post = Post(
            title=title,
            content=content,
            author_id=author_id,
            **kwargs
        )
        self.db.add(post)
        self.db.commit()
        self.db.refresh(post)
        return post
    
    def get_by_id(self, post_id: int) -> Post:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –ø–æ ID —Å –∞–≤—Ç–æ—Ä–æ–º"""
        return self.db.query(Post).options(
            joinedload(Post.author),
            joinedload(Post.categories)
        ).filter(Post.id == post_id).first()
    
    def get_published(self, skip: int = 0, limit: int = 100) -> List[Post]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤"""
        return self.db.query(Post).options(
            joinedload(Post.author)
        ).filter(
            Post.is_published == True
        ).order_by(
            Post.published_at.desc()
        ).offset(skip).limit(limit).all()
    
    def get_by_author(self, author_id: int, skip: int = 0, limit: int = 100) -> List[Post]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –∞–≤—Ç–æ—Ä–∞"""
        return self.db.query(Post).filter(
            Post.author_id == author_id
        ).order_by(
            Post.created_at.desc()
        ).offset(skip).limit(limit).all()
    
    def get_by_category(self, category_id: int, skip: int = 0, limit: int = 100) -> List[Post]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        return self.db.query(Post).join(
            post_categories
        ).filter(
            post_categories.c.category_id == category_id,
            Post.is_published == True
        ).order_by(
            Post.published_at.desc()
        ).offset(skip).limit(limit).all()
    
    def search(self, query: str, skip: int = 0, limit: int = 100) -> List[Post]:
        """–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–æ–≤ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É"""
        search_pattern = f"%{query}%"
        return self.db.query(Post).filter(
            (Post.title.ilike(search_pattern)) |
            (Post.content.ilike(search_pattern)),
            Post.is_published == True
        ).order_by(
            Post.published_at.desc()
        ).offset(skip).limit(limit).all()
    
    def increment_views(self, post_id: int):
        """–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"""
        self.db.query(Post).filter(Post.id == post_id).update({
            Post.views_count: Post.views_count + 1
        })
        self.db.commit()
    
    def get_popular(self, days: int = 7, limit: int = 10) -> List[Post]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥"""
        from datetime import datetime, timedelta
        
        date_threshold = datetime.utcnow() - timedelta(days=days)
        
        return self.db.query(Post).filter(
            Post.published_at >= date_threshold,
            Post.is_published == True
        ).order_by(
            Post.likes_count.desc(),
            Post.views_count.desc()
        ).limit(limit).all()

# –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
class UserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏"""
    
    def __init__(self, db: Session):
        self.user_repo = UserRepository(db)
        self.db = db
    
    def create_user(self, email: str, password: str, name: str, **kwargs) -> User:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ email
        existing_user = self.user_repo.get_by_email(email)
        if existing_user:
            raise ValueError("Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è")
        
        # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
        password_hash = self._hash_password(password)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = self.user_repo.create(
            email=email,
            password_hash=password_hash,
            name=name,
            **kwargs
        )
        
        # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        self._assign_default_role(user)
        
        return user
    
    def authenticate(self, email: str, password: str) -> User:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user = self.user_repo.get_by_email(email)
        
        if not user:
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
        
        if not self._verify_password(password, user.password_hash):
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
        
        if not user.is_active:
            raise ValueError("–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
        self.user_repo.update(user.id, last_login=datetime.utcnow())
        
        return user
    
    def change_password(self, user_id: int, old_password: str, new_password: str):
        """–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è"""
        user = self.user_repo.get_by_id(user_id)
        
        if not user:
            raise ValueError("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        if not self._verify_password(old_password, user.password_hash):
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å")
        
        new_password_hash = self._hash_password(new_password)
        self.user_repo.update(user_id, password_hash=new_password_hash)
    
    def assign_role(self, user_id: int, role_name: str):
        """–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        user = self.user_repo.get_by_id(user_id)
        role = self.db.query(Role).filter(Role.name == role_name).first()
        
        if not user:
            raise ValueError("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
        if not role:
            raise ValueError("–†–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        
        if role not in user.roles:
            user.roles.append(role)
            self.db.commit()
    
    def _hash_password(self, password: str) -> str:
        """–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
        import hashlib
        salt = "your-secret-salt"
        return hashlib.sha256((password + salt).encode()).hexdigest()
    
    def _verify_password(self, password: str, hash: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è"""
        return self._hash_password(password) == hash
    
    def _assign_default_role(self, user: User):
        """–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        default_role = self.db.query(Role).filter(Role.name == "user").first()
        if default_role:
            user.roles.append(default_role)
            self.db.commit()

class PostService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å—Ç–∞–º–∏"""
    
    def __init__(self, db: Session):
        self.post_repo = PostRepository(db)
        self.db = db
    
    def create_post(self, title: str, content: str, author_id: int, 
                   category_ids: List[int] = None, publish: bool = False) -> Post:
        """–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞"""
        post_data = {
            "title": title,
            "content": content,
            "author_id": author_id
        }
        
        if publish:
            post_data["is_published"] = True
            post_data["published_at"] = datetime.utcnow()
        
        post = self.post_repo.create(**post_data)
        
        # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        if category_ids:
            categories = self.db.query(Category).filter(
                Category.id.in_(category_ids)
            ).all()
            post.categories.extend(categories)
            self.db.commit()
        
        return post
    
    def publish_post(self, post_id: int, user_id: int) -> Post:
        """–ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–∞"""
        post = self.post_repo.get_by_id(post_id)
        
        if not post:
            raise ValueError("–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        
        if post.author_id != user_id:
            raise ValueError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")
        
        if post.is_published:
            raise ValueError("–ü–æ—Å—Ç —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω")
        
        return self.post_repo.update(post_id, 
                                   is_published=True, 
                                   published_at=datetime.utcnow())
    
    def like_post(self, post_id: int, user_id: int) -> bool:
        """–õ–∞–π–∫ –ø–æ—Å—Ç–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ª–∞–π–∫–∞
        existing_like = self.db.query(Like).filter(
            Like.post_id == post_id,
            Like.user_id == user_id
        ).first()
        
        if existing_like:
            # –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫
            self.db.delete(existing_like)
            # –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            self.db.query(Post).filter(Post.id == post_id).update({
                Post.likes_count: Post.likes_count - 1
            })
            self.db.commit()
            return False
        else:
            # –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫
            like = Like(post_id=post_id, user_id=user_id)
            self.db.add(like)
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
            self.db.query(Post).filter(Post.id == post_id).update({
                Post.likes_count: Post.likes_count + 1
            })
            self.db.commit()
            return True

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å ORM
def demo_sqlalchemy_orm():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã SQLAlchemy ORM"""
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
    create_tables()
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
    db = SessionLocal()
    
    try:
        print("=== SQLAlchemy ORM Demo ===\n")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–µ–π
        admin_role = Role(name="admin", description="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä")
        user_role = Role(name="user", description="–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        
        db.add_all([admin_role, user_role])
        db.commit()
        
        # –°–µ—Ä–≤–∏—Å—ã
        user_service = UserService(db)
        post_service = PostService(db)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        print("1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:")
        admin = user_service.create_user(
            email="admin@example.com",
            password="admin123",
            name="Admin User"
        )
        print(f"–°–æ–∑–¥–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {admin}")
        
        user = user_service.create_user(
            email="john@example.com", 
            password="password123",
            name="John Doe"
        )
        print(f"–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user}")
        
        # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        user_service.assign_role(admin.id, "admin")
        print(f"–ù–∞–∑–Ω–∞—á–µ–Ω–∞ —Ä–æ–ª—å admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {admin.email}")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        print("\n2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:")
        tech_category = Category(name="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", slug="tech")
        python_category = Category(name="Python", slug="python")
        
        db.add_all([tech_category, python_category])
        db.commit()
        print("–°–æ–∑–¥–∞–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, Python")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
        print("\n3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤:")
        post1 = post_service.create_post(
            title="–í–≤–µ–¥–µ–Ω–∏–µ –≤ Python",
            content="Python - –æ—Ç–ª–∏—á–Ω—ã–π —è–∑—ã–∫ –¥–ª—è backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...",
            author_id=user.id,
            category_ids=[python_category.id],
            publish=True
        )
        print(f"–°–æ–∑–¥–∞–Ω –ø–æ—Å—Ç: {post1}")
        
        post2 = post_service.create_post(
            title="–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏",
            content="–û–±–∑–æ—Ä —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...",
            author_id=admin.id,
            category_ids=[tech_category.id]
        )
        print(f"–°–æ–∑–¥–∞–Ω –ø–æ—Å—Ç: {post2}")
        
        # –õ–∞–π–∫–∏
        print("\n4. –õ–∞–π–∫–∏:")
        liked = post_service.like_post(post1.id, admin.id)
        print(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {'–ª–∞–π–∫–Ω—É–ª' if liked else '—É–±—Ä–∞–ª –ª–∞–π–∫ —Å'} –ø–æ—Å—Ç–∞")
        
        # –ó–∞–ø—Ä–æ—Å—ã —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
        print("\n5. –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å –∞–≤—Ç–æ—Ä–∞–º–∏
        posts_with_authors = db.query(Post).options(
            joinedload(Post.author)
        ).all()
        
        for post in posts_with_authors:
            print(f"–ü–æ—Å—Ç '{post.title}' –∞–≤—Ç–æ—Ä–∞ {post.author.name}")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        user_stats = db.query(
            User.name,
            func.count(Post.id).label('posts_count'),
            func.sum(Post.likes_count).label('total_likes')
        ).outerjoin(Post).group_by(User.id, User.name).all()
        
        print("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:")
        for name, posts_count, total_likes in user_stats:
            print(f"{name}: {posts_count} –ø–æ—Å—Ç–æ–≤, {total_likes or 0} –ª–∞–π–∫–æ–≤")
        
        # –ü–æ–∏—Å–∫ –ø–æ—Å—Ç–æ–≤
        print("\n6. –ü–æ–∏—Å–∫:")
        post_repo = PostRepository(db)
        found_posts = post_repo.search("Python")
        print(f"–ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–æ–≤ —Å 'Python': {len(found_posts)}")
        
    finally:
        db.close()

if __name__ == "__main__":
    demo_sqlalchemy_orm()
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å Alembic

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Alembic

```python
# migrations/env.py
from logging.config import fileConfig
from sqlalchemy import engine_from_config, pool
from alembic import context
from database import Base, DATABASE_URL

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
config = context.config

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
target_metadata = Base.metadata

def run_migrations_offline() -> None:
    """–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –≤ 'offline' —Ä–µ–∂–∏–º–µ"""
    url = DATABASE_URL
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()

def run_migrations_online() -> None:
    """–ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –≤ 'online' —Ä–µ–∂–∏–º–µ"""
    configuration = config.get_section(config.config_ini_section)
    configuration['sqlalchemy.url'] = DATABASE_URL
    
    connectable = engine_from_config(
        configuration,
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection, 
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()

if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

#### –ü—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π

```python
# migrations/versions/001_initial_migration.py
"""Initial migration

Revision ID: 001
Revises: 
Create Date: 2024-01-15 10:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers
revision = '001'
down_revision = None
branch_labels = None
depends_on = None

def upgrade() -> None:
    """–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏"""
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(length=255), nullable=False),
        sa.Column('password_hash', sa.String(length=255), nullable=False),
        sa.Column('name', sa.String(length=100), nullable=False),
        sa.Column('birth_date', sa.DateTime(timezone=True), nullable=True),
        sa.Column('is_active', sa.Boolean(), nullable=True),
        sa.Column('is_verified', sa.Boolean(), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('last_login', sa.DateTime(timezone=True), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_index(op.f('ix_users_is_active'), 'users', ['is_active'], unique=False)

def downgrade() -> None:
    """–û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏"""
    op.drop_index(op.f('ix_users_is_active'), table_name='users')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')

# migrations/versions/002_add_posts_table.py
"""Add posts table

Revision ID: 002
Revises: 001
Create Date: 2024-01-15 11:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

revision = '002'
down_revision = '001'
branch_labels = None
depends_on = None

def upgrade() -> None:
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å—Ç–æ–≤
    op.create_table('posts',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('title', sa.String(length=255), nullable=False),
        sa.Column('content', sa.Text(), nullable=False),
        sa.Column('author_id', sa.Integer(), nullable=False),
        sa.Column('is_published', sa.Boolean(), nullable=True),
        sa.Column('published_at', sa.DateTime(timezone=True), nullable=True),
        sa.Column('views_count', sa.Integer(), nullable=True),
        sa.Column('likes_count', sa.Integer(), nullable=True),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
        sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
        sa.ForeignKeyConstraint(['author_id'], ['users.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_posts_author_id'), 'posts', ['author_id'], unique=False)
    op.create_index(op.f('ix_posts_is_published'), 'posts', ['is_published'], unique=False)

def downgrade() -> None:
    op.drop_index(op.f('ix_posts_is_published'), table_name='posts')
    op.drop_index(op.f('ix_posts_author_id'), table_name='posts')
    op.drop_table('posts')

# migrations/versions/003_add_user_avatar_column.py
"""Add user avatar column

Revision ID: 003
Revises: 002
Create Date: 2024-01-16 09:00:00.000000

"""
from alembic import op
import sqlalchemy as sa

revision = '003'
down_revision = '002'
branch_labels = None
depends_on = None

def upgrade() -> None:
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
    op.add_column('users', sa.Column('avatar_url', sa.String(length=500), nullable=True))

def downgrade() -> None:
    op.drop_column('users', 'avatar_url')
```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

```bash
# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Alembic (–æ–¥–∏–Ω —Ä–∞–∑)
alembic init migrations

# –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –º–æ–¥–µ–ª—è—Ö
alembic revision --autogenerate -m "Description of changes"

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
alembic upgrade head

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade 002

# –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
alembic downgrade -1

# –û—Ç–∫–∞—Ç –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
alembic downgrade 001

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–π —Ä–µ–≤–∏–∑–∏–∏
alembic current

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π
alembic history

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏ –∏ –ë–î
alembic check
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

#### N+1 Problem –∏ –µ–≥–æ —Ä–µ—à–µ–Ω–∏–µ

```python
# performance_optimization.py
from sqlalchemy.orm import joinedload, selectinload, subqueryload
from sqlalchemy import func, text
from typing import List
import time

class PerformanceOptimization:
    """–ü—Ä–∏–º–µ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    
    def __init__(self, db: Session):
        self.db = db
    
    def demo_n_plus_one_problem(self):
        """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã N+1"""
        print("=== N+1 Problem Demo ===\n")
        
        # ‚ùå –ü–ª–æ—Ö–æ: N+1 –ø—Ä–æ–±–ª–µ–º–∞
        print("1. N+1 Problem (–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ):")
        start_time = time.time()
        
        # 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤
        posts = self.db.query(Post).limit(5).all()
        
        # N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—ã–π –ø–æ—Å—Ç)
        for post in posts:
            author_name = post.author.name  # –ö–∞–∂–¥–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ = –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            print(f"Post: {post.title[:30]}... by {author_name}")
        
        end_time = time.time()
        print(f"–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è N+1: {end_time - start_time:.4f}s\n")
        
        # ‚úÖ –•–æ—Ä–æ—à–æ: Eager Loading
        print("2. Eager Loading (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ):")
        start_time = time.time()
        
        # 1 –∑–∞–ø—Ä–æ—Å —Å JOIN –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤ –∏ –∞–≤—Ç–æ—Ä–æ–≤
        posts_with_authors = self.db.query(Post).options(
            joinedload(Post.author)
        ).limit(5).all()
        
        for post in posts_with_authors:
            author_name = post.author.name  # –î–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –Ω–µ—Ç –¥–æ–ø. –∑–∞–ø—Ä–æ—Å–æ–≤
            print(f"Post: {post.title[:30]}... by {author_name}")
        
        end_time = time.time()
        print(f"–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Eager Loading: {end_time - start_time:.4f}s\n")
    
    def demo_loading_strategies(self):
        """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∑–∞–≥—Ä—É–∑–∫–∏"""
        print("=== Loading Strategies ===\n")
        
        # 1. Joined Load - JOIN –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
        print("1. Joined Load:")
        posts = self.db.query(Post).options(
            joinedload(Post.author),
            joinedload(Post.categories)
        ).limit(3).all()
        
        for post in posts:
            print(f"  {post.title} by {post.author.name}")
            print(f"  Categories: {[cat.name for cat in post.categories]}")
        print()
        
        # 2. Select In Load - –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å IN
        print("2. Select In Load:")
        posts = self.db.query(Post).options(
            selectinload(Post.comments).selectinload(Comment.author)
        ).limit(3).all()
        
        for post in posts:
            print(f"  {post.title}")
            print(f"  Comments: {len(post.comments)}")
        print()
        
        # 3. Subquery Load - –ø–æ–¥–∑–∞–ø—Ä–æ—Å
        print("3. Subquery Load:")
        users = self.db.query(User).options(
            subqueryload(User.posts)
        ).limit(3).all()
        
        for user in users:
            print(f"  {user.name}: {len(user.posts)} posts")
        print()
    
    def demo_query_optimization(self):
        """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
        print("=== Query Optimization ===\n")
        
        # 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
        print("1. –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:")
        
        # ‚úÖ –•–æ—Ä–æ—à–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å –Ω–∞ email
        user = self.db.query(User).filter(User.email == "john@example.com").first()
        
        # ‚úÖ –•–æ—Ä–æ—à–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å –Ω–∞ is_published
        published_posts = self.db.query(Post).filter(Post.is_published == True).count()
        print(f"Published posts: {published_posts}")
        
        # 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é SELECT
        print("\n2. –í—ã–±–æ—Ä–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–µ–π:")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
        user_emails = self.db.query(User.email, User.name).filter(
            User.is_active == True
        ).all()
        
        for email, name in user_emails:
            print(f"  {name}: {email}")
        
        # 3. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
        print("\n3. –ê–≥—Ä–µ–≥–∞—Ü–∏—è:")
        
        # –ü–æ–¥—Å—á–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î, –∞ –Ω–µ –≤ Python
        stats = self.db.query(
            func.count(Post.id).label('total_posts'),
            func.sum(Post.views_count).label('total_views'),
            func.avg(Post.likes_count).label('avg_likes')
        ).filter(Post.is_published == True).first()
        
        print(f"  Total posts: {stats.total_posts}")
        print(f"  Total views: {stats.total_views}")
        print(f"  Average likes: {stats.avg_likes:.2f}")
        
        # 4. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        print("\n4. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–≤—Ç–æ—Ä–∞–º:")
        
        author_stats = self.db.query(
            User.name,
            func.count(Post.id).label('posts_count'),
            func.sum(Post.views_count).label('total_views')
        ).join(Post).group_by(User.id, User.name).order_by(
            func.count(Post.id).desc()
        ).limit(5).all()
        
        for name, posts_count, total_views in author_stats:
            print(f"  {name}: {posts_count} posts, {total_views or 0} views")
    
    def demo_pagination_optimization(self):
        """–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
        print("\n=== Pagination Optimization ===\n")
        
        # ‚ùå –ü–ª–æ—Ö–æ: OFFSET –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        print("1. –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è (OFFSET):")
        start_time = time.time()
        
        # –ü—Ä–∏ –±–æ–ª—å—à–∏—Ö OFFSET –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç
        page_5000 = self.db.query(Post).offset(5000).limit(20).all()
        
        end_time = time.time()
        print(f"OFFSET –ø–∞–≥–∏–Ω–∞—Ü–∏—è: {end_time - start_time:.4f}s")
        
        # ‚úÖ –•–æ—Ä–æ—à–æ: Cursor-based pagination
        print("\n2. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è (Cursor):")
        start_time = time.time()
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–∞–∫ –∫—É—Ä—Å–æ—Ä
        last_id = 5000
        cursor_page = self.db.query(Post).filter(
            Post.id > last_id
        ).order_by(Post.id).limit(20).all()
        
        end_time = time.time()
        print(f"Cursor –ø–∞–≥–∏–Ω–∞—Ü–∏—è: {end_time - start_time:.4f}s")
        
        # –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è cursor pagination
        def get_posts_cursor(cursor_id: int = None, limit: int = 20):
            query = self.db.query(Post).filter(Post.is_published == True)
            
            if cursor_id:
                query = query.filter(Post.id > cursor_id)
            
            posts = query.order_by(Post.id).limit(limit + 1).all()
            
            has_more = len(posts) > limit
            if has_more:
                posts = posts[:-1]  # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
            
            next_cursor = posts[-1].id if posts and has_more else None
            
            return {
                "posts": posts,
                "next_cursor": next_cursor,
                "has_more": has_more
            }
        
        result = get_posts_cursor(cursor_id=100, limit=10)
        print(f"Posts loaded: {len(result['posts'])}")
        print(f"Next cursor: {result['next_cursor']}")
        print(f"Has more: {result['has_more']}")
    
    def demo_bulk_operations(self):
        """–ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"""
        print("\n=== Bulk Operations ===\n")
        
        # ‚ùå –ü–ª–æ—Ö–æ: –ø–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏
        print("1. –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:")
        start_time = time.time()
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏
        for i in range(100):
            self.db.query(Post).filter(Post.id == i).update({
                Post.views_count: Post.views_count + 1
            })
        
        end_time = time.time()
        print(f"–ü–æ–æ–¥–∏–Ω–æ—á–∫–µ: {end_time - start_time:.4f}s")
        
        # ‚úÖ –•–æ—Ä–æ—à–æ: –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        print("\n2. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:")
        start_time = time.time()
        
        # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
        self.db.query(Post).filter(
            Post.id.between(1, 100)
        ).update({
            Post.views_count: Post.views_count + 1
        }, synchronize_session=False)
        
        end_time = time.time()
        print(f"–ú–∞—Å—Å–æ–≤–æ: {end_time - start_time:.4f}s")
        
        # –ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞
        print("\n3. –ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞:")
        start_time = time.time()
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        bulk_posts = []
        for i in range(1000):
            bulk_posts.append({
                'title': f'Bulk Post {i}',
                'content': f'Content for bulk post {i}',
                'author_id': 1,
                'is_published': False
            })
        
        # –ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞
        self.db.bulk_insert_mappings(Post, bulk_posts)
        self.db.commit()
        
        end_time = time.time()
        print(f"–ú–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞ 1000 –∑–∞–ø–∏—Å–µ–π: {end_time - start_time:.4f}s")
    
    def demo_raw_sql(self):
        """–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—ã—Ä–æ–≥–æ SQL –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
        print("\n=== Raw SQL for Complex Queries ===\n")
        
        # –°–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
        complex_query = text("""
            SELECT 
                u.name,
                COUNT(p.id) as posts_count,
                SUM(p.views_count) as total_views,
                AVG(p.likes_count) as avg_likes,
                MAX(p.published_at) as last_post_date,
                RANK() OVER (ORDER BY COUNT(p.id) DESC) as author_rank
            FROM users u
            LEFT JOIN posts p ON u.id = p.author_id AND p.is_published = true
            WHERE u.is_active = true
            GROUP BY u.id, u.name
            HAVING COUNT(p.id) > 0
            ORDER BY posts_count DESC, total_views DESC
            LIMIT 10
        """)
        
        result = self.db.execute(complex_query).fetchall()
        
        print("–¢–æ–ø –∞–≤—Ç–æ—Ä–æ–≤:")
        for row in result:
            print(f"  #{row.author_rank} {row.name}: {row.posts_count} posts, "
                  f"{row.total_views or 0} views, {row.avg_likes:.1f} avg likes")

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
def demo_performance_optimization():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ç–µ—Ö–Ω–∏–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"""
    db = SessionLocal()
    
    try:
        optimizer = PerformanceOptimization(db)
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        if db.query(Post).count() < 10:
            print("–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...")
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            for i in range(5):
                user = User(
                    email=f"user{i}@example.com",
                    password_hash="hash",
                    name=f"User {i}"
                )
                db.add(user)
            
            db.commit()
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç—ã
            users = db.query(User).all()
            for user in users:
                for j in range(10):
                    post = Post(
                        title=f"Post {j} by {user.name}",
                        content=f"Content of post {j}",
                        author_id=user.id,
                        is_published=True,
                        views_count=j * 10,
                        likes_count=j
                    )
                    db.add(post)
            
            db.commit()
            print("–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã\n")
        
        # –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–π
        optimizer.demo_n_plus_one_problem()
        optimizer.demo_loading_strategies()
        optimizer.demo_query_optimization()
        optimizer.demo_pagination_optimization()
        optimizer.demo_bulk_operations()
        optimizer.demo_raw_sql()
        
    finally:
        db.close()

if __name__ == "__main__":
    demo_performance_optimization()
```

---

## üìÖ –ù–µ–¥–µ–ª—è 15-16: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT (JSON Web Tokens) –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã JWT

```
JWT Structure:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Header.Payload.Signature                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.                      ‚îÇ ‚Üê Header (Base64)
‚îÇ eyJ1c2VyX2lkIjoxMjMsImV4cCI6MTY0MjU4NzYwMH0.              ‚îÇ ‚Üê Payload (Base64)  
‚îÇ SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c             ‚îÇ ‚Üê Signature
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Header (decoded):
{
  "typ": "JWT",
  "alg": "HS256"
}

Payload (decoded):
{
  "user_id": 123,
  "email": "user@example.com", 
  "roles": ["user"],
  "exp": 1642587600,  // expiration timestamp
  "iat": 1642501200,  // issued at timestamp
  "jti": "unique-id"  // JWT ID
}
```

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```python
# auth.py
import jwt
from datetime import datetime, timedelta
from passlib.context import CryptContext
from fastapi import HTTPException, status, Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from typing import Optional, List, Dict, Any
import secrets
from enum import Enum

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
SECRET_KEY = "your-super-secret-key-change-in-production"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30
REFRESH_TOKEN_EXPIRE_DAYS = 7

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# –°—Ö–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
security = HTTPBearer()

class TokenType(Enum):
    ACCESS = "access"
    REFRESH = "refresh"

class AuthenticationError(Exception):
    """–û—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    pass

class AuthorizationError(Exception):
    """–û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
    pass

class PasswordManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π"""
    
    @staticmethod
    def hash_password(password: str) -> str:
        """–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è"""
        return pwd_context.hash(password)
    
    @staticmethod
    def verify_password(plain_password: str, hashed_password: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è"""
        return pwd_context.verify(plain_password, hashed_password)
    
    @staticmethod
    def generate_reset_token() -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
        return secrets.token_urlsafe(32)

class JWTManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä JWT —Ç–æ–∫–µ–Ω–æ–≤"""
    
    def __init__(self, secret_key: str = SECRET_KEY, algorithm: str = ALGORITHM):
        self.secret_key = secret_key
        self.algorithm = algorithm
    
    def create_access_token(self, data: Dict[str, Any], expires_delta: Optional[timedelta] = None) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞"""
        to_encode = data.copy()
        
        if expires_delta:
            expire = datetime.utcnow() + expires_delta
        else:
            expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
        
        to_encode.update({
            "exp": expire,
            "iat": datetime.utcnow(),
            "type": TokenType.ACCESS.value,
            "jti": secrets.token_urlsafe(16)  # JWT ID –¥–ª—è –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤
        })
        
        encoded_jwt = jwt.encode(to_encode, self.secret_key, algorithm=self.algorithm)
        return encoded_jwt
    
    def create_refresh_token(self, data: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ refresh —Ç–æ–∫–µ–Ω–∞"""
        to_encode = data.copy()
        expire = datetime.utcnow() + timedelta(days=REFRESH_TOKEN_EXPIRE_DAYS)
        
        to_encode.update({
            "exp": expire,
            "iat": datetime.utcnow(),
            "type": TokenType.REFRESH.value,
            "jti": secrets.token_urlsafe(16)
        })
        
        encoded_jwt = jwt.encode(to_encode, self.secret_key, algorithm=self.algorithm)
        return encoded_jwt
    
    def verify_token(self, token: str, token_type: TokenType = TokenType.ACCESS) -> Dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞"""
        try:
            payload = jwt.decode(token, self.secret_key, algorithms=[self.algorithm])
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–∞
            if payload.get("type") != token_type.value:
                raise AuthenticationError("Invalid token type")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if "user_id" not in payload:
                raise AuthenticationError("Invalid token payload")
            
            return payload
            
        except jwt.ExpiredSignatureError:
            raise AuthenticationError("Token has expired")
        except jwt.JWTError:
            raise AuthenticationError("Invalid token")
    
    def refresh_access_token(self, refresh_token: str) -> str:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞ –ø–æ refresh —Ç–æ–∫–µ–Ω—É"""
        try:
            payload = self.verify_token(refresh_token, TokenType.REFRESH)
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π access —Ç–æ–∫–µ–Ω —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏
            new_token_data = {
                "user_id": payload["user_id"],
                "email": payload.get("email"),
                "roles": payload.get("roles", [])
            }
            
            return self.create_access_token(new_token_data)
            
        except AuthenticationError:
            raise AuthenticationError("Invalid refresh token")

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis)
revoked_tokens = set()

class TokenBlacklist:
    """–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤"""
    
    @staticmethod
    def revoke_token(jti: str):
        """–û—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–∞"""
        revoked_tokens.add(jti)
    
    @staticmethod
    def is_token_revoked(jti: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–∞"""
        return jti in revoked_tokens
    
    @staticmethod
    def clear_expired_tokens():
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–¥–æ–ª–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏)"""
        # –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å TTL –≤ Redis
        pass

class AuthService:
    """–°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    
    def __init__(self, user_service, jwt_manager: JWTManager = None):
        self.user_service = user_service
        self.jwt_manager = jwt_manager or JWTManager()
        self.password_manager = PasswordManager()
    
    def register_user(self, email: str, password: str, name: str, **kwargs) -> Dict[str, Any]:
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        existing_user = self.user_service.get_by_email(email)
        if existing_user:
            raise AuthenticationError("Email already registered")
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
        self._validate_password(password)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        hashed_password = self.password_manager.hash_password(password)
        user = self.user_service.create_user(
            email=email,
            password_hash=hashed_password,
            name=name,
            **kwargs
        )
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
        token_data = {
            "user_id": user.id,
            "email": user.email,
            "roles": [role.name for role in user.roles]
        }
        
        access_token = self.jwt_manager.create_access_token(token_data)
        refresh_token = self.jwt_manager.create_refresh_token(token_data)
        
        return {
            "user": user,
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer"
        }
    
    def authenticate_user(self, email: str, password: str) -> Dict[str, Any]:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = self.user_service.get_by_email(email)
        if not user:
            raise AuthenticationError("Invalid email or password")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if not self.password_manager.verify_password(password, user.password_hash):
            raise AuthenticationError("Invalid email or password")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
        if not user.is_active:
            raise AuthenticationError("Account is disabled")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
        self.user_service.update_last_login(user.id)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
        token_data = {
            "user_id": user.id,
            "email": user.email,
            "roles": [role.name for role in user.roles]
        }
        
        access_token = self.jwt_manager.create_access_token(token_data)
        refresh_token = self.jwt_manager.create_refresh_token(token_data)
        
        return {
            "user": user,
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer"
        }
    
    def refresh_token(self, refresh_token: str) -> Dict[str, Any]:
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞"""
        try:
            new_access_token = self.jwt_manager.refresh_access_token(refresh_token)
            
            return {
                "access_token": new_access_token,
                "token_type": "bearer"
            }
            
        except AuthenticationError as e:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail=str(e)
            )
    
    def logout_user(self, token: str):
        """–í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç–∑—ã–≤ —Ç–æ–∫–µ–Ω–∞)"""
        try:
            payload = self.jwt_manager.verify_token(token)
            jti = payload.get("jti")
            
            if jti:
                TokenBlacklist.revoke_token(jti)
            
        except AuthenticationError:
            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
            pass
    
    def _validate_password(self, password: str):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è"""
        if len(password) < 8:
            raise AuthenticationError("Password must be at least 8 characters long")
        
        if not any(c.isupper() for c in password):
            raise AuthenticationError("Password must contain at least one uppercase letter")
        
        if not any(c.islower() for c in password):
            raise AuthenticationError("Password must contain at least one lowercase letter")
        
        if not any(c.isdigit() for c in password):
            raise AuthenticationError("Password must contain at least one digit")

# Dependency –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    user_service=Depends(get_user_service)  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
) -> User:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞"""
    
    jwt_manager = JWTManager()
    
    try:
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
        token = credentials.credentials
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
        payload = jwt_manager.verify_token(token)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∑—ã–≤–∞ —Ç–æ–∫–µ–Ω–∞
        jti = payload.get("jti")
        if jti and TokenBlacklist.is_token_revoked(jti):
            raise AuthenticationError("Token has been revoked")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = payload.get("user_id")
        user = user_service.get_by_id(user_id)
        
        if not user:
            raise AuthenticationError("User not found")
        
        if not user.is_active:
            raise AuthenticationError("User account is disabled")
        
        return user
        
    except AuthenticationError as e:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=str(e),
            headers={"WWW-Authenticate": "Bearer"}
        )

# Dependency –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π
def require_roles(*required_roles: str):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    def role_checker(current_user: User = Depends(get_current_user)) -> User:
        user_roles = [role.name for role in current_user.roles]
        
        if not any(role in user_roles for role in required_roles):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Required roles: {', '.join(required_roles)}"
            )
        
        return current_user
    
    return role_checker

# Dependency –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
def require_permission(permission: str):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π"""
    def permission_checker(current_user: User = Depends(get_current_user)) -> User:
        # –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
        user_roles = [role.name for role in current_user.roles]
        
        # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        permissions = {
            "admin": ["read", "write", "delete", "manage_users"],
            "moderator": ["read", "write", "moderate_content"],
            "user": ["read", "write_own"]
        }
        
        user_permissions = []
        for role in user_roles:
            user_permissions.extend(permissions.get(role, []))
        
        if permission not in user_permissions:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"Permission '{permission}' required"
            )
        
        return current_user
    
    return permission_checker

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
from fastapi import FastAPI

app = FastAPI()

@app.post("/auth/register")
async def register(
    email: str,
    password: str,
    name: str,
    auth_service: AuthService = Depends(get_auth_service)
):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        result = auth_service.register_user(email, password, name)
        return {
            "message": "User registered successfully",
            "access_token": result["access_token"],
            "refresh_token": result["refresh_token"],
            "token_type": result["token_type"]
        }
    except AuthenticationError as e:
        raise HTTPException(status_code=400, detail=str(e))

@app.post("/auth/login")
async def login(
    email: str,
    password: str,
    auth_service: AuthService = Depends(get_auth_service)
):
    """–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É"""
    try:
        result = auth_service.authenticate_user(email, password)
        return {
            "access_token": result["access_token"],
            "refresh_token": result["refresh_token"],
            "token_type": result["token_type"]
        }
    except AuthenticationError as e:
        raise HTTPException(status_code=401, detail=str(e))

@app.post("/auth/refresh")
async def refresh_token(
    refresh_token: str,
    auth_service: AuthService = Depends(get_auth_service)
):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞"""
    return auth_service.refresh_token(refresh_token)

@app.post("/auth/logout")
async def logout(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    auth_service: AuthService = Depends(get_auth_service)
):
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    auth_service.logout_user(credentials.credentials)
    return {"message": "Logged out successfully"}

@app.get("/users/me")
async def get_my_profile(current_user: User = Depends(get_current_user)):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è"""
    return {
        "id": current_user.id,
        "email": current_user.email,
        "name": current_user.name,
        "roles": [role.name for role in current_user.roles]
    }

@app.get("/admin/users")
async def get_all_users(
    current_user: User = Depends(require_roles("admin")),
    user_service = Depends(get_user_service)
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã)"""
    users = user_service.get_all()
    return {"users": users}

@app.delete("/admin/users/{user_id}")
async def delete_user(
    user_id: int,
    current_user: User = Depends(require_permission("manage_users")),
    user_service = Depends(get_user_service)
):
    """–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ manage_users)"""
    success = user_service.delete_user(user_id)
    if success:
        return {"message": "User deleted successfully"}
    else:
        raise HTTPException(status_code=404, detail="User not found")
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API

#### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

```python
# security.py
from fastapi import Request, HTTPException, status
from fastapi.middleware.base import BaseHTTPMiddleware
from starlette.responses import JSONResponse
import time
import hashlib
from collections import defaultdict, deque
from datetime import datetime, timedelta
from typing import Dict, Optional
import re
import html

class SecurityConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    
    # Rate Limiting
    RATE_LIMIT_REQUESTS = 100  # –∑–∞–ø—Ä–æ—Å–æ–≤
    RATE_LIMIT_WINDOW = 3600   # –∑–∞ —á–∞—Å
    RATE_LIMIT_BURST = 10      # burst –ª–∏–º–∏—Ç
    
    # Password Policy
    MIN_PASSWORD_LENGTH = 8
    REQUIRE_UPPERCASE = True
    REQUIRE_LOWERCASE = True
    REQUIRE_DIGITS = True
    REQUIRE_SPECIAL_CHARS = True
    
    # Session Security
    SESSION_TIMEOUT = 3600     # 1 —á–∞—Å
    MAX_LOGIN_ATTEMPTS = 5     # –º–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
    LOCKOUT_DURATION = 1800    # –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 30 –º–∏–Ω—É—Ç
    
    # Content Security
    MAX_REQUEST_SIZE = 10 * 1024 * 1024  # 10MB
    ALLOWED_FILE_TYPES = {'.jpg', '.jpeg', '.png', '.gif', '.pdf', '.doc', '.docx'}

class RateLimiter:
    """–û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def __init__(self):
        self.requests = defaultdict(deque)  # IP -> —Å–ø–∏—Å–æ–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
        self.blocked_ips = {}  # IP -> –≤—Ä–µ–º—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    
    def is_allowed(self, ip_address: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∑–∞–ø—Ä–æ—Å"""
        now = time.time()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if ip_address in self.blocked_ips:
            if now < self.blocked_ips[ip_address]:
                return False
            else:
                del self.blocked_ips[ip_address]
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        window_start = now - SecurityConfig.RATE_LIMIT_WINDOW
        requests = self.requests[ip_address]
        
        while requests and requests[0] < window_start:
            requests.popleft()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
        if len(requests) >= SecurityConfig.RATE_LIMIT_REQUESTS:
            # –ë–ª–æ–∫–∏—Ä—É–µ–º IP
            self.blocked_ips[ip_address] = now + SecurityConfig.LOCKOUT_DURATION
            return False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ burst –ª–∏–º–∏—Ç–∞
        burst_window = now - 60  # –ø–æ—Å–ª–µ–¥–Ω—è—è –º–∏–Ω—É—Ç–∞
        recent_requests = sum(1 for req_time in requests if req_time > burst_window)
        
        if recent_requests >= SecurityConfig.RATE_LIMIT_BURST:
            return False
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        requests.append(now)
        return True
    
    def get_retry_after(self, ip_address: str) -> Optional[int]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"""
        if ip_address in self.blocked_ips:
            return int(self.blocked_ips[ip_address] - time.time())
        return None

class InputValidator:
    """–í–∞–ª–∏–¥–∞—Ç–æ—Ä –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
    
    @staticmethod
    def sanitize_html(text: str) -> str:
        """–û—á–∏—Å—Ç–∫–∞ HTML"""
        return html.escape(text)
    
    @staticmethod
    def validate_email(email: str) -> bool:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è email"""
        pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}
        return re.match(pattern, email) is not None
    
    @staticmethod
    def validate_sql_injection(text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ SQL –∏–Ω—ä–µ–∫—Ü–∏–∏"""
        dangerous_patterns = [
            r'(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC)\b)',
            r'(\bUNION\b.*\bSELECT\b)',
            r'(\b(OR|AND)\b.*[\'"].*[\'"])',
            r'[\'"];.*--',
            r'(\bSCRIPT\b)',
        ]
        
        text_upper = text.upper()
        for pattern in dangerous_patterns:
            if re.search(pattern, text_upper, re.IGNORECASE):
                return False
        return True
    
    @staticmethod
    def validate_xss(text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ XSS"""
        dangerous_patterns = [
            r'<script[^>]*>.*?</script>',
            r'javascript:',
            r'on\w+\s*=',
            r'<iframe[^>]*>',
            r'<object[^>]*>',
            r'<embed[^>]*>',
        ]
        
        for pattern in dangerous_patterns:
            if re.search(pattern, text, re.IGNORECASE):
                return False
        return True
    
    @staticmethod
    def validate_file_upload(filename: str, content: bytes) -> tuple[bool, str]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        file_extension = '.' + filename.split('.')[-1].lower()
        if file_extension not in SecurityConfig.ALLOWED_FILE_TYPES:
            return False, f"File type {file_extension} not allowed"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
        if len(content) > SecurityConfig.MAX_REQUEST_SIZE:
            return False, "File too large"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ magic bytes –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        if file_extension in {'.jpg', '.jpeg', '.png', '.gif'}:
            magic_bytes = {
                '.jpg': [b'\xff\xd8\xff'],
                '.jpeg': [b'\xff\xd8\xff'],
                '.png': [b'\x89\x50\x4e\x47'],
                '.gif': [b'\x47\x49\x46\x38']
            }
            
            file_magic = magic_bytes.get(file_extension, [])
            if not any(content.startswith(magic) for magic in file_magic):
                return False, "Invalid file format"
        
        return True, "File is valid"

class LoginAttemptTracker:
    """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞"""
    
    def __init__(self):
        self.attempts = defaultdict(list)  # email -> —Å–ø–∏—Å–æ–∫ –ø–æ–ø—ã—Ç–æ–∫
        self.locked_accounts = {}  # email -> –≤—Ä–µ–º—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    
    def record_attempt(self, email: str, success: bool) -> bool:
        """–ó–∞–ø–∏—Å—å –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞"""
        now = datetime.utcnow()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        if email in self.locked_accounts:
            if now < self.locked_accounts[email]:
                return False  # –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
            else:
                del self.locked_accounts[email]
                self.attempts[email] = []
        
        if success:
            # –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ - –æ—á–∏—â–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏
            self.attempts[email] = []
            return True
        else:
            # –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
            self.attempts[email].append(now)
            
            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (—Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
            hour_ago = now - timedelta(hours=1)
            self.attempts[email] = [
                attempt for attempt in self.attempts[email] 
                if attempt > hour_ago
            ]
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            if len(self.attempts[email]) >= SecurityConfig.MAX_LOGIN_ATTEMPTS:
                self.locked_accounts[email] = now + timedelta(
                    seconds=SecurityConfig.LOCKOUT_DURATION
                )
                return False
            
            return True
    
    def is_locked(self, email: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞"""
        if email in self.locked_accounts:
            return datetime.utcnow() < self.locked_accounts[email]
        return False
    
    def get_remaining_attempts(self, email: str) -> int:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–æ–ø—ã—Ç–æ–∫"""
        if self.is_locked(email):
            return 0
        
        return max(0, SecurityConfig.MAX_LOGIN_ATTEMPTS - len(self.attempts[email]))

class SecurityMiddleware(BaseHTTPMiddleware):
    """Middleware –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    
    def __init__(self, app):
        super().__init__(app)
        self.rate_limiter = RateLimiter()
        self.input_validator = InputValidator()
    
    async def dispatch(self, request: Request, call_next):
        # –ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞
        ip_address = self.get_client_ip(request)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ rate limiting
        if not self.rate_limiter.is_allowed(ip_address):
            retry_after = self.rate_limiter.get_retry_after(ip_address)
            return JSONResponse(
                status_code=429,
                content={"detail": "Too many requests"},
                headers={"Retry-After": str(retry_after)} if retry_after else {}
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞
        content_length = request.headers.get("content-length")
        if content_length and int(content_length) > SecurityConfig.MAX_REQUEST_SIZE:
            return JSONResponse(
                status_code=413,
                content={"detail": "Request too large"}
            )
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ security headers
        response = await call_next(request)
        self.add_security_headers(response)
        
        return response
    
    def get_client_ip(self, request: Request) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏
        forwarded_for = request.headers.get("X-Forwarded-For")
        if forwarded_for:
            return forwarded_for.split(",")[0].strip()
        
        real_ip = request.headers.get("X-Real-IP")
        if real_ip:
            return real_ip
        
        return request.client.host
    
    def add_security_headers(self, response):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["X-XSS-Protection"] = "1; mode=block"
        response.headers["Strict-Transport-Security"] = "max-age=31536000; includeSubDomains"
        response.headers["Content-Security-Policy"] = "default-src 'self'"
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"

class SecureAuthService(AuthService):
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    
    def __init__(self, user_service, jwt_manager: JWTManager = None):
        super().__init__(user_service, jwt_manager)
        self.login_tracker = LoginAttemptTracker()
        self.input_validator = InputValidator()
    
    def authenticate_user(self, email: str, password: str, ip_address: str = None) -> Dict[str, Any]:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"""
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not self.input_validator.validate_email(email):
            raise AuthenticationError("Invalid email format")
        
        if not self.input_validator.validate_sql_injection(email):
            raise AuthenticationError("Invalid input")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
        if self.login_tracker.is_locked(email):
            remaining_attempts = self.login_tracker.get_remaining_attempts(email)
            raise AuthenticationError(
                f"Account locked due to too many failed attempts. "
                f"Remaining attempts: {remaining_attempts}"
            )
        
        try:
            # –ü–æ–ø—ã—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            result = super().authenticate_user(email, password)
            
            # –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
            self.login_tracker.record_attempt(email, success=True)
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
            self._log_security_event("LOGIN_SUCCESS", {
                "email": email,
                "ip_address": ip_address,
                "timestamp": datetime.utcnow()
            })
            
            return result
            
        except AuthenticationError as e:
            # –ó–∞–ø–∏—Å—å –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
            self.login_tracker.record_attempt(email, success=False)
            
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
            self._log_security_event("LOGIN_FAILED", {
                "email": email,
                "ip_address": ip_address,
                "error": str(e),
                "remaining_attempts": self.login_tracker.get_remaining_attempts(email),
                "timestamp": datetime.utcnow()
            })
            
            raise e
    
    def register_user(self, email: str, password: str, name: str, **kwargs) -> Dict[str, Any]:
        """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"""
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not self.input_validator.validate_email(email):
            raise AuthenticationError("Invalid email format")
        
        if not self.input_validator.validate_sql_injection(email):
            raise AuthenticationError("Invalid email")
        
        if not self.input_validator.validate_xss(name):
            raise AuthenticationError("Invalid name")
        
        # –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –æ—Ç HTML
        name = self.input_validator.sanitize_html(name)
        
        # –£—Å–∏–ª–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
        self._validate_strong_password(password)
        
        result = super().register_user(email, password, name, **kwargs)
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        self._log_security_event("USER_REGISTERED", {
            "email": email,
            "name": name,
            "timestamp": datetime.utcnow()
        })
        
        return result
    
    def _validate_strong_password(self, password: str):
        """–£—Å–∏–ª–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è"""
        errors = []
        
        if len(password) < SecurityConfig.MIN_PASSWORD_LENGTH:
            errors.append(f"Password must be at least {SecurityConfig.MIN_PASSWORD_LENGTH} characters")
        
        if SecurityConfig.REQUIRE_UPPERCASE and not any(c.isupper() for c in password):
            errors.append("Password must contain at least one uppercase letter")
        
        if SecurityConfig.REQUIRE_LOWERCASE and not any(c.islower() for c in password):
            errors.append("Password must contain at least one lowercase letter")
        
        if SecurityConfig.REQUIRE_DIGITS and not any(c.isdigit() for c in password):
            errors.append("Password must contain at least one digit")
        
        if SecurityConfig.REQUIRE_SPECIAL_CHARS and not any(c in "!@#$%^&*()_+-=[]{}|;:,.<>?" for c in password):
            errors.append("Password must contain at least one special character")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±—â–∏–µ –ø–∞—Ä–æ–ª–∏
        common_passwords = {
            "password", "123456", "12345678", "qwerty", "abc123",
            "password123", "admin", "letmein", "welcome", "monkey"
        }
        
        if password.lower() in common_passwords:
            errors.append("Password is too common")
        
        if errors:
            raise AuthenticationError("; ".join(errors))
    
    def _log_security_event(self, event_type: str, details: Dict[str, Any]):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        import json
        
        log_entry = {
            "event_type": event_type,
            "details": details,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        # –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤ SIEM —Å–∏—Å—Ç–µ–º—É
        print(f"SECURITY_LOG: {json.dumps(log_entry)}")

# HTTPS –∏ TLS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
class HTTPSConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è HTTPS"""
    
    @staticmethod
    def get_ssl_config():
        """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SSL –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞"""
        return {
            "ssl_keyfile": "/path/to/private.key",
            "ssl_certfile": "/path/to/certificate.crt",
            "ssl_version": "TLSv1.2",
            "ssl_ciphers": "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS",
            "ssl_verify_mode": "CERT_REQUIRED"
        }

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
from fastapi.middleware.cors import CORSMiddleware

def setup_cors(app: FastAPI, allowed_origins: List[str] = None):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS"""
    
    if allowed_origins is None:
        # –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
        allowed_origins = [
            "https://yourdomain.com",
            "https://www.yourdomain.com"
        ]
    
    app.add_middleware(
        CORSMiddleware,
        allow_origins=allowed_origins,
        allow_credentials=True,
        allow_methods=["GET", "POST", "PUT", "DELETE"],
        allow_headers=["Authorization", "Content-Type"],
        expose_headers=["X-Total-Count"],
        max_age=86400  # 24 hours
    )

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
def demo_security_features():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    
    print("=== Security Features Demo ===\n")
    
    # Rate Limiter
    print("1. Rate Limiter:")
    rate_limiter = RateLimiter()
    
    test_ip = "192.168.1.100"
    for i in range(12):
        allowed = rate_limiter.is_allowed(test_ip)
        print(f"  Request {i+1}: {'‚úÖ Allowed' if allowed else '‚ùå Blocked'}")
        if not allowed:
            retry_after = rate_limiter.get_retry_after(test_ip)
            print(f"    Retry after: {retry_after} seconds")
            break
    
    # Input Validator
    print("\n2. Input Validation:")
    validator = InputValidator()
    
    test_inputs = [
        ("valid@email.com", "Valid email"),
        ("invalid-email", "Invalid email"),
        ("SELECT * FROM users", "SQL Injection attempt"),
        ("<script>alert('xss')</script>", "XSS attempt"),
        ("Normal text content", "Safe content")
    ]
    
    for test_input, description in test_inputs:
        email_valid = validator.validate_email(test_input)
        sql_safe = validator.validate_sql_injection(test_input)
        xss_safe = validator.validate_xss(test_input)
        
        print(f"  {description}:")
        print(f"    Email valid: {email_valid}")
        print(f"    SQL safe: {sql_safe}")
        print(f"    XSS safe: {xss_safe}")
    
    # Login Attempt Tracker
    print("\n3. Login Attempt Tracking:")
    tracker = LoginAttemptTracker()
    
    test_email = "test@example.com"
    for i in range(7):
        success = i == 6  # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —É—Å–ø–µ—à–Ω–∞—è
        allowed = tracker.record_attempt(test_email, success)
        remaining = tracker.get_remaining_attempts(test_email)
        
        print(f"  Attempt {i+1}: {'Success' if success else 'Failed'}")
        print(f"    Allowed: {allowed}")
        print(f"    Remaining attempts: {remaining}")
        
        if tracker.is_locked(test_email):
            print(f"    Account locked!")
            break

if __name__ == "__main__":
    demo_security_features()
```

### OAuth 2.0 –∏ –≤–Ω–µ—à–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google OAuth

```python
# oauth.py
from fastapi import FastAPI, HTTPException, Depends, Request
from fastapi.responses import RedirectResponse
import httpx
import jwt
from typing import Dict, Optional
import secrets
from urllib.parse import urlencode

class OAuthConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤"""
    
    # Google OAuth
    GOOGLE_CLIENT_ID = "your-google-client-id"
    GOOGLE_CLIENT_SECRET = "your-google-client-secret"
    GOOGLE_REDIRECT_URI = "http://localhost:8000/auth/google/callback"
    GOOGLE_SCOPE = "openid email profile"
    
    # GitHub OAuth
    GITHUB_CLIENT_ID = "your-github-client-id"
    GITHUB_CLIENT_SECRET = "your-github-client-secret"
    GITHUB_REDIRECT_URI = "http://localhost:8000/auth/github/callback"
    GITHUB_SCOPE = "user:email"

class OAuthProvider:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤"""
    
    def __init__(self, client_id: str, client_secret: str, redirect_uri: str):
        self.client_id = client_id
        self.client_secret = client_secret
        self.redirect_uri = redirect_uri
        self.state_storage = {}  # –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Redis
    
    def generate_state(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è state –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç CSRF"""
        state = secrets.token_urlsafe(32)
        self.state_storage[state] = True
        return state
    
    def verify_state(self, state: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ state"""
        return self.state_storage.pop(state, False)
    
    def get_authorization_url(self) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
        raise NotImplementedError
    
    async def exchange_code_for_token(self, code: str, state: str) -> Dict:
        """–û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω"""
        raise NotImplementedError
    
    async def get_user_info(self, access_token: str) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        raise NotImplementedError

class GoogleOAuthProvider(OAuthProvider):
    """Google OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä"""
    
    def __init__(self):
        super().__init__(
            OAuthConfig.GOOGLE_CLIENT_ID,
            OAuthConfig.GOOGLE_CLIENT_SECRET,
            OAuthConfig.GOOGLE_REDIRECT_URI
        )
        self.auth_url = "https://accounts.google.com/o/oauth2/v2/auth"
        self.token_url = "https://oauth2.googleapis.com/token"
        self.user_info_url = "https://www.googleapis.com/oauth2/v2/userinfo"
    
    def get_authorization_url(self) -> str:
        """URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Google"""
        state = self.generate_state()
        
        params = {
            "client_id": self.client_id,
            "redirect_uri": self.redirect_uri,
            "scope": OAuthConfig.GOOGLE_SCOPE,
            "response_type": "code",
            "state": state,
            "access_type": "offline",  # –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è refresh token
            "prompt": "consent"
        }
        
        return f"{self.auth_url}?{urlencode(params)}"
    
    async def exchange_code_for_token(self, code: str, state: str) -> Dict:
        """–û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω Google"""
        if not self.verify_state(state):
            raise HTTPException(status_code=400, detail="Invalid state parameter")
        
        token_data = {
            "client_id": self.client_id,
            "client_secret": self.client_secret,
            "code": code,
            "grant_type": "authorization_code",
            "redirect_uri": self.redirect_uri
        }
        
        async with httpx.AsyncClient() as client:
            response = await client.post(self.token_url, data=token_data)
            
            if response.status_code != 200:
                raise HTTPException(status_code=400, detail="Failed to exchange code for token")
            
            return response.json()
    
    async def get_user_info(self, access_token: str) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ Google"""
        headers = {"Authorization": f"Bearer {access_token}"}
        
        async with httpx.AsyncClient() as client:
            response = await client.get(self.user_info_url, headers=headers)
            
            if response.status_code != 200:
                raise HTTPException(status_code=400, detail="Failed to get user info")
            
            return response.json()

class GitHubOAuthProvider(OAuthProvider):
    """GitHub OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä"""
    
    def __init__(self):
        super().__init__(
            OAuthConfig.GITHUB_CLIENT_ID,
            OAuthConfig.GITHUB_CLIENT_SECRET,
            OAuthConfig.GITHUB_REDIRECT_URI
        )
        self.auth_url = "https://github.com/login/oauth/authorize"
        self.token_url = "https://github.com/login/oauth/access_token"
        self.user_info_url = "https://api.github.com/user"
        self.user_emails_url = "https://api.github.com/user/emails"
    
    def get_authorization_url(self) -> str:
        """URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ GitHub"""
        state = self.generate_state()
        
        params = {
            "client_id": self.client_id,
            "redirect_uri": self.redirect_uri,
            "scope": OAuthConfig.GITHUB_SCOPE,
            "state": state
        }
        
        return f"{self.auth_url}?{urlencode(params)}"
    
    async def exchange_code_for_token(self, code: str, state: str) -> Dict:
        """–û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω GitHub"""
        if not self.verify_state(state):
            raise HTTPException(status_code=400, detail="Invalid state parameter")
        
        token_data = {
            "client_id": self.client_id,
            "client_secret": self.client_secret,
            "code": code
        }
        
        headers = {"Accept": "application/json"}
        
        async with httpx.AsyncClient() as client:
            response = await client.post(self.token_url, data=token_data, headers=headers)
            
            if response.status_code != 200:
                raise HTTPException(status_code=400, detail="Failed to exchange code for token")
            
            return response.json()
    
    async def get_user_info(self, access_token: str) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ GitHub"""
        headers = {"Authorization": f"token {access_token}"}
        
        async with httpx.AsyncClient() as client:
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            user_response = await client.get(self.user_info_url, headers=headers)
            if user_response.status_code != 200:
                raise HTTPException(status_code=400, detail="Failed to get user info")
            
            user_data = user_response.json()
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ email (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º)
            emails_response = await client.get(self.user_emails_url, headers=headers)
            if emails_response.status_code == 200:
                emails = emails_response.json()
                primary_email = next((email["email"] for email in emails if email["primary"]), None)
                if primary_email:
                    user_data["email"] = primary_email
            
            return user_data

class OAuthService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OAuth"""
    
    def __init__(self, user_service, auth_service):
        self.user_service = user_service
        self.auth_service = auth_service
        self.google_provider = GoogleOAuthProvider()
        self.github_provider = GitHubOAuthProvider()
    
    async def authenticate_with_google(self, code: str, state: str) -> Dict:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google"""
        # –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
        token_data = await self.google_provider.exchange_code_for_token(code, state)
        access_token = token_data["access_token"]
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = await self.google_provider.get_user_info(access_token)
        
        # –ü–æ–∏—Å–∫ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = await self._find_or_create_user(
            email=user_info["email"],
            name=user_info["name"],
            provider="google",
            provider_id=user_info["id"],
            avatar_url=user_info.get("picture")
        )
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤
        return self._generate_tokens(user)
    
    async def authenticate_with_github(self, code: str, state: str) -> Dict:
        """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ GitHub"""
        # –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω
        token_data = await self.github_provider.exchange_code_for_token(code, state)
        access_token = token_data["access_token"]
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_info = await self.github_provider.get_user_info(access_token)
        
        # –ü–æ–∏—Å–∫ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = await self._find_or_create_user(
            email=user_info.get("email"),
            name=user_info.get("name") or user_info["login"],
            provider="github",
            provider_id=str(user_info["id"]),
            avatar_url=user_info.get("avatar_url")
        )
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤
        return self._generate_tokens(user)
    
    async def _find_or_create_user(self, email: str, name: str, provider: str, 
                                 provider_id: str, avatar_url: str = None) -> User:
        """–ü–æ–∏—Å–∫ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è OAuth"""
        
        # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
        user = self.user_service.get_by_email(email)
        
        if user:
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ OAuth
            self.user_service.update_oauth_info(
                user.id,
                provider=provider,
                provider_id=provider_id,
                avatar_url=avatar_url
            )
            return user
        else:
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            return self.user_service.create_oauth_user(
                email=email,
                name=name,
                provider=provider,
                provider_id=provider_id,
                avatar_url=avatar_url
            )
    
    def _generate_tokens(self, user: User) -> Dict:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤"""
        token_data = {
            "user_id": user.id,
            "email": user.email,
            "roles": [role.name for role in user.roles]
        }
        
        access_token = self.auth_service.jwt_manager.create_access_token(token_data)
        refresh_token = self.auth_service.jwt_manager.create_refresh_token(token_data)
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer",
            "user": user
        }

# OAuth —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
app = FastAPI()

@app.get("/auth/google")
async def google_auth():
    """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ Google OAuth"""
    google_provider = GoogleOAuthProvider()
    auth_url = google_provider.get_authorization_url()
    return RedirectResponse(url=auth_url)

@app.get("/auth/google/callback")
async def google_callback(
    code: str,
    state: str,
    oauth_service: OAuthService = Depends(get_oauth_service)
):
    """Callback –¥–ª—è Google OAuth"""
    try:
        result = await oauth_service.authenticate_with_google(code, state)
        
        # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å —Ç–æ–∫–µ–Ω–∞–º–∏
        return {
            "message": "Authentication successful",
            "access_token": result["access_token"],
            "refresh_token": result["refresh_token"]
        }
        
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

@app.get("/auth/github")
async def github_auth():
    """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ GitHub OAuth"""
    github_provider = GitHubOAuthProvider()
    auth_url = github_provider.get_authorization_url()
    return RedirectResponse(url=auth_url)

@app.get("/auth/github/callback")
async def github_callback(
    code: str,
    state: str,
    oauth_service: OAuthService = Depends(get_oauth_service)
):
    """Callback –¥–ª—è GitHub OAuth"""
    try:
        result = await oauth_service.authenticate_with_github(code, state)
        
        return {
            "message": "Authentication successful",
            "access_token": result["access_token"],
            "refresh_token": result["refresh_token"]
        }
        
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è OAuth
class OAuthUser(User):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å OAuth –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""
    
    oauth_provider = Column(String(50), nullable=True)
    oauth_provider_id = Column(String(100), nullable=True)
    avatar_url = Column(String(500), nullable=True)
    is_oauth_user = Column(Boolean, default=False)
    
    __table_args__ = (
        Index('idx_oauth_provider', 'oauth_provider', 'oauth_provider_id', unique=True),
    )

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è OAuth
def demo_oauth_flow():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è OAuth –ø–æ—Ç–æ–∫–∞"""
    print("=== OAuth Flow Demo ===\n")
    
    # Google OAuth
    print("1. Google OAuth URL generation:")
    google_provider = GoogleOAuthProvider()
    google_url = google_provider.get_authorization_url()
    print(f"Google Auth URL: {google_url}\n")
    
    # GitHub OAuth
    print("2. GitHub OAuth URL generation:")
    github_provider = GitHubOAuthProvider()
    github_url = github_provider.get_authorization_url()
    print(f"GitHub Auth URL: {github_url}\n")
    
    print("3. OAuth Flow Steps:")
    print("   1. User clicks on OAuth login button")
    print("   2. User redirected to provider (Google/GitHub)")
    print("   3. User authorizes application")
    print("   4. Provider redirects back with authorization code")
    print("   5. Backend exchanges code for access token")
    print("   6. Backend fetches user info from provider")
    print("   7. Backend creates/updates user in database")
    print("   8. Backend generates JWT tokens")
    print("   9. User is logged in")

if __name__ == "__main__":
    demo_oauth_flow()
```

---

## üöÄ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π API –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤—Å–µ—Ö –∏–∑—É—á–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π:

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–µ–∫—Ç—É:

1. **FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
2. **SQLAlchemy ORM** —Å PostgreSQL
3. **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å —Ä–æ–ª—è–º–∏
4. **CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–∞–¥–∞—á
5. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** —Å Pydantic
6. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: rate limiting, input validation
7. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å pytest
8. **Docker** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
- Users (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- Tasks (–∑–∞–¥–∞—á–∏) 
- Categories (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
- Comments (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–¥–∞—á–∞–º)

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
```
POST /auth/register     - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
POST /auth/login        - –í—Ö–æ–¥
GET  /users/me          - –ü—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET  /tasks             - –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
POST /tasks             - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
PUT  /tasks/{id}        - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
DELETE /tasks/{id}      - –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
POST /tasks/{id}/comments - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
```

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å—Ç–∞–Ω–µ—Ç –æ—Å–Ω–æ–≤–æ–π –≤–∞—à–µ–≥–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∏ –ø–æ–∫–∞–∂–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ Python!

---

## üìö –ß—Ç–æ –¥–∞–ª—å—à–µ?

–í —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∞–∑–µ –º—ã –∏–∑—É—á–∏–º:
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å async/await
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å Redis
- **–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏** —Å Celery
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** API
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã! üéØ